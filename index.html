<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Maya Groom Pro</title>
<style>
  :root{
    --bg:#0e0c0b;
    --panel:#1a1512;
    --panel2:#221b17;
    --text:#f3ede6;
    --muted:#cbbfb5;
    --accent:#e0844b;
    --accent2:#b86b3b;
    --line:rgba(255,255,255,.08);
    --danger:#ff5b5b;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    background:linear-gradient(180deg,#0b0908 0%,#0f0c0a 50%,#0b0908 100%);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    padding-top:env(safe-area-inset-top);
    padding-bottom:calc(84px + env(safe-area-inset-bottom));
  }
  .topbar{
    position:sticky; top:0; z-index:10;
    padding:14px 14px 10px 14px;
    background:rgba(10,8,7,.86);
    backdrop-filter: blur(14px);
    border-bottom:1px solid var(--line);
  }
  .toprow{display:flex;gap:12px;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{
    width:34px;height:34px;border-radius:10px;
    background:radial-gradient(circle at 30% 30%, #ffb07a 0%, #e0844b 35%, #6d3a1f 100%);
    display:grid;place-items:center;
    box-shadow:0 8px 20px rgba(0,0,0,.35);
  }
  .logo span{font-size:18px}
  .brand h1{margin:0;font-size:18px;letter-spacing:.2px}
  .cloud{
    font-size:12px; color:var(--muted);
    line-height:1.25;
  }
  .actions{display:flex;gap:10px;align-items:center}
  .btn{
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
    color:var(--text);
    padding:10px 14px;border-radius:14px;
    font-weight:600;
    cursor:pointer;
    -webkit-tap-highlight-color:transparent;
  }
  .btn:active{transform:scale(.98)}
  .btn.primary{
    background:linear-gradient(180deg,var(--accent) 0%, var(--accent2) 100%);
    border:0;
  }
  .iconbtn{
    width:42px;height:42px;border-radius:14px;
    display:grid;place-items:center;
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
    cursor:pointer;
  }
  .iconbtn svg{width:20px;height:20px;fill:var(--text);opacity:.92}
  .wrap{max-width:980px;margin:0 auto;padding:14px}
  .card{
    background:rgba(255,255,255,.04);
    border:1px solid var(--line);
    border-radius:18px;
    padding:14px;
    box-shadow:0 18px 45px rgba(0,0,0,.35);
  }
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .pill{
    display:inline-flex;gap:8px;align-items:center;
    padding:10px 12px;border-radius:16px;
    background:rgba(255,255,255,.05);
    border:1px solid var(--line);
    color:var(--muted); font-size:13px;
  }
  .pill strong{color:var(--text)}
  .grow{flex:1}
  .calendarHead{
    display:flex;align-items:center;justify-content:space-between;
    padding:8px 0 10px 0;
  }
  .month{font-size:20px;font-weight:800}
  .navbtn{
    width:38px;height:38px;border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
    display:grid;place-items:center;
    cursor:pointer;
  }
  .navbtn:active{transform:scale(.98)}
  .navbtn svg{width:18px;height:18px;fill:var(--text);opacity:.9}
  .daystrip{
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:8px;
    margin-top:8px;
  }
  .day{
    padding:10px 8px;border-radius:16px;
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
    text-align:center;
    cursor:pointer;
    font-weight:650;
  }
  .day small{display:block;color:var(--muted);font-weight:600;margin-top:2px}
  .day.active{background:rgba(224,132,75,.2);border-color:rgba(224,132,75,.45)}
  .controls{
    display:flex;gap:10px;align-items:center;justify-content:space-between;
    margin-top:12px;
  }
  .seg{
    display:flex;gap:10px;align-items:center;
  }
  .zoom{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:13px}
  .zoom .iconbtn{width:36px;height:36px;border-radius:12px}
  .timeline{
    margin-top:12px;
    border-top:1px solid var(--line);
    padding-top:12px;
  }
  .slot{
    display:flex;gap:12px;
    padding:10px 0;
    border-bottom:1px solid rgba(255,255,255,.05);
    align-items:flex-start;
  }
  .time{
    width:62px;color:var(--muted);font-weight:700;font-size:13px;flex:0 0 auto;
  }
  .appt{
    flex:1;
    border-radius:18px;
    background:rgba(66,114,255,.12);
    border:1px solid rgba(66,114,255,.25);
    padding:12px 12px;
    cursor:pointer;
  }
  .appt .title{font-weight:900;font-size:16px}
  .appt .meta{margin-top:3px;color:rgba(243,237,230,.85);font-size:13px}
  .appt .meta .pet{opacity:.85}
  .muted{color:var(--muted)}
  .toast{
    position:fixed; left:50%; bottom:92px; transform:translateX(-50%);
    background:rgba(0,0,0,.78);
    border:1px solid rgba(255,255,255,.12);
    color:var(--text);
    padding:12px 14px;border-radius:18px;
    max-width:min(94vw,520px);
    box-shadow:0 20px 50px rgba(0,0,0,.55);
    display:none;
    z-index:30;
  }
  .toast.show{display:block}
  .toast.danger{border-color:rgba(255,91,91,.35)}
  /* Bottom nav */
  .bottom{
    position:fixed; left:0; right:0; bottom:0; z-index:20;
    background:rgba(10,8,7,.86);
    backdrop-filter: blur(14px);
    border-top:1px solid var(--line);
    padding:10px 14px calc(10px + env(safe-area-inset-bottom)) 14px;
  }
  .tabs{max-width:980px;margin:0 auto;display:flex;justify-content:space-between;gap:10px}
  .tab{
    flex:1;
    padding:10px 8px;
    border-radius:16px;
    text-align:center;
    color:var(--muted);
    font-weight:800;
    border:1px solid transparent;
    cursor:pointer;
  }
  .tab.active{
    color:var(--accent);
    background:rgba(224,132,75,.15);
    border-color:rgba(224,132,75,.25);
  }
  /* Modal */
  .overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    display:none; z-index:40;
    padding:calc(12px + env(safe-area-inset-top)) 12px calc(12px + env(safe-area-inset-bottom)) 12px;
  }
  .overlay.show{display:block}
  .modal{
    max-width:720px;margin:0 auto;
    background:rgba(26,21,18,.96);
    border:1px solid rgba(255,255,255,.12);
    border-radius:26px;
    box-shadow:0 30px 80px rgba(0,0,0,.7);
    overflow:hidden;
  }
  .modalHead{
    display:flex;align-items:center;justify-content:space-between;
    padding:16px 16px;
    border-bottom:1px solid var(--line);
  }
  .modalHead h2{margin:0;font-size:20px}
  .closeX{
    width:44px;height:44px;border-radius:18px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);
    display:grid;place-items:center;
    cursor:pointer;
  }
  .closeX svg{width:18px;height:18px;fill:var(--text)}
  .modalBody{padding:16px}
  label{display:block;color:var(--muted);font-size:13px;margin:10px 0 6px}
  input,select,textarea{
    width:100%;
    padding:12px 12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    color:var(--text);
    outline:none;
  }
  textarea{min-height:90px;resize:vertical}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
  .sectionTitle{font-weight:900;margin:6px 0 10px}
  .serviceRow{
    display:flex;align-items:center;justify-content:space-between;
    gap:12px;
    padding:10px 10px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.04);
    margin-bottom:10px;
  }
  .serviceRow .left{display:flex;gap:10px;align-items:center}
  .serviceRow input[type="checkbox"]{width:22px;height:22px}
  .badge{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 10px;border-radius:999px;
    font-weight:900;font-size:12px;
    background:rgba(224,132,75,.18);
    border:1px solid rgba(224,132,75,.25);
    color:var(--accent);
  }
  .dangerText{color:var(--danger);font-weight:800}
  .small{font-size:12px;color:var(--muted)}
  .link{color:var(--accent);text-decoration:underline;cursor:pointer}
</style>
</head>
<body>
  <div class="topbar">
    <div class="toprow">
      <div class="brand">
        <div class="logo" aria-hidden="true"><span>üêæ</span></div>
        <div>
          <h1>Maya Groom Pro</h1>
          <div class="cloud" id="cloudLine">Cloud: <span id="cloudStatus">Not synced</span><br/>Last backup: <span id="lastBackup">‚Äî</span></div>
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" id="syncBtn">Sync</button>
        <button class="iconbtn" id="uploadBtn" title="Backup / Export" aria-label="Backup / Export">
          <svg viewBox="0 0 24 24"><path d="M12 3l4 4h-3v7h-2V7H8l4-4zm-7 14h14v2H5v-2z"/></svg>
        </button>
        <button class="iconbtn" id="settingsBtn" title="Settings" aria-label="Settings">
          <svg viewBox="0 0 24 24"><path d="M19.14,12.94a7.43,7.43,0,0,0,.05-.94,7.43,7.43,0,0,0-.05-.94l2.11-1.65a.5.5,0,0,0,.12-.63l-2-3.46a.5.5,0,0,0-.6-.22l-2.49,1a7.1,7.1,0,0,0-1.63-.94l-.38-2.65A.5.5,0,0,0,11.8,1H8.2a.5.5,0,0,0-.49.42L7.33,4.07a7.1,7.1,0,0,0-1.63.94l-2.49-1a.5.5,0,0,0-.6.22l-2,3.46a.5.5,0,0,0,.12.63L2.86,11.06a7.43,7.43,0,0,0-.05.94,7.43,7.43,0,0,0,.05.94L.75,14.59a.5.5,0,0,0-.12.63l2,3.46a.5.5,0,0,0,.6.22l2.49-1a7.1,7.1,0,0,0,1.63.94l.38,2.65A.5.5,0,0,0,8.2,23h3.6a.5.5,0,0,0,.49-.42l.38-2.65a7.1,7.1,0,0,0,1.63-.94l2.49,1a.5.5,0,0,0,.6-.22l2-3.46a.5.5,0,0,0-.12-.63ZM10,15.5A3.5,3.5,0,1,1,13.5,12,3.5,3.5,0,0,1,10,15.5Z"/></svg>
        </button>
        <button class="iconbtn" id="themeBtn" title="Toggle Theme" aria-label="Toggle Theme">
          <svg viewBox="0 0 24 24"><path d="M12 2a1 1 0 0 1 1 1v1a1 1 0 0 1-2 0V3a1 1 0 0 1 1-1Zm0 18a1 1 0 0 1 1 1v1a1 1 0 0 1-2 0v-1a1 1 0 0 1 1-1ZM4.22 5.64a1 1 0 0 1 1.41 0l.7.7a1 1 0 0 1-1.41 1.41l-.7-.7a1 1 0 0 1 0-1.41Zm13.45 13.45a1 1 0 0 1 1.41 0l.7.7a1 1 0 0 1-1.41 1.41l-.7-.7a1 1 0 0 1 0-1.41ZM2 12a1 1 0 0 1 1-1h1a1 1 0 0 1 0 2H3a1 1 0 0 1-1-1Zm18 0a1 1 0 0 1 1-1h1a1 1 0 0 1 0 2h-1a1 1 0 0 1-1-1ZM4.22 18.36a1 1 0 0 1 0-1.41l.7-.7a1 1 0 1 1 1.41 1.41l-.7.7a1 1 0 0 1-1.41 0ZM17.67 4.91a1 1 0 0 1 0-1.41l.7-.7a1 1 0 1 1 1.41 1.41l-.7.7a1 1 0 0 1-1.41 0ZM12 6a6 6 0 1 0 0 12A6 6 0 0 0 12 6Z"/></svg>
        </button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="screen-schedule" class="screen">
      <div class="card">
        <div class="calendarHead">
          <div class="month" id="monthLabel">December 2025</div>
          <div class="row" style="gap:10px">
            <button class="navbtn" id="prevMonth" aria-label="Previous month">
              <svg viewBox="0 0 24 24"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            </button>
            <button class="navbtn" id="nextMonth" aria-label="Next month">
              <svg viewBox="0 0 24 24"><path d="M8.59 16.59 10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>
            </button>
            <button class="btn" id="addApptBtn">+ Appointment</button>
          </div>
        </div>

        <div class="daystrip" id="dayStrip"></div>

        <div class="controls">
          <div class="seg">
            <span class="pill"><strong id="filterLabel">All</strong></span>
            <button class="btn" id="todayBtn">Today</button>
          </div>
          <div class="zoom">
            <button class="iconbtn" id="zoomOut" aria-label="Zoom out"><svg viewBox="0 0 24 24"><path d="M19 13H5v-2h14v2z"/></svg></button>
            <span id="zoomLabel">100%</span>
            <button class="iconbtn" id="zoomIn" aria-label="Zoom in"><svg viewBox="0 0 24 24"><path d="M19 13H13v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></button>
          </div>
        </div>

        <div class="timeline" id="timeline"></div>
      </div>
    </div>

    <div id="screen-clients" class="screen" style="display:none">
      <div class="card">
        <div class="row">
          <div class="grow">
            <div class="sectionTitle">Clients</div>
            <div class="small">Tap a client to view / edit. Add pets under the client.</div>
          </div>
          <button class="btn primary" id="addClientBtn">+ Client</button>
        </div>
        <div class="hr"></div>
        <div id="clientsList"></div>
      </div>
    </div>

    <div id="screen-services" class="screen" style="display:none">
      <div class="card">
        <div class="row">
          <div class="grow">
            <div class="sectionTitle">Services</div>
            <div class="small">These appear when creating/editing an appointment.</div>
          </div>
          <button class="btn primary" id="addServiceBtn">+ Service</button>
        </div>
        <div class="hr"></div>
        <div id="servicesList"></div>
      </div>
    </div>

    <div id="screen-waitlist" class="screen" style="display:none">
      <div class="card">
        <div class="sectionTitle">Waitlist</div>
        <div class="small">Simple placeholder (we can build it out next).</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="bottom">
    <div class="tabs">
      <div class="tab active" data-tab="schedule">Schedule</div>
      <div class="tab" data-tab="clients">Clients</div>
      <div class="tab" data-tab="services">Services</div>
      <div class="tab" data-tab="waitlist">Waitlist</div>
    </div>
  </div>

  <!-- Appointment Details Modal -->
  <div class="overlay" id="detailsOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <h2>Appointment Details</h2>
        <button class="closeX" id="closeDetails" aria-label="Close">
          <svg viewBox="0 0 24 24"><path d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L10.59 13.4 4.29 19.71 2.88 18.29 9.18 12 2.88 5.71 4.29 4.29l6.3 6.31 6.3-6.31z"/></svg>
        </button>
      </div>
      <div class="modalBody">
        <!-- Edit button MUST be at top -->
        <button class="btn primary" id="editFromDetailsBtn" style="width:100%;padding:14px 16px;border-radius:18px;font-size:16px;">
          ‚úé Edit Appointment
        </button>

        <div class="hr"></div>
        <div class="card" style="background:rgba(255,255,255,.03)">
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div>
              <div style="font-size:20px;font-weight:950;color:var(--accent)" id="dClient">‚Äî</div>
              <div class="row" style="gap:10px;margin-top:8px;color:var(--muted);font-weight:700">
                <span>üìÖ <span id="dDate">‚Äî</span></span>
                <span>üïí <span id="dTime">‚Äî</span></span>
              </div>
            </div>
            <div class="badge" id="dStatus">CONFIRMED</div>
          </div>

          <div style="margin-top:12px">
        <button class="btn primary full" id="btnEditTop" type="button" onclick="editFromDetails()">
          ‚úèÔ∏è Edit Appointment
        </button>
</div>

          <div style="margin-top:10px" class="small" id="dFirstTime"></div>
        </div>

        <div class="hr"></div>
        <div class="card" style="background:rgba(255,255,255,.03)">
          <div class="sectionTitle">Services &amp; Costs</div>
          <div id="dServices"></div>
          <div class="hr"></div>
          <div class="row" style="justify-content:space-between">
            <div style="font-weight:900">Total</div>
            <div style="font-weight:950;color:var(--accent);font-size:18px" id="dTotal">$0.00</div>
          </div>
        </div>

        <div class="hr"></div>
        <!-- Recurring actions -->
        <div id="recurringActions" style="display:none">
          <div class="sectionTitle">Recurring Series</div>
          <div class="small">This appointment is part of a series.</div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="onlyThisBtn" style="flex:1">Only this appointment</button>
            <button class="btn primary" id="seriesBtn" style="flex:1">Update series</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Appointment Modal -->
  <div class="overlay" id="editOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <h2 id="editTitle">Edit Appointment</h2>
        <button class="closeX" id="closeEdit" aria-label="Close">
          <svg viewBox="0 0 24 24"><path d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L10.59 13.4 4.29 19.71 2.88 18.29 9.18 12 2.88 5.71 4.29 4.29l6.3 6.31 6.3-6.31z"/></svg>
        </button>
      </div>
      <div class="modalBody">
        <label>Client</label>
        <select id="eClient"></select>

        <div class="hr"></div>
        <div class="sectionTitle">Select Pets &amp; Services</div>
        <div class="small">Pets come from the client profile. Services come from Services tab.</div>

        <div class="hr"></div>
        <div class="sectionTitle">Pets</div>
        <div id="ePets"></div>

        <div class="hr"></div>
        <div class="sectionTitle">Services</div>
        <div id="eServices"></div>

        <div class="hr"></div>
        <div class="grid2">
          <div>
            <label>Date</label>
            <input id="eDate" type="date"/>
          </div>
          <div>
            <label>Time</label>
            <input id="eTime" type="time"/>
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>Status</label>
            <select id="eStatus">
              <option value="CONFIRMED">CONFIRMED</option>
              <option value="PENDING">PENDING</option>
              <option value="CANCELLED">CANCELLED</option>
            </select>
          </div>
          <div>
            <label>First time client?</label>
            <select id="eFirstTime">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>
        <div class="sectionTitle">Recurring</div>
        <div class="grid3">
          <div>
            <label>Repeat</label>
            <select id="eRepeat">
              <option value="none">None</option>
              <option value="weekly">Weekly</option>
              <option value="fortnightly">Fortnightly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
          <div>
            <label>Occurrences</label>
            <input id="eOccur" type="number" min="2" max="52" value="6"/>
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="small">Creates a series from this appointment.</div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="row">
          <button class="btn" id="deleteApptBtn" style="flex:1;border-color:rgba(255,91,91,.35);color:var(--danger)">Delete</button>
          <button class="btn primary" id="saveApptBtn" style="flex:2">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal (Firebase config + export/import) -->
  <div class="overlay" id="settingsOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <h2>Settings</h2>
        <button class="closeX" id="closeSettings" aria-label="Close">
          <svg viewBox="0 0 24 24"><path d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L10.59 13.4 4.29 19.71 2.88 18.29 9.18 12 2.88 5.71 4.29 4.29l6.3 6.31 6.3-6.31z"/></svg>
        </button>
      </div>
      <div class="modalBody">
        <div class="sectionTitle">Cloud Sync (Firebase)</div>
        <div class="small">Optional. App works without Firebase. If you paste Firebase config, Sync will store your data in Firestore.</div>

        <label>Firebase config JSON</label>
        <textarea id="firebaseConfigInput" placeholder='{"apiKey":"...","authDomain":"...","projectId":"..."}'></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="saveFirebaseBtn">Save Firebase config</button>
          <button class="btn" id="clearFirebaseBtn">Clear</button>
        </div>

        <div class="hr"></div>
        <div class="sectionTitle">Backup / Restore</div>
        <div class="small">Export your data as a JSON file. Import restores on this device.</div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="exportBtn">Export JSON</button>
          <label class="btn" style="cursor:pointer">
            Import JSON
            <input id="importInput" type="file" accept="application/json" style="display:none"/>
          </label>
        </div>

        <div class="hr"></div>
        <div class="sectionTitle dangerText">Danger Zone</div>
        <button class="btn" id="resetBtn" style="border-color:rgba(255,91,91,.35);color:var(--danger)">Reset local data</button>
      </div>
    </div>
  </div>

<script>
/* ---------- Utilities ---------- */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const fmtMoney = (n) => {
  const v = Number(n);
  if (!isFinite(v)) return "$0.00";
  return "$" + v.toFixed(2);
};
const toISODate = (d) => {
  const pad = (x)=> String(x).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
};
const parseISODate = (s) => {
  // Safari-safe parsing: treat as local date
  const [y,m,d] = (s||"").split("-").map(Number);
  if (!y || !m || !d) return new Date();
  return new Date(y, m-1, d, 12, 0, 0, 0);
};
const monthName = (d)=> d.toLocaleString(undefined,{month:'long', year:'numeric'});
const timeLabel = (h)=> {
  const ap = h>=12 ? "PM":"AM";
  const hh = h%12===0?12:h%12;
  return `${hh} ${ap}`;
};
function showToast(msg, danger=false){
  const t = $("#toast");
  t.textContent = msg;
  t.classList.toggle("danger", danger);
  t.classList.add("show");
  clearTimeout(showToast._to);
  showToast._to = setTimeout(()=>t.classList.remove("show"), 3200);
}

/* ---------- Data Model (Local first) ---------- */
const STORAGE_KEY = "mgp_data_v1";
const CLOUD_KEY = "mgp_firebase_config_v1";
const BACKUP_KEY = "mgp_last_backup_v1";

let state = {
  clients: [],
  services: [],
  appointments: [], // each: {id, clientId, date, time, pets:[], services:[], status, firstTime, seriesId?}
};

function uid(prefix="id"){
  return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}

function seedIfEmpty(){
  if (state.clients.length || state.services.length || state.appointments.length) return;

  const c1 = {id:uid("c"), name:"Sarah Johnson", phone:"", notes:"", pets:[
    {id:uid("p"), name:"Max", breed:"Golden Retriever"}
  ]};
  const c2 = {id:uid("c"), name:"Alex Brown", phone:"", notes:"", pets:[
    {id:uid("p"), name:"Luna", breed:"Poodle"}
  ]};
  state.clients = [c1,c2];

  state.services = [
    {id:uid("s"), name:"Full Grooming", price:85},
    {id:uid("s"), name:"Bath Only", price:55},
    {id:uid("s"), name:"Nails", price:20},
  ];

  const d = new Date();
  const sample = {
    id: uid("a"),
    clientId: c1.id,
    date: toISODate(d),
    time: "10:00",
    pets: [c1.pets[0].id],
    services: [state.services[0].id],
    status: "CONFIRMED",
    firstTime: "yes",
    seriesId: null
  };
  state.appointments = [sample];
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) state = JSON.parse(raw);
  }catch(e){}
  // harden shape
  state.clients = Array.isArray(state.clients) ? state.clients : [];
  state.services = Array.isArray(state.services) ? state.services : [];
  state.appointments = Array.isArray(state.appointments) ? state.appointments : [];

  // prevent crashes like apt.pets.map
  for (const a of state.appointments){
    if (!Array.isArray(a.pets)) a.pets = [];
    if (!Array.isArray(a.services)) a.services = [];
  }
  seedIfEmpty();
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/* ---------- UI Navigation ---------- */
function showScreen(name){
  $$(".screen").forEach(s=>s.style.display="none");
  $("#screen-"+name).style.display="block";
  $$(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===name));
}
$$(".tab").forEach(t=>t.addEventListener("click", ()=>showScreen(t.dataset.tab)));

/* ---------- Schedule View ---------- */
let view = {
  currentMonth: new Date(),
  selectedDate: new Date(),
  zoom: 100,
  selectedApptId: null,
  editingApptId: null
};

function renderDayStrip(){
  const base = new Date(view.currentMonth.getFullYear(), view.currentMonth.getMonth(), 1);
  $("#monthLabel").textContent = monthName(base);

  // Show week containing selectedDate, starting Monday
  const d = new Date(view.selectedDate);
  const day = d.getDay(); // 0 Sun..6 Sat
  const mondayOffset = (day===0 ? -6 : 1-day);
  const monday = new Date(d);
  monday.setDate(d.getDate() + mondayOffset);

  const strip = $("#dayStrip");
  strip.innerHTML = "";
  for (let i=0;i<7;i++){
    const x = new Date(monday);
    x.setDate(monday.getDate()+i);
    const el = document.createElement("div");
    el.className = "day" + (toISODate(x)===toISODate(view.selectedDate) ? " active":"");
    el.innerHTML = `${x.getDate()}<small>${x.toLocaleString(undefined,{weekday:"short"})}</small>`;
    el.addEventListener("click", ()=>{
      view.selectedDate = x;
      renderAll();
    });
    strip.appendChild(el);
  }
}

function apptsForDate(isoDate){
  return state.appointments
    .filter(a=>a.date===isoDate)
    .sort((a,b)=> (a.time||"").localeCompare(b.time||""));
}

function clientName(clientId){
  return (state.clients.find(c=>c.id===clientId)?.name) || "Unknown";
}
function petLabel(clientId, petIds){
  const c = state.clients.find(x=>x.id===clientId);
  const pets = (c?.pets||[]);
  const names = (petIds||[]).map(pid => pets.find(p=>p.id===pid)?.name).filter(Boolean);
  return names.join(", ");
}
function serviceLines(serviceIds){
  const svc = state.services;
  const lines = [];
  let total = 0;
  for (const sid of (serviceIds||[])){
    const s = svc.find(x=>x.id===sid);
    if (!s) continue;
    const price = Number(s.price)||0;
    total += price;
    lines.push({name:s.name, price});
  }
  return {lines, total};
}

function renderTimeline(){
  const iso = toISODate(view.selectedDate);
  const list = apptsForDate(iso);
  const tl = $("#timeline");
  tl.innerHTML = "";

  if (!list.length){
    const empty = document.createElement("div");
    empty.className = "small muted";
    empty.style.padding = "12px 0";
    empty.textContent = "No appointments for this day.";
    tl.appendChild(empty);
    return;
  }

  // show from 8..18
  const hours = [];
  for (let h=8; h<=18; h++) hours.push(h);

  // just render blocks for appts and show hour labels around them
  // simplified: list each appt row with its start time
  for (const a of list){
    const row = document.createElement("div");
    row.className = "slot";
    const hh = (a.time||"").slice(0,2);
    const h = Number(hh);
    const timeText = a.time ? a.time.replace(/^0/,'') : "‚Äî";
    row.innerHTML = `<div class="time">${timeText}</div>`;
    const card = document.createElement("div");
    card.className = "appt";
    const cname = clientName(a.clientId);
    const pets = petLabel(a.clientId, a.pets);
    card.innerHTML = `<div class="title">${cname}</div>
      <div class="meta">${a.time || ""} ${pets? ` ‚Ä¢ <span class="pet">üêæ ${pets}</span>`:""}</div>`;
    card.addEventListener("click", ()=>openDetails(a.id));
    row.appendChild(card);
    tl.appendChild(row);
  }
}

function renderAll(){
  renderDayStrip();
  renderTimeline();
  renderCloudLine();
}

/* ---------- Details Modal ---------- */
function openOverlay(id){ $("#"+id).classList.add("show"); }
function closeOverlay(id){ $("#"+id).classList.remove("show"); }

$("#closeDetails").addEventListener("click", ()=>closeOverlay("detailsOverlay"));
$("#closeEdit").addEventListener("click", ()=>closeOverlay("editOverlay"));
$("#settingsBtn").addEventListener("click", ()=>{
  $("#firebaseConfigInput").value = localStorage.getItem(CLOUD_KEY) || "";
  openOverlay("settingsOverlay");
});
$("#closeSettings").addEventListener("click", ()=>closeOverlay("settingsOverlay"));

function openDetails(apptId){
  view.selectedApptId = apptId;
  const a = state.appointments.find(x=>x.id===apptId);
  if (!a){ showToast("Appointment not found", true); return; }

  $("#dClient").textContent = clientName(a.clientId);
  $("#dDate").textContent = parseISODate(a.date).toLocaleDateString(undefined,{weekday:"long", year:"numeric", month:"long", day:"numeric"});
  $("#dTime").textContent = a.time || "‚Äî";
  $("#dStatus").textContent = a.status || "CONFIRMED";
  $("#dFirstTime").textContent = (a.firstTime==="yes") ? "üüß First time client" : "";

  const {lines, total} = serviceLines(a.services);
  const ds = $("#dServices");
  ds.innerHTML = "";
  if (!lines.length){
    ds.innerHTML = `<div class="small muted">No services selected.</div>`;
  }else{
    for (const l of lines){
      const r = document.createElement("div");
      r.className = "row";
      r.style.justifyContent = "space-between";
      r.style.padding = "6px 0";
      r.innerHTML = `<div>${l.name}</div><div class="muted">${fmtMoney(l.price)}</div>`;
      ds.appendChild(r);
    }
  }
  $("#dTotal").textContent = fmtMoney(total);

  // recurring
  const isRecurring = !!a.seriesId;
  $("#recurringActions").style.display = isRecurring ? "block":"none";

  openOverlay("detailsOverlay");
}

// View all appointments for this customer
$("#viewCustomerApptsBtn").addEventListener("click", ()=>{
  const a = state.appointments.find(x=>x.id===view.selectedApptId);
  if (!a) return;
  closeOverlay("detailsOverlay");
  showScreen("schedule");
  // Jump to earliest appointment for this client on selected day
  view.selectedDate = parseISODate(a.date);
  renderAll();
  showToast(`Showing appointments for ${clientName(a.clientId)} (tap them on the day)`);
});

/* ---------- Edit Modal ---------- */
$("#editFromDetailsBtn").addEventListener("click", ()=>{
  closeOverlay("detailsOverlay");
  openEdit(view.selectedApptId);
});

$("#addApptBtn").addEventListener("click", ()=>openEdit(null));

function openEdit(apptId){
  view.editingApptId = apptId;
  const editing = apptId ? state.appointments.find(x=>x.id===apptId) : null;
  $("#editTitle").textContent = apptId ? "Edit Appointment" : "New Appointment";

  // clients dropdown
  const cSel = $("#eClient");
  cSel.innerHTML = "";
  for (const c of state.clients){
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.name;
    cSel.appendChild(opt);
  }

  // default client
  cSel.value = editing?.clientId || state.clients[0]?.id || "";

  // date/time defaults
  $("#eDate").value = editing?.date || toISODate(view.selectedDate);
  $("#eTime").value = editing?.time || "10:00";
  $("#eStatus").value = editing?.status || "CONFIRMED";
  $("#eFirstTime").value = editing?.firstTime || "no";
  $("#eRepeat").value = "none";
  $("#eOccur").value = 6;

  function renderPetsAndServices(){
    const clientId = cSel.value;
    const c = state.clients.find(x=>x.id===clientId);
    const pets = Array.isArray(c?.pets) ? c.pets : [];

    const aPets = (editing?.pets)||[];
    const aSvcs = (editing?.services)||[];

    const petsBox = $("#ePets");
    petsBox.innerHTML = "";
    if (!pets.length){
      petsBox.innerHTML = `<div class="small muted">No pets for this client. Add a pet in Clients tab.</div>`;
    }else{
      for (const p of pets){
        const row = document.createElement("div");
        row.className = "serviceRow";
        row.innerHTML = `<div class="left">
          <input type="checkbox" data-pet="${p.id}"/>
          <div><div style="font-weight:900">${p.name}</div><div class="small">${p.breed||""}</div></div>
        </div><div class="muted">üêæ</div>`;
        const cb = row.querySelector("input");
        cb.checked = aPets.includes(p.id);
        petsBox.appendChild(row);
      }
    }

    const svcBox = $("#eServices");
    svcBox.innerHTML = "";
    if (!state.services.length){
      svcBox.innerHTML = `<div class="small muted">No services. Add services in Services tab.</div>`;
    }else{
      for (const s of state.services){
        const row = document.createElement("div");
        row.className = "serviceRow";
        row.innerHTML = `<div class="left">
          <input type="checkbox" data-svc="${s.id}"/>
          <div><div style="font-weight:900">${s.name}</div><div class="small">${fmtMoney(s.price)}</div></div>
        </div><div class="muted">$</div>`;
        const cb = row.querySelector("input");
        cb.checked = aSvcs.includes(s.id);
        svcBox.appendChild(row);
      }
    }
  }

  cSel.onchange = ()=>{
    // If editing existing appointment and you change client, reset selections to avoid undefined errors
    if (editing){
      editing.pets = [];
      editing.services = [];
    }
    renderPetsAndServices();
  };

  renderPetsAndServices();

  // delete button
  $("#deleteApptBtn").style.display = apptId ? "block":"none";

  openOverlay("editOverlay");
}

$("#saveApptBtn").addEventListener("click", ()=>{
  const apptId = view.editingApptId;
  const clientId = $("#eClient").value;
  if (!clientId){ showToast("Add a client first.", true); return; }
  const date = $("#eDate").value;
  const time = $("#eTime").value;
  if (!date || !time){ showToast("Date and time are required.", true); return; }

  const pets = $$("input[data-pet]:checked", $("#editOverlay")).map(cb=>cb.dataset.pet);
  const services = $$("input[data-svc]:checked", $("#editOverlay")).map(cb=>cb.dataset.svc);

  const status = $("#eStatus").value;
  const firstTime = $("#eFirstTime").value;

  const repeat = $("#eRepeat").value;
  const occur = Math.max(2, Math.min(52, Number($("#eOccur").value || 6)));

  if (!state.clients.find(c=>c.id===clientId)){
    showToast("Selected client not found.", true); return;
  }

  // base appointment object
  let baseAppt = null;
  if (apptId){
    baseAppt = state.appointments.find(a=>a.id===apptId);
    if (!baseAppt){ showToast("Appointment missing.", true); return; }
    Object.assign(baseAppt, {clientId, date, time, pets, services, status, firstTime});
  }else{
    baseAppt = {id:uid("a"), clientId, date, time, pets, services, status, firstTime, seriesId:null};
    state.appointments.push(baseAppt);
  }

  // Create series if requested
  if (repeat !== "none"){
    const seriesId = baseAppt.seriesId || uid("series");
    baseAppt.seriesId = seriesId;

    // Remove existing future series generated from same base date (keep base)
    state.appointments = state.appointments.filter(a => !(a.seriesId===seriesId && a.id!==baseAppt.id));

    const baseDate = parseISODate(date);
    const stepDays = repeat==="weekly" ? 7 : (repeat==="fortnightly" ? 14 : 30);
    for (let i=1;i<occur;i++){
      const nd = new Date(baseDate);
      if (repeat==="monthly"){
        nd.setMonth(baseDate.getMonth()+i);
      }else{
        nd.setDate(baseDate.getDate() + (i*stepDays));
      }
      state.appointments.push({
        id: uid("a"),
        clientId, date: toISODate(nd), time,
        pets:[...pets], services:[...services],
        status, firstTime,
        seriesId
      });
    }
  }

  saveState();
  closeOverlay("editOverlay");
  renderAll();
  showToast("Saved");
});

$("#deleteApptBtn").addEventListener("click", ()=>{
  const apptId = view.editingApptId;
  const a = state.appointments.find(x=>x.id===apptId);
  if (!a) return;
  const seriesId = a.seriesId;
  state.appointments = state.appointments.filter(x=>x.id!==apptId);
  saveState();
  closeOverlay("editOverlay");
  renderAll();
  showToast("Deleted");
});

/* Recurring buttons from Details */
$("#onlyThisBtn").addEventListener("click", ()=>{
  // Detach this appointment from series
  const a = state.appointments.find(x=>x.id===view.selectedApptId);
  if (!a) return;
  a.seriesId = null;
  saveState();
  closeOverlay("detailsOverlay");
  renderAll();
  showToast("Updated (only this appointment)");
});
$("#seriesBtn").addEventListener("click", ()=>{
  // Open edit, and they can set repeat to regenerate series
  closeOverlay("detailsOverlay");
  openEdit(view.selectedApptId);
});

/* ---------- Clients Screen ---------- */
function renderClients(){
  const box = $("#clientsList");
  box.innerHTML = "";
  for (const c of state.clients){
    const item = document.createElement("div");
    item.className = "serviceRow";
    item.innerHTML = `<div>
      <div style="font-weight:950">${c.name}</div>
      <div class="small">${(c.pets||[]).length} pet(s)</div>
    </div>
    <div class="row">
      <button class="btn" data-edit-client="${c.id}">Edit</button>
    </div>`;
    box.appendChild(item);
  }
  if (!state.clients.length){
    box.innerHTML = `<div class="small muted">No clients yet.</div>`;
  }
}
$("#addClientBtn").addEventListener("click", ()=>{
  const name = prompt("Client name?");
  if (!name) return;
  state.clients.push({id:uid("c"), name, phone:"", notes:"", pets:[]});
  saveState(); renderClients(); renderAll();
});
$("#clientsList").addEventListener("click", (e)=>{
  const id = e.target?.dataset?.editClient;
  if (!id) return;
  const c = state.clients.find(x=>x.id===id);
  if (!c) return;
  const newName = prompt("Client name", c.name);
  if (newName!==null && newName.trim()) c.name = newName.trim();

  const addPet = confirm("Add / edit pets? Press OK to add a pet, Cancel to skip.");
  if (addPet){
    const pName = prompt("Pet name?");
    if (pName){
      const pBreed = prompt("Breed (optional)") || "";
      c.pets = Array.isArray(c.pets) ? c.pets : [];
      c.pets.push({id:uid("p"), name:pName, breed:pBreed});
    }
  }
  saveState(); renderClients(); renderAll();
});

/* ---------- Services Screen ---------- */
function renderServices(){
  const box = $("#servicesList");
  box.innerHTML = "";
  for (const s of state.services){
    const item = document.createElement("div");
    item.className = "serviceRow";
    item.innerHTML = `<div>
      <div style="font-weight:950">${s.name}</div>
      <div class="small">${fmtMoney(s.price)}</div>
    </div>
    <div class="row">
      <button class="btn" data-edit-svc="${s.id}">Edit</button>
    </div>`;
    box.appendChild(item);
  }
  if (!state.services.length){
    box.innerHTML = `<div class="small muted">No services yet.</div>`;
  }
}
$("#addServiceBtn").addEventListener("click", ()=>{
  const name = prompt("Service name?");
  if (!name) return;
  const price = Number(prompt("Price (AUD)?", "0") || 0);
  state.services.push({id:uid("s"), name, price: isFinite(price)?price:0});
  saveState(); renderServices(); renderAll();
});
$("#servicesList").addEventListener("click", (e)=>{
  const id = e.target?.dataset?.editSvc;
  if (!id) return;
  const s = state.services.find(x=>x.id===id);
  if (!s) return;
  const newName = prompt("Service name", s.name);
  if (newName!==null && newName.trim()) s.name = newName.trim();
  const newPriceRaw = prompt("Price (AUD)", String(s.price ?? 0));
  if (newPriceRaw!==null){
    const p = Number(newPriceRaw);
    if (isFinite(p)) s.price = p;
  }
  saveState(); renderServices(); renderAll();
});

/* ---------- Month navigation ---------- */
$("#prevMonth").addEventListener("click", ()=>{
  view.currentMonth = new Date(view.currentMonth.getFullYear(), view.currentMonth.getMonth()-1, 1);
  view.selectedDate = new Date(view.currentMonth.getFullYear(), view.currentMonth.getMonth(), view.selectedDate.getDate());
  renderAll();
});
$("#nextMonth").addEventListener("click", ()=>{
  view.currentMonth = new Date(view.currentMonth.getFullYear(), view.currentMonth.getMonth()+1, 1);
  view.selectedDate = new Date(view.currentMonth.getFullYear(), view.currentMonth.getMonth(), view.selectedDate.getDate());
  renderAll();
});
$("#todayBtn").addEventListener("click", ()=>{
  const t = new Date();
  view.currentMonth = new Date(t.getFullYear(), t.getMonth(), 1);
  view.selectedDate = t;
  renderAll();
});
$("#zoomIn").addEventListener("click", ()=>{
  view.zoom = Math.min(140, view.zoom+10);
  $("#zoomLabel").textContent = view.zoom + "%";
});
$("#zoomOut").addEventListener("click", ()=>{
  view.zoom = Math.max(70, view.zoom-10);
  $("#zoomLabel").textContent = view.zoom + "%";
});

/* ---------- Export / Import ---------- */
function exportJSON(){
  const data = {version:1, exportedAt:new Date().toISOString(), state};
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `maya_groom_pro_backup_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  localStorage.setItem(BACKUP_KEY, new Date().toISOString());
  renderCloudLine();
  showToast("Exported backup JSON");
}
$("#exportBtn").addEventListener("click", exportJSON);
$("#uploadBtn").addEventListener("click", exportJSON);

$("#importInput").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if (!file) return;
  try{
    const text = await file.text();
    const parsed = JSON.parse(text);
    if (!parsed?.state) throw new Error("Invalid backup file");
    state = parsed.state;
    saveState();
    closeOverlay("settingsOverlay");
    renderClients(); renderServices(); renderAll();
    showToast("Imported backup");
  }catch(err){
    showToast("Import failed: " + err.message, true);
  }finally{
    e.target.value = "";
  }
});

$("#resetBtn").addEventListener("click", ()=>{
  if (!confirm("Reset local data on this device?")) return;
  localStorage.removeItem(STORAGE_KEY);
  loadState();
  saveState();
  closeOverlay("settingsOverlay");
  renderClients(); renderServices(); renderAll();
  showToast("Reset done");
});

/* ---------- Theme toggle (simple) ---------- */
let lightMode = false;
$("#themeBtn").addEventListener("click", ()=>{
  lightMode = !lightMode;
  if (lightMode){
    document.documentElement.style.setProperty("--bg","#f6efe8");
    document.body.style.background = "#f6efe8";
    document.documentElement.style.setProperty("--panel","#ffffff");
    document.documentElement.style.setProperty("--panel2","#ffffff");
    document.documentElement.style.setProperty("--text","#1b1b1b");
    document.documentElement.style.setProperty("--muted","#5b5856");
    document.documentElement.style.setProperty("--line","rgba(0,0,0,.08)");
  }else{
    location.reload(); // easiest: reload to restore defaults
  }
});

/* ---------- Firebase Sync (Optional, SAFE, no crashes) ---------- */
let firebaseReady = false;
let fb = {app:null, auth:null, db:null, user:null};

function renderCloudLine(extraStatus){
  const last = localStorage.getItem(BACKUP_KEY);
  $("#lastBackup").textContent = last ? new Date(last).toLocaleString() : "‚Äî";
  if (extraStatus) $("#cloudStatus").textContent = extraStatus;
}

async async function ensureFirebase(){
  if (firebaseReady) return true;

  const cfgRaw = localStorage.getItem(CLOUD_KEY);
  if (!cfgRaw) {
    firebaseReady = false;
    return false;
  }

  let cfg;
  try{ cfg = JSON.parse(cfgRaw); }catch(e){
    firebaseReady = false;
    return false;
  }
  if (!cfg?.apiKey || !cfg?.projectId){
    firebaseReady = false;
    return false;
  }

  // Load Firebase compat (v9) dynamically so the app still runs without it
  const loadScript = (src)=> new Promise((res,rej)=>{
    const s=document.createElement("script");
    s.src=src; s.async=true;
    s.onload=res; s.onerror=rej;
    document.head.appendChild(s);
  });

  try{
    if (!window.firebase){
      await loadScript("https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js");
      await loadScript("https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js");
      await loadScript("https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js");
    }
    fb.app = firebase.initializeApp(cfg);
    fb.auth = firebase.auth();
    fb.db = firebase.firestore();
    firebaseReady = true;
    return true;
  }catch(err){
    console.error(err);
    firebaseReady = false;
    return false;
  }
}

async function signInAnon(){
  const ok = await ensureFirebase();
  if (!ok) return false;
  try{
    const userCred = await fb.auth.signInAnonymously();
    fb.user = userCred.user;
    return true;
  }catch(err){
    // Common: auth/configuration-not-found when Anonymous not enabled
    throw err;
  }
}

async async function syncNow(){
  // Keep UX sane:
  // - If offline: show clear message.
  // - If firebase not configured: show clear message.
  // - If auth fails: show exact Firebase error code.
  // - If firestore read fails: show clear message.
  if (!navigator.onLine){
    renderCloudLine("Not synced");
    showToast("Sync failed: Failed to get document because the client is offline.", true);
    return;
  }

  const ok = await ensureFirebase();
  if (!ok){
    renderCloudLine("Not synced");
    showToast("Cloud sync not configured. Open Settings and paste Firebase config JSON.", true);
    return;
  }

  try{
    await signInAnon();
  }catch(err){
    const code = err?.code || "unknown";
    renderCloudLine("Sync failed");
    showToast(`Sync failed: Firebase Error (${code}).`, true);
    return;
  }

  try{
    const uid = fb.auth.currentUser?.uid;
    const docRef = fb.db.collection("backups").doc(uid);
    const payload = {
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      state
    };
    await docRef.set(payload, {merge:true});
    const snap = await docRef.get();
    const updatedAt = snap.get("updatedAt");
    const ts = updatedAt?.toDate ? updatedAt.toDate() : new Date();
    localStorage.setItem(BACKUP_KEY, ts.toISOString());
    $("#cloudStatus").textContent = "Synced";
    $("#lastBackup").textContent = ts.toLocaleString();
    showToast("Synced");
  }catch(err){
    console.error(err);
    $("#cloudStatus").textContent = "Sync failed";
    showToast("Sync failed: " + (err?.message || "Unknown error"), true);
  }
}

$("#syncBtn").addEventListener("click", ()=>{ syncNow(); });

/* Firebase config save/clear */
$("#saveFirebaseBtn").addEventListener("click", ()=>{
  const v = $("#firebaseConfigInput").value.trim();
  if (!v){ showToast("Paste Firebase config JSON first.", true); return; }
  try{
    JSON.parse(v);
    localStorage.setItem(CLOUD_KEY, v);
    firebaseReady = false;
    showToast("Saved Firebase config");
  }catch(e){
    showToast("Invalid JSON", true);
  }
});
$("#clearFirebaseBtn").addEventListener("click", ()=>{
  localStorage.removeItem(CLOUD_KEY);
  firebaseReady = false;
  showToast("Cleared Firebase config");
});

/* ---------- Boot ---------- */
function boot(){
  loadState();
  saveState();
  // initial month = selected date's month
  view.selectedDate = new Date();
  view.currentMonth = new Date(view.selectedDate.getFullYear(), view.selectedDate.getMonth(), 1);

  renderClients();
  renderServices();
  renderAll();
  $("#zoomLabel").textContent = view.zoom + "%";
  // show build stamp in cloud label (helps you confirm right file)
  const build = document.createElement("span");
  build.textContent = " (BUILD " + new Date().toISOString().slice(0,19).replace("T"," ") + ")";
  $("#cloudLine").prepend(build);
}
boot();

function editFromDetails(){
  const id = view.selectedApptId;
  closeOverlay("detailsOverlay");
  if(id){ openEdit(id); }
}

</script>
</body>
</html>
