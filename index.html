<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Maya Groom Pro - Mobile Pet Grooming Appointments</title>

    <!-- Theme colors for mobile browsers and home screen -->
    <meta name="theme-color" content="#C7632C">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Maya Groom Pro">

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --bg-primary: #F5EAD8;
            --bg-secondary: #FFF8ED;
            --bg-tertiary: #E8DCC8;
            --text-primary: #2A1F14;
            --text-secondary: #5A4A3A;
            --text-tertiary: #8A7A6A;
            --accent-primary: #C7632C;
            --accent-secondary: #E88D5A;
            --accent-dark: #9A4A1F;
            --border: #D4C5B3;
            --success: #6B9F7F;
            --warning: #D89545;
            --danger: #D94A3D;
        }

        .dark {
            --bg-primary: #1A1410;
            --bg-secondary: #2A2218;
            --bg-tertiary: #3A3028;
            --text-primary: #F5EAD8;
            --text-secondary: #D4C5B3;
            --text-tertiary: #A89682;
            --border: #4A3F35;
        }

        * {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        html, body {
            height: 100%;
            width: 100%;
            max-width: 100vw;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
            font-size: 16px;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .mono {
            font-family: 'DM Mono', monospace;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-dark));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px -5px rgba(236, 72, 153, 0.4);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-sm {
            padding: 0.5rem 0.875rem;
            font-size: 0.75rem;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 1.5rem;
            padding: 1rem;
            transition: all 0.3s;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.1);
        }

        .input-field {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border-radius: 0.5rem;
            border: 1.5px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            animation: fadeIn 0.2s forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 1.75rem;
            max-width: 90%;
            width: 500px;
            max-height: 75vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s;
            margin-bottom: 6rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            font-size: 0.75rem;
        }

        .calendar-day:hover {
            border-color: var(--accent-secondary);
            background: var(--bg-secondary);
        }

        .calendar-day.selected {
            background: var(--accent-primary);
            color: white;
        }

        .calendar-day.has-appointments {
            border-color: var(--accent-primary);
        }

        .appointment-slot {
            padding: 1rem;
            border-radius: 1.25rem;
            border: 1.5px solid var(--border);
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .appointment-slot:hover {
            border-color: var(--accent-primary);
            background: var(--bg-tertiary);
        }

        .tab-button {
            padding: 0.625rem 1rem;
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            font-weight: 600;
            font-size: 0.813rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-button.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .badge {
            padding: 0.25rem 0.625rem;
            border-radius: 1rem;
            font-size: 0.688rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .badge-primary {
            background: rgba(236, 72, 153, 0.1);
            color: var(--accent-primary);
        }

        /* Week Navigation Styles */
        .week-days-nav {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.125rem;
            margin-bottom: 0.25rem;
            padding: 0.125rem 0;
        }

        .week-day-item {
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0.0625rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .week-day-label {
            font-size: 0.5625rem;
            color: var(--text-tertiary);
            margin-bottom: 0.0625rem;
            font-weight: 500;
        }

        .week-day-number {
            width: 1.25rem;
            height: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 0.5625rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .week-day-item:hover .week-day-number {
            background: var(--bg-tertiary);
        }

        .week-day-item.selected .week-day-number {
            background: var(--accent-primary);
            color: white;
        }

        .week-day-item.today .week-day-number {
            border: 2px solid var(--accent-primary);
        }

        .week-day-item.selected.today .week-day-number {
            border: none;
        }

        .week-nav-btn {
            background: var(--accent-primary);
            border: none;
            cursor: pointer;
            color: white;
            width: 1.125rem;
            min-width: 1.125rem;
            height: 1.125rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.2s;
            border-radius: 50%;
            padding: 0.0625rem;
            flex-shrink: 0;
        }

        .week-nav-btn:hover {
            background: var(--accent-dark);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .week-nav-btn:active {
            transform: scale(0.95);
        }

        @media (max-width: 640px) {
            .week-day-number {
                width: 1.375rem;
                height: 1.375rem;
                font-size: 0.625rem;
            }

            .week-day-label {
                font-size: 0.5625rem;
            }

            .timeline-hour {
                height: 3.5rem;
            }

            .week-nav-btn {
                width: 1.125rem;
                min-width: 1.125rem;
                height: 1.125rem;
            }
        }

        /* Single Day Timeline */
        .day-timeline {
            position: relative !important;
            touch-action: pan-y;
            min-height: 1152px; /* 24 hours * 48px */
        }

        .timeline-hour {
            height: var(--hour-height, 3rem);
            border-bottom: 1px solid var(--border);
            position: relative;
            display: flex;
            align-items: flex-start;
            padding-left: 3.5rem;
            cursor: pointer;
            transition: background 0.2s, height 0.15s ease-out;
        }

        .timeline-hour:hover {
            background: var(--bg-tertiary);
        }

        .timeline-hour-label {
            position: absolute;
            left: 0;
            top: 4px;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-family: 'DM Mono', monospace;
            width: 3rem;
            text-align: right;
            padding-right: 0.5rem;
            white-space: nowrap;
        }

        .timeline-appointment {
            position: absolute !important;
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3B82F6;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            cursor: move;
            transition: all 0.2s;
            touch-action: none;
            user-select: none;
            font-size: 0.813rem;
            z-index: 10;
            box-sizing: border-box;
            overflow: hidden;
        }

        .timeline-appointment.recurring {
            background: rgba(168, 85, 247, 0.15);
            border-left: 3px solid #A855F7;
        }

        .timeline-appointment.recurring .timeline-appointment-title {
            color: #A855F7;
        }

        .timeline-appointment.completed {
            background: rgba(34, 197, 94, 0.15);
            border-left: 3px solid #22C55E;
        }

        .timeline-appointment.completed .timeline-appointment-title {
            color: #22C55E;
        }

        .timeline-appointment.cancelled {
            background: rgba(239, 68, 68, 0.15);
            border-left: 3px solid #EF4444;
            opacity: 0.6;
        }

        .timeline-appointment.cancelled .timeline-appointment-title {
            color: #EF4444;
            text-decoration: line-through;
        }

        .timeline-appointment:hover {
            background: rgba(59, 130, 246, 0.15);
            transform: translateX(2px);
        }

        .timeline-appointment.recurring:hover {
            background: rgba(168, 85, 247, 0.25);
        }

        .timeline-appointment.dragging {
            opacity: 0.7;
            z-index: 1000;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .timeline-appointment-title {
            font-weight: 700;
            color: #3B82F6;
            font-size: 0.875rem;
            pointer-events: none;
        }

        /* Current time indicator */
        .current-time-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: #EF4444;
            z-index: 20;
            pointer-events: none;
        }

        .current-time-line::before {
            content: '';
            position: absolute;
            left: 3rem;
            top: -4px;
            width: 10px;
            height: 10px;
            background: #EF4444;
            border-radius: 50%;
        }

        .current-time-label {
            position: absolute;
            left: 0.25rem;
            top: -8px;
            font-size: 0.625rem;
            font-weight: 700;
            color: #EF4444;
            background: var(--bg-primary);
            padding: 0 2px;
        }

        .checkbox-custom {
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox-custom.checked {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        @media (max-width: 640px) {
            .modal-content {
                max-width: 95%;
                margin: 1rem;
            }

            .btn {
                padding: 0.625rem 1.25rem;
                font-size: 0.938rem;
            }

            .week-timeline {
                grid-template-columns: 50px repeat(7, 1fr);
            }

            .timeline-day-column {
                min-width: 100px;
            }
        }

        /* Utility Classes */
        .flex { display: flex; }
        .inline-flex { display: inline-flex; }
        .grid { display: grid; }
        .hidden { display: none !important; }
        .block { display: block; }
        .inline-block { display: inline-block; }

        .tab-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .items-end { align-items: flex-end; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }

        .flex-col { flex-direction: column; }
        .flex-wrap { flex-wrap: wrap; }
        .flex-1 { flex: 1; }

        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }

        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-6 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
        .pt-4 { padding-top: 1rem; }
        .pb-2 { padding-bottom: 0.5rem; }
        .pb-4 { padding-bottom: 1rem; }
        .pl-3 { padding-left: 0.75rem; }
        .pr-3 { padding-right: 0.75rem; }

        .m-0 { margin: 0; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .mx-4 { margin-left: 1rem; margin-right: 1rem; }
        .my-2 { margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .my-4 { margin-top: 1rem; margin-bottom: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mr-1 { margin-right: 0.25rem; }
        .mr-2 { margin-right: 0.5rem; }
        .ml-2 { margin-left: 0.5rem; }

        .w-full { width: 100%; }
        .w-12 { width: 3rem; }
        .h-12 { height: 3rem; }
        .max-w-7xl { max-width: 80rem; }
        .max-w-sm { max-width: 24rem; }
        .min-w-0 { min-width: 0; }

        .text-xs { font-size: 0.688rem; line-height: 0.875rem; }
        .text-sm { font-size: 0.75rem; line-height: 1rem; }
        .text-base { font-size: 0.875rem; line-height: 1.25rem; }
        .text-lg { font-size: 1rem; line-height: 1.5rem; }
        .text-xl { font-size: 1.125rem; line-height: 1.5rem; }
        .text-2xl { font-size: 1.25rem; line-height: 1.625rem; }
        .text-3xl { font-size: 1.5rem; line-height: 1.875rem; }
        .text-4xl { font-size: 1.75rem; line-height: 2rem; }

        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }

        .text-center { text-align: center; }
        .text-right { text-align: right; }

        .rounded { border-radius: 0.75rem; }
        .rounded-lg { border-radius: 1rem; }
        .rounded-full { border-radius: 9999px; }

        .border { border-width: 1px; }
        .border-t { border-top-width: 1px; }
        .border-b { border-bottom-width: 1px; }

        .overflow-x-auto { overflow-x: auto; }
        .overflow-y-auto { overflow-y: auto; }
        .overflow-hidden { overflow: hidden; }

        .cursor-pointer { cursor: pointer; }
        .cursor-move { cursor: move; }

        .sticky { position: sticky; }
        .fixed { position: fixed; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }

        .top-0 { top: 0; }
        .z-50 { z-index: 50; }

        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .space-y-6 > * + * { margin-top: 1.5rem; }

        .opacity-50 { opacity: 0.5; }
        .opacity-70 { opacity: 0.7; }
        .hover\:opacity-70:hover { opacity: 0.7; }
        .hover\:bg-opacity-10:hover { background-opacity: 0.1; }

        .transition-opacity { transition-property: opacity; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="sticky top-0 z-50" style="background: var(--bg-secondary); border-bottom: 1px solid var(--border);">
        <div class="px-2 py-1 flex items-center justify-between">
            <div class="flex items-center gap-1">
                <div id="headerLogo" onclick="openLogoUpload()" style="cursor: pointer;">
                    <!-- Logo will be dynamically inserted here -->
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openSettings()" class="p-1.5 rounded-lg hover:bg-opacity-10" style="background: var(--bg-tertiary);">
                    <i class="fas fa-gear" style="font-size: 0.938rem;"></i>
                </button>
                <button onclick="toggleDarkMode()" class="p-1.5 rounded-lg hover:bg-opacity-10" style="background: var(--bg-tertiary);">
                    <i class="fas fa-moon" style="font-size: 0.938rem;"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Hidden file input for logo upload -->
    <input type="file" id="headerLogoUploadInput" accept="image/*" style="display: none;" onchange="handleHeaderLogoUpload(event)">


    <!-- Main Content -->
    <main style="height: calc(100vh - 6.5rem); display: flex; flex-direction: column; overflow: hidden;">
        <!-- Schedule View -->
        <div id="scheduleView" class="tab-content" style="display: flex; flex-direction: column; height: 100%; overflow: hidden;">
            <!-- Fixed Top Section - This stays pinned -->
            <div style="flex-shrink: 0; z-index: 50; background: var(--bg-primary); padding: 0.25rem 0.5rem;">
                <!-- Month/Year Header with + Button -->
                <div class="flex justify-between items-center mb-1 px-1">
                    <button onclick="showScheduleMenu()" class="p-1" style="background: transparent; visibility: hidden;">
                        <i class="fas fa-ellipsis-vertical" style="font-size: 0.75rem;"></i>
                    </button>
                    <h2 class="text-base font-bold cursor-pointer hover:opacity-70 transition-opacity text-center" id="currentMonthYear" onclick="toggleMonthView()"></h2>
                    <button class="p-1" style="background: transparent;" onclick="showScheduleMenu()" title="Add appointment">
                        <i class="fas fa-plus" style="color: var(--accent-primary); font-size: 0.688rem;"></i>
                    </button>
                </div>

                <!-- Collapsible Month View -->
                <div id="monthViewCollapse" class="hidden mb-2">
                    <div class="card" style="padding: 0.75rem;">
                        <div class="flex justify-between items-center mb-2">
                            <button onclick="previousMonth()" class="p-1.5 rounded-lg hover:bg-opacity-10" style="background: var(--bg-tertiary);">
                                <i class="fas fa-chevron-left" style="font-size: 0.75rem;"></i>
                            </button>
                            <h3 class="text-sm font-bold mono" id="calendarMonth"></h3>
                            <button onclick="nextMonth()" class="p-1.5 rounded-lg hover:bg-opacity-10" style="background: var(--bg-tertiary);">
                                <i class="fas fa-chevron-right" style="font-size: 0.75rem;"></i>
                            </button>
                        </div>

                        <div class="calendar-grid mb-1">
                            <div class="text-center font-semibold p-1" style="color: var(--text-tertiary); font-size: 0.625rem;">Mon</div>
                            <div class="text-center font-semibold p-1" style="color: var(--text-tertiary); font-size: 0.625rem;">Tue</div>
                            <div class="text-center font-semibold p-1" style="color: var(--text-tertiary); font-size: 0.625rem;">Wed</div>
                            <div class="text-center font-semibold p-1" style="color: var(--text-tertiary); font-size: 0.625rem;">Thu</div>
                            <div class="text-center font-semibold p-1" style="color: var(--text-tertiary); font-size: 0.625rem;">Fri</div>
                            <div class="text-center font-semibold p-1" style="color: var(--text-tertiary); font-size: 0.625rem;">Sat</div>
                            <div class="text-center font-semibold p-1" style="color: var(--text-tertiary); font-size: 0.625rem;">Sun</div>
                        </div>

                        <div class="calendar-grid" id="calendarDays"></div>
                    </div>
                </div>

                <!-- Week Day Selector (Fixed) -->
                <div style="background: var(--bg-primary); padding: 0.25rem 0; border-bottom: 1px solid var(--border);">
                    <!-- Hidden week range for JS compatibility -->
                    <div id="weekRange" style="display: none;"></div>
                    <div style="display: flex; align-items: center; gap: 0.125rem; padding: 0 0.125rem; width: 100%; max-width: 100%;">
                        <button onclick="previousWeek()" class="week-nav-btn">
                            <i class="fas fa-chevron-left" style="font-size: 0.5rem;"></i>
                        </button>
                        <div class="week-days-nav" id="weekDaysNav" style="flex: 1; min-width: 0;"></div>
                        <button onclick="nextWeek()" class="week-nav-btn">
                            <i class="fas fa-chevron-right" style="font-size: 0.5rem;"></i>
                        </button>
                    </div>
                </div>

                <!-- Filter Icon & Today Button -->
                <div style="background: var(--bg-primary); padding: 0.25rem 0.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; gap: 0.25rem;">
                    <button onclick="showFilterMenu()" id="filterButton" class="btn-sm" style="background: var(--bg-tertiary); color: var(--text-primary); padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600; border: none; display: flex; align-items: center; gap: 0.25rem;">
                        <i class="fas fa-filter" style="font-size: 0.625rem;"></i>
                        <span id="filterLabel">All</span>
                    </button>
                    <button onclick="jumpToToday()" class="btn-sm" style="background: var(--accent-secondary); color: white; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600; border: none; white-space: nowrap;">
                        <i class="fas fa-calendar-day" style="margin-right: 0.25rem; font-size: 0.625rem;"></i>Today
                    </button>
                </div>
            </div>

            <!-- Scrollable Timeline Section -->
            <div id="timelineScrollContainer" style="flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; background: var(--bg-primary); min-height: 0;">
                <div class="day-timeline" id="dayTimeline" style="max-height: none; min-height: auto; overflow-y: visible;"></div>
            </div>
        </div>

        <!-- Clients View -->
        <div id="clientsView" class="tab-content hidden">
            <div style="position: sticky; top: 0; z-index: 50; background: var(--bg-primary); padding: 0.5rem;">
                <div class="flex justify-between items-center px-2 mb-3">
                    <button class="p-2" style="background: transparent; visibility: hidden;">
                        <i class="fas fa-plus" style="font-size: 0.75rem;"></i>
                    </button>
                    <h2 class="text-xl font-bold text-center">Clients & Pets</h2>
                    <button class="p-2" style="background: transparent;" onclick="showClientsMenu()" title="Client actions">
                        <i class="fas fa-plus" style="color: var(--accent-primary); font-size: 0.75rem;"></i>
                    </button>
                </div>
                <!-- Search Bar -->
                <div class="px-2">
                    <input type="text" id="clientSearch" placeholder="Search clients, pets, phone..." onkeyup="filterClients()" style="width: 100%; padding: 0.75rem 1rem; border-radius: 0.75rem; border: 1px solid var(--border); background: var(--bg-secondary); font-size: 1.125rem; color: var(--text-primary);">
                </div>
            </div>

            <div style="flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 1rem;">
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4" id="clientsList"></div>
            </div>
        </div>

        <!-- Services View -->
        <div id="servicesView" class="tab-content hidden">
            <div style="position: sticky; top: 0; z-index: 50; background: var(--bg-primary); padding: 0.5rem;">
                <div class="flex justify-between items-center px-2">
                    <button class="p-2" style="background: transparent; visibility: hidden;">
                        <i class="fas fa-plus" style="font-size: 0.75rem;"></i>
                    </button>
                    <h2 class="text-xl font-bold text-center">Services & Items</h2>
                    <button class="p-2" style="background: transparent;" onclick="showServicesMenu()" title="Add service or item">
                        <i class="fas fa-plus" style="color: var(--accent-primary); font-size: 0.75rem;"></i>
                    </button>
                </div>
                <!-- Filter Tabs -->
                <div class="flex justify-center gap-1 mt-2 px-2">
                    <button id="filterAll" onclick="filterServicesItems('all')" class="px-3 py-1 rounded-full text-xs font-semibold transition-all" style="background: var(--accent-primary); color: white;">
                        All
                    </button>
                    <button id="filterServices" onclick="filterServicesItems('service')" class="px-3 py-1 rounded-full text-xs font-semibold transition-all" style="background: var(--bg-tertiary); color: var(--text-secondary);">
                        Services
                    </button>
                    <button id="filterItems" onclick="filterServicesItems('item')" class="px-3 py-1 rounded-full text-xs font-semibold transition-all" style="background: var(--bg-tertiary); color: var(--text-secondary);">
                        Items
                    </button>
                </div>
            </div>

            <div style="flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 1rem;">
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4" id="servicesList"></div>
            </div>
        </div>

        <!-- Waitlist View -->
        <div id="waitlistView" class="tab-content hidden">
            <div style="position: sticky; top: 0; z-index: 50; background: var(--bg-primary); padding: 0.5rem;">
                <div class="flex justify-between items-center px-2">
                    <button class="p-2" style="background: transparent; visibility: hidden;">
                        <i class="fas fa-plus" style="font-size: 0.75rem;"></i>
                    </button>
                    <h2 class="text-xl font-bold text-center">Waitlist</h2>
                    <button class="p-2" style="background: transparent;" onclick="openAddToWaitlistModal()">
                        <i class="fas fa-plus" style="color: var(--accent-primary); font-size: 0.75rem;"></i>
                    </button>
                </div>
            </div>

            <div style="flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 1rem;">
                <div id="waitlistContainer"></div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav id="bottomNav" style="position: fixed; bottom: env(safe-area-inset-bottom, 0); left: 0; right: 0; width: 100%; display: grid; grid-template-columns: repeat(4, 1fr); background: var(--bg-secondary); border-top: 1px solid var(--border); z-index: 10000; padding: 0.375rem 0;">
        <button id="tabSchedule" onclick="switchTab('schedule')" style="background: transparent; border: none; padding: 0.25rem; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.125rem; color: var(--accent-primary); cursor: pointer; min-width: 0;">
            <i class="fas fa-calendar-week" style="font-size: 0.875rem;"></i>
            <span style="font-size: 0.625rem; font-weight: 600;">Schedule</span>
        </button>
        <button id="tabClients" onclick="switchTab('clients')" style="background: transparent; border: none; padding: 0.25rem; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.125rem; color: var(--text-tertiary); cursor: pointer; min-width: 0;">
            <i class="fas fa-users" style="font-size: 0.875rem;"></i>
            <span style="font-size: 0.625rem; font-weight: 600;">Clients</span>
        </button>
        <button id="tabServices" onclick="switchTab('services')" style="background: transparent; border: none; padding: 0.25rem; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.125rem; color: var(--text-tertiary); cursor: pointer; min-width: 0;">
            <i class="fas fa-scissors" style="font-size: 0.875rem;"></i>
            <span style="font-size: 0.625rem; font-weight: 600;">Services</span>
        </button>
        <button id="tabWaitlist" onclick="switchTab('waitlist')" style="background: transparent; border: none; padding: 0.25rem; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.125rem; color: var(--text-tertiary); cursor: pointer; min-width: 0;">
            <i class="fas fa-clock" style="font-size: 0.875rem;"></i>
            <span style="font-size: 0.625rem; font-weight: 600;">Waitlist</span>
        </button>
    </nav>

    <script>
        // Data Storage
        let appointments = [];
        let clients = [];
        let services = [];
        let items = [];
        let waitlist = [];
        let packages = []; // Service packages
        let communicationLog = []; // Client communication history
        let recurringTemplates = []; // Templates for recurring appointments
        let currentDate = new Date();
        let selectedDate = new Date();
        let weekStartDate = getWeekStart(new Date());
        let appointmentFilter = 'all'; // all, confirmed, pending, completed
        let clientSearchQuery = '';
        let servicesItemsFilter = 'all'; // all, service, item

        // Timeline zoom settings
        let timelineZoom = 1; // 1 = normal, 0.5 = zoomed out (more hours visible), 2 = zoomed in
        const ZOOM_MIN = 0.4;
        const ZOOM_MAX = 2;
        const BASE_HOUR_HEIGHT = 48; // 3rem = 48px

        // Appointment model now includes:
        // - recurringId: ID of recurring template (if part of series)
        // - isRecurring: boolean
        // Client model now includes:
        // - noShowCount: number of missed appointments
        // - lastNoShow: date of last no-show

        // Settings
        let settings = {
            businessName: 'Maya Groom Pro',
            abn: '',
            phone: '',
            email: '',
            address: '',
            payId: '',
            bankName: '',
            bsb: '',
            accountNumber: '',
            accountName: '',
            use24HourClock: false,
            gstEnabled: true,
            gstRate: 0.10,
            logoDataUrl: '',
            messageTemplates: {
                booking: "Hi {clientFirstName}!\n\nYour grooming appointment with {businessName} has been confirmed:\n\nDate: {date}\nTime: {time}\nPets: {pets}\n\nWe'll see you then! Reply STOP to cancel.",
                confirmation: "Hi {clientFirstName}!\n\nPlease confirm your appointment with {businessName}:\n\nDate: {date}\nTime: {time}\nPets: {pets}\n\nReply YES to confirm or call us to reschedule.",
                reminder: "Hi {clientFirstName}!\n\nReminder: You have an appointment with {businessName} tomorrow:\n\nDate: {date}\nTime: {time}\nPets: {pets}\n\nSee you then!"
            }
        };

        // Helper Functions
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            // Adjust so Monday is first day (day 0 = Sunday becomes 6, others shift by -1)
            const diff = d.getDate() - (day === 0 ? 6 : day - 1);
            return new Date(d.setDate(diff));
        }

        function formatTime(date) {
            if (settings.use24HourClock) {
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
            } else {
                return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            }
        }

        function formatDate(date) {
            if (typeof date === 'string') {
                date = new Date(date);
            }
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function calculateGST(amount) {
            if (!settings.gstEnabled) return 0;
            return amount * settings.gstRate;
        }

        function calculateTotalWithGST(amount) {
            // Prices already include GST - just return the amount
            return amount;
        }

        // Initialize with sample data
        function initializeData() {
            // Sample services
            services = [
                { id: 1, name: 'Full Grooming', duration: 120, price: 85, description: 'Bath, haircut, nail trim, ear cleaning', type: 'service' },
                { id: 2, name: 'Bath & Brush', duration: 60, price: 45, description: 'Bath, brush out, nail trim', type: 'service' },
                { id: 3, name: 'Nail Trim', duration: 15, price: 15, description: 'Quick nail trim service', type: 'service' },
                { id: 4, name: 'De-shedding Treatment', duration: 90, price: 65, description: 'Special treatment for heavy shedders', type: 'service' }
            ];

            // Sample items
            items = [
                { id: 1, name: 'Flea Treatment', price: 25, description: 'Premium flea & tick treatment', type: 'item' },
                { id: 2, name: 'Teeth Cleaning', price: 35, description: 'Dental cleaning service', type: 'item' }
            ];

            // Sample clients
            clients = [
                {
                    id: 1,
                    name: 'Sarah Johnson',
                    email: 'sarah.j@email.com',
                    phone: '0412 345 678',
                    address: '123 Oak Street, Apt 4B, Sydney NSW 2000',
                    pets: [
                        { name: 'Max', breed: 'Golden Retriever', age: 3, notes: 'Very friendly, loves treats' }
                    ]
                },
                {
                    id: 2,
                    name: 'Mike Chen',
                    email: 'mchen@email.com',
                    phone: '0423 456 789',
                    address: '456 Maple Avenue, Melbourne VIC 3000',
                    pets: [
                        { name: 'Luna', breed: 'Poodle', age: 2, notes: 'Anxious around clippers' },
                        { name: 'Charlie', breed: 'Poodle', age: 5, notes: 'Very calm' }
                    ]
                }
            ];

            // Sample appointments
            const today = new Date();
            appointments = [
                {
                    id: 1,
                    clientId: 1,
                    pets: [{ name: 'Max', items: [{ id: 1, type: 'service' }] }],
                    date: new Date(today.getFullYear(), today.getMonth(), today.getDate(), 10, 0),
                    status: 'confirmed',
                    notes: 'First time client'
                },
                {
                    id: 2,
                    clientId: 2,
                    pets: [{ name: 'Luna', items: [{ id: 2, type: 'service' }] }],
                    date: new Date(today.getFullYear(), today.getMonth(), today.getDate(), 14, 0),
                    status: 'confirmed',
                    notes: ''
                }
            ];

            // Sample waitlist
            waitlist = [];

            updateHeaderLogo();
            renderWeekTimeline();
            renderCalendar();
            renderClients();
            renderServices();
            renderWaitlist();
            updateMonthYearDisplay();
        }

        // Month View Toggle
        function toggleMonthView() {
            const monthView = document.getElementById('monthViewCollapse');
            monthView.classList.toggle('hidden');
        }

        function updateMonthYearDisplay() {
            const monthYear = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('currentMonthYear').textContent = monthYear;
        }

        // Calendar Functions
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            document.getElementById('calendarMonth').textContent =
                currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';

            // Adjust firstDay so Monday = 0, Sunday = 6
            const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;

            // Empty cells for days before month starts
            for (let i = 0; i < adjustedFirstDay; i++) {
                const emptyDay = document.createElement('div');
                calendarDays.appendChild(emptyDay);
            }

            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';

                const date = new Date(year, month, day);
                const hasAppointments = appointments.some(apt =>
                    apt.date.toDateString() === date.toDateString()
                );

                if (hasAppointments) {
                    dayElement.classList.add('has-appointments');
                }

                if (date.toDateString() === selectedDate.toDateString()) {
                    dayElement.classList.add('selected');
                }

                dayElement.innerHTML = `
                    <span class="text-sm font-semibold">${day}</span>
                    ${hasAppointments ? '<div class="w-1 h-1 rounded-full mt-1" style="background: var(--accent-primary);"></div>' : ''}
                `;

                dayElement.onclick = () => {
                    selectedDate = date;
                    weekStartDate = getWeekStart(date);
                    renderCalendar();
                    renderWeekTimeline();
                };

                calendarDays.appendChild(dayElement);
            }
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
            updateMonthYearDisplay();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
            updateMonthYearDisplay();
        }

        // Week Timeline Functions
        function renderWeekTimeline() {
            renderWeekNavigation();
            renderDayTimeline();
        }

        function renderWeekNavigation() {
            const container = document.getElementById('weekDaysNav');
            container.innerHTML = '';

            const weekEnd = new Date(weekStartDate);
            weekEnd.setDate(weekEnd.getDate() + 6);

            document.getElementById('weekRange').textContent =
                `${weekStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;

            const today = new Date();
            const dayLabels = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStartDate);
                dayDate.setDate(dayDate.getDate() + i);

                const dayItem = document.createElement('div');
                dayItem.className = 'week-day-item';

                if (dayDate.toDateString() === today.toDateString()) {
                    dayItem.classList.add('today');
                }

                if (dayDate.toDateString() === selectedDate.toDateString()) {
                    dayItem.classList.add('selected');
                }

                dayItem.innerHTML = `
                    <div class="week-day-label">${dayLabels[i]}</div>
                    <div class="week-day-number">${dayDate.getDate()}</div>
                `;

                dayItem.onclick = () => {
                    selectedDate = new Date(dayDate);
                    renderWeekNavigation();
                    renderDayTimeline();
                };

                container.appendChild(dayItem);
            }

            // Setup swipe after rendering
            setupWeekSwipe();
        }

        function renderDayTimeline() {
            const container = document.getElementById('dayTimeline');
            container.innerHTML = '';

            // Apply zoom level
            const hourHeight = BASE_HOUR_HEIGHT * timelineZoom;
            container.style.setProperty('--hour-height', `${hourHeight}px`);

            // Set container height to accommodate all hours and absolute positioned appointments
            const totalHeight = 24 * hourHeight;
            container.style.minHeight = `${totalHeight}px`;

            // Create timeline for 24 hours (0-23)
            for (let hour = 0; hour < 24; hour++) {
                const hourDiv = document.createElement('div');
                hourDiv.className = 'timeline-hour';
                hourDiv.dataset.hour = hour;

                const hourLabel = document.createElement('div');
                hourLabel.className = 'timeline-hour-label';

                if (settings.use24HourClock) {
                    hourLabel.textContent = `${hour.toString().padStart(2, '0')}:00`;
                } else {
                    const period = hour >= 12 ? 'PM' : 'AM';
                    const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                    hourLabel.textContent = `${displayHour} ${period}`;
                }

                // Click to create appointment
                hourDiv.onclick = (e) => {
                    if (e.target === hourDiv || e.target === hourLabel) {
                        createAppointmentAtTime(hour, 0);
                    }
                };

                hourDiv.appendChild(hourLabel);
                container.appendChild(hourDiv);
            }

            // Add appointments for selected day
            const dayAppointments = appointments.filter(apt =>
                apt.date.toDateString() === selectedDate.toDateString()
            );

            // Calculate overlap groups for side-by-side display
            const currentHourHeight = BASE_HOUR_HEIGHT * timelineZoom;
            const overlapGroups = calculateOverlapGroups(dayAppointments, currentHourHeight);

            dayAppointments.forEach(apt => {
                const client = clients.find(c => c.id === apt.clientId);
                const hour = apt.date.getHours();
                const minute = apt.date.getMinutes();

                const petNames = apt.pets.map(p => p.name).join(', ');

                // Get services for display
                const serviceNames = apt.pets.flatMap(p =>
                    p.items.map(item => {
                        const serviceOrItem = [...services, ...items].find(s => s.id === item.id && s.type === item.type);
                        return serviceOrItem?.name || '';
                    })
                ).filter(name => name).join(', ');

                const totalMinutes = apt.pets.reduce((sum, pet) => {
                    return sum + pet.items.reduce((itemSum, item) => {
                        const serviceOrItem = [...services, ...items].find(s => s.id === item.id && s.type === item.type);
                        return itemSum + (serviceOrItem?.duration || 0);
                    }, 0);
                }, 0);

                // Calculate position within the hour row
                const minuteOffset = (minute * hourHeight / 60);
                // Increase minimum height to accommodate all content
                const calculatedHeight = (totalMinutes * hourHeight / 60);
                const minHeight = (serviceNames ? 100 : 60) * timelineZoom;
                const height = Math.max(calculatedHeight, minHeight);

                // Get overlap info for this appointment
                const overlapInfo = overlapGroups.get(apt.id) || { index: 0, total: 1 };
                const widthPercent = 100 / overlapInfo.total;
                const leftOffset = 3.5; // rem for the hour label
                const availableWidth = `calc(100% - 4rem)`; // Total width minus label and padding
                const aptWidth = `calc(${availableWidth} * ${widthPercent / 100})`;
                const aptLeft = `calc(3.5rem + ${availableWidth} * ${(overlapInfo.index * widthPercent) / 100})`;

                const aptDiv = document.createElement('div');
                let aptClass = 'timeline-appointment';
                if (apt.status === 'completed') {
                    aptClass += ' completed';
                } else if (apt.status === 'cancelled') {
                    aptClass += ' cancelled';
                } else if (apt.isRecurring) {
                    aptClass += ' recurring';
                }
                aptDiv.className = aptClass;
                // Position relative to the hour row, with overlap handling
                aptDiv.style.cssText = `position: absolute; top: ${minuteOffset}px; height: ${height}px; left: ${aptLeft}; width: ${aptWidth}; z-index: 10;`;
                aptDiv.dataset.aptId = apt.id;
                aptDiv.dataset.hour = hour;

                aptDiv.innerHTML = `
                    <div class="timeline-appointment-title">${client?.name || 'Unknown'}</div>
                    <div class="text-xs opacity-90">${formatTime(apt.date)}</div>
                    <div class="text-xs opacity-80 truncate"><i class="fas fa-dog mr-1"></i>${petNames}</div>
                    ${serviceNames ? `<div class="text-xs opacity-70 truncate"><i class="fas fa-scissors mr-1"></i>${serviceNames}</div>` : ''}
                `;

                // Make appointment draggable
                makeDraggable(aptDiv, apt.id);

                // Find the hour row and append the appointment to it
                const hourRow = container.querySelector(`[data-hour="${hour}"]`);
                if (hourRow) {
                    hourRow.appendChild(aptDiv);
                } else {
                    container.appendChild(aptDiv);
                }
            });

            // Add current time indicator if viewing today
            addCurrentTimeIndicator();

            // Auto-scroll to current time if viewing today
            scrollToCurrentTime();
        }

        function addCurrentTimeIndicator() {
            const now = new Date();
            const isToday = selectedDate.toDateString() === now.toDateString();
            const container = document.getElementById('dayTimeline');

            // Remove existing indicator
            const existing = container.querySelector('.current-time-line');
            if (existing) existing.remove();

            if (!isToday) return;

            const hourHeight = BASE_HOUR_HEIGHT * timelineZoom;
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const topPosition = (currentHour * hourHeight) + (currentMinute * hourHeight / 60);

            const timeString = settings.use24HourClock
                ? `${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`
                : `${currentHour > 12 ? currentHour - 12 : (currentHour === 0 ? 12 : currentHour)}:${currentMinute.toString().padStart(2, '0')}`;

            const timeLine = document.createElement('div');
            timeLine.className = 'current-time-line';
            timeLine.style.top = `${topPosition}px`;
            timeLine.innerHTML = `<span class="current-time-label">${timeString}</span>`;

            container.appendChild(timeLine);
        }

        // Update current time indicator every minute
        setInterval(function() {
            const scheduleView = document.getElementById('scheduleView');
            if (scheduleView && !scheduleView.classList.contains('hidden')) {
                addCurrentTimeIndicator();
            }
        }, 60000); // Update every minute

        // Calculate which appointments overlap and assign them columns
        function calculateOverlapGroups(dayAppointments, hourHeight) {
            const overlapMap = new Map();
            if (!dayAppointments || dayAppointments.length === 0) return overlapMap;

            // Calculate start/end times in minutes for each appointment
            const aptTimes = dayAppointments.map(apt => {
                const startMinutes = apt.date.getHours() * 60 + apt.date.getMinutes();
                let duration = 60; // Default
                if (apt.pets && apt.pets.length > 0) {
                    duration = apt.pets.reduce((sum, pet) => {
                        if (!pet.items) return sum;
                        return sum + pet.items.reduce((itemSum, item) => {
                            const allServices = [...(services || []), ...(items || [])];
                            const serviceOrItem = allServices.find(s => s.id === item.id && s.type === item.type);
                            return itemSum + (serviceOrItem?.duration || 60);
                        }, 0);
                    }, 0) || 60;
                }
                return {
                    id: apt.id,
                    start: startMinutes,
                    end: startMinutes + Math.max(duration, 30)
                };
            });

            // Sort by start time
            aptTimes.sort((a, b) => a.start - b.start);

            // Find overlapping groups
            const columns = [];
            aptTimes.forEach(apt => {
                let placed = false;
                for (let col = 0; col < columns.length; col++) {
                    const lastInCol = columns[col][columns[col].length - 1];
                    if (apt.start >= lastInCol.end) {
                        columns[col].push(apt);
                        placed = true;
                        break;
                    }
                }
                if (!placed) {
                    columns.push([apt]);
                }
            });

            // Assign column info to each appointment
            const totalColumns = columns.length;
            columns.forEach((col, colIndex) => {
                col.forEach(apt => {
                    overlapMap.set(apt.id, { index: colIndex, total: totalColumns });
                });
            });

            return overlapMap;
        }

        function scrollToCurrentTime() {
            setTimeout(function() {
                // Try to scroll to the current time line if it exists
                const timeLine = document.querySelector('.current-time-line');
                if (timeLine) {
                    timeLine.scrollIntoView({ block: 'center', behavior: 'auto' });
                    return;
                }

                // Fallback: scroll to appropriate hour
                const now = new Date();
                const isToday = selectedDate.toDateString() === now.toDateString();
                const hourHeight = BASE_HOUR_HEIGHT * timelineZoom;
                let targetHour = 8; // Default to 8 AM

                if (isToday) {
                    targetHour = now.getHours();
                } else {
                    const dayAppointments = appointments.filter(apt =>
                        apt.date.toDateString() === selectedDate.toDateString()
                    );
                    if (dayAppointments.length > 0) {
                        targetHour = dayAppointments.reduce((min, apt) =>
                            apt.date.getHours() < min ? apt.date.getHours() : min, 24);
                    }
                }

                // Find the hour row and scroll to it
                const hourRow = document.querySelector(`[data-hour="${Math.max(0, targetHour - 1)}"]`);
                if (hourRow) {
                    hourRow.scrollIntoView({ block: 'start', behavior: 'auto' });
                }
            }, 300);
        }

        function createAppointmentAtTime(hour, minute) {
            const appointmentDate = new Date(selectedDate);
            appointmentDate.setHours(hour, minute, 0, 0);

            openNewAppointmentModal();

            // Pre-fill the date and time
            setTimeout(() => {
                document.getElementById('aptDate').value = selectedDate.toISOString().split('T')[0];
                document.getElementById('aptTime').value = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            }, 100);
        }

        let dragState = {
            isDragging: false,
            element: null,
            aptId: null,
            startY: 0,
            startTop: 0
        };

        function makeDraggable(element, aptId) {
            let longPressTimer;
            let startY;
            let startTop;
            let hasMoved = false;
            let isDragMode = false;
            let handlers = { move: null, end: null };

            const cleanup = () => {
                if (handlers.move) {
                    document.removeEventListener('mousemove', handlers.move);
                    document.removeEventListener('touchmove', handlers.move);
                }
                if (handlers.end) {
                    document.removeEventListener('mouseup', handlers.end);
                    document.removeEventListener('touchend', handlers.end);
                }
                handlers = { move: null, end: null };
            };

            const onStart = (e) => {
                // Prevent if already dragging something else
                if (dragState.isDragging && dragState.element !== element) {
                    return;
                }

                hasMoved = false;
                isDragMode = false;
                const touch = e.type.includes('touch') ? e.touches[0] : e;
                startY = touch.clientY;
                startTop = parseInt(element.style.top);

                // Long press detection for touch devices
                if (e.type.includes('touch')) {
                    longPressTimer = setTimeout(() => {
                        startDrag();
                    }, 300);
                }
                // For mouse, don't start drag immediately - wait for movement

                // Create move/end handlers
                handlers.move = onMove;
                handlers.end = onEnd;

                document.addEventListener('mousemove', handlers.move);
                document.addEventListener('mouseup', handlers.end);
                document.addEventListener('touchmove', handlers.move, { passive: false });
                document.addEventListener('touchend', handlers.end);
            };

            const startDrag = () => {
                isDragMode = true;
                dragState.isDragging = true;
                dragState.element = element;
                dragState.aptId = aptId;
                dragState.startY = startY;
                dragState.startTop = startTop;
                element.classList.add('dragging');
            };

            const onMove = (e) => {
                const touch = e.type.includes('touch') ? e.touches[0] : e;
                const moveDistance = Math.abs(touch.clientY - startY);

                // Detect movement to start drag or cancel long press
                if (!isDragMode) {
                    if (moveDistance > 5) {
                        if (e.type.includes('touch')) {
                            hasMoved = true;
                            clearTimeout(longPressTimer);
                        } else {
                            // For mouse, start dragging after movement threshold
                            startDrag();
                        }
                    }
                }

                if (!dragState.isDragging || dragState.element !== element) return;

                e.preventDefault();
                const deltaY = touch.clientY - dragState.startY;
                const newTop = dragState.startTop + deltaY;

                element.style.top = `${Math.max(0, Math.min(newTop, 1440 - parseInt(element.style.height)))}px`;
            };

            const onEnd = (e) => {
                clearTimeout(longPressTimer);
                cleanup();

                const wasDragging = dragState.isDragging && dragState.element === element;

                if (wasDragging) {
                    element.classList.remove('dragging');

                    // Calculate new time based on position (60px per hour for 24 hours)
                    const finalTop = parseInt(element.style.top);
                    const totalMinutes = (finalTop / 60) * 60;
                    const newHour = Math.floor(totalMinutes / 60);
                    const newMinute = Math.round(totalMinutes % 60);

                    // Snap to 15-minute intervals
                    const snappedMinute = Math.round(newMinute / 15) * 15;

                    updateAppointmentTime(aptId, newHour, snappedMinute === 60 ? 0 : snappedMinute);

                    dragState.isDragging = false;
                    dragState.element = null;
                } else {
                    // If not dragging, treat as click
                    if (!hasMoved) {
                        openAppointmentDetails(aptId);
                    }
                }

                isDragMode = false;
                hasMoved = false;
            };

            // Only add the initial event listeners
            element.addEventListener('mousedown', onStart);
            element.addEventListener('touchstart', onStart, { passive: true });
        }

        function updateAppointmentTime(aptId, hour, minute) {
            const apt = appointments.find(a => a.id === aptId);
            if (!apt) return;

            const newDate = new Date(selectedDate);
            newDate.setHours(hour, minute, 0, 0);

            apt.date = newDate;

            renderDayTimeline();
            renderCalendar();
            showAlert('Appointment rescheduled successfully!');
        }

        function openAppointmentDetails(aptId) {
            console.log('Opening appointment details for ID:', aptId);
            const apt = appointments.find(a => a.id === aptId);
            if (!apt) {
                console.error('Appointment not found:', aptId);
                return;
            }

            const client = clients.find(c => c.id === apt.clientId);
            if (!client) {
                console.error('Client not found for appointment:', aptId);
                return;
            }

            const aptDate = new Date(apt.date);
            const dateStr = aptDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            const timeStr = formatTime(aptDate);

            const servicesText = apt.pets.map(pet => {
                const serviceNames = pet.items.map(item => {
                    const svc = item.type === 'service' ?
                        services.find(s => s.id === item.id) :
                        items.find(i => i.id === item.id);
                    return svc ? svc.name : '';
                }).filter(s => s).join(', ');
                return `${pet.name}: ${serviceNames}`;
            }).join('<br>');

            const statusColors = {
                pending: 'var(--warning)',
                confirmed: 'var(--accent-primary)',
                completed: 'var(--success)',
                cancelled: 'var(--danger)'
            };

            // Get past and future appointments for this client
            const now = new Date();
            const clientAppointments = appointments
                .filter(a => a.clientId === client.id && a.id !== apt.id)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            const pastAppointments = clientAppointments.filter(a => new Date(a.date) < now);
            const futureAppointments = clientAppointments.filter(a => new Date(a.date) >= now);

            const appointmentHistoryHTML = `
                <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                    <div class="font-semibold mb-3">Appointment History</div>

                    ${futureAppointments.length > 0 ? `
                        <div class="mb-3">
                            <div class="text-sm font-semibold mb-2" style="color: var(--accent-primary);">Future Appointments (${futureAppointments.length})</div>
                            <div class="space-y-2">
                                ${futureAppointments.slice(0, 3).map(a => {
                                    const aDate = new Date(a.date);
                                    return `
                                        <div class="text-xs p-2 rounded cursor-pointer hover:bg-opacity-50" style="background: var(--bg-primary);" onclick="this.closest('.modal-overlay').remove(); openAppointmentDetails(${a.id})">
                                            <div class="font-semibold">${aDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at ${formatTime(aDate)}</div>
                                            <div style="color: var(--text-tertiary);">${a.pets.map(p => p.name).join(', ')} - ${a.status}</div>
                                        </div>
                                    `;
                                }).join('')}
                                ${futureAppointments.length > 3 ? `<div class="text-xs text-center" style="color: var(--text-tertiary);">+${futureAppointments.length - 3} more</div>` : ''}
                            </div>
                        </div>
                    ` : ''}

                    ${pastAppointments.length > 0 ? `
                        <div>
                            <div class="text-sm font-semibold mb-2" style="color: var(--text-secondary);">Past Appointments (${pastAppointments.length})</div>
                            <div class="space-y-2">
                                ${pastAppointments.slice(-3).reverse().map(a => {
                                    const aDate = new Date(a.date);
                                    return `
                                        <div class="text-xs p-2 rounded cursor-pointer hover:bg-opacity-50" style="background: var(--bg-primary);" onclick="this.closest('.modal-overlay').remove(); openAppointmentDetails(${a.id})">
                                            <div class="font-semibold">${aDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at ${formatTime(aDate)}</div>
                                            <div style="color: var(--text-tertiary);">${a.pets.map(p => p.name).join(', ')} - ${a.status}</div>
                                        </div>
                                    `;
                                }).join('')}
                                ${pastAppointments.length > 3 ? `<div class="text-xs text-center" style="color: var(--text-tertiary);">+${pastAppointments.length - 3} more</div>` : ''}
                            </div>
                        </div>
                    ` : ''}

                    ${pastAppointments.length === 0 && futureAppointments.length === 0 ? `
                        <div class="text-sm text-center py-2" style="color: var(--text-tertiary);">No other appointments</div>
                    ` : ''}
                </div>
            `;

            // Calculate total cost
            let totalCost = 0;
            const costBreakdown = apt.pets.map(pet => {
                const petCosts = pet.items.map(item => {
                    const svc = item.type === 'service' ?
                        services.find(s => s.id === item.id) :
                        items.find(i => i.id === item.id);
                    const price = svc ? svc.price : 0;
                    totalCost += price;
                    return { name: svc?.name || 'Unknown', price };
                });
                return { petName: pet.name, items: petCosts };
            });

            const content = `
                <div class="space-y-4">
                    <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                        <div class="flex justify-between items-center mb-3">
                            <div class="text-lg font-bold cursor-pointer hover:opacity-70" onclick="this.closest('.modal-overlay').remove(); showClientDetails(${client.id});" style="color: var(--accent-primary); text-decoration: underline;">
                                ${client.name}
                            </div>
                            <div class="text-xs px-3 py-1 rounded font-semibold" style="background: ${statusColors[apt.status]}; color: white; text-transform: uppercase;">${apt.status}</div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div><i class="fas fa-calendar mr-2" style="color: var(--accent-primary);"></i>${dateStr}</div>
                            <div><i class="fas fa-clock mr-2" style="color: var(--accent-primary);"></i>${timeStr}</div>
                            ${apt.notes ? `<div class="mt-3 pt-3 border-t" style="border-color: var(--border);"><i class="fas fa-note-sticky mr-2" style="color: var(--accent-primary);"></i>${apt.notes}</div>` : ''}
                        </div>
                    </div>

                    <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                        <div class="font-semibold mb-3">Services & Costs</div>
                        ${costBreakdown.map(pet => `
                            <div class="mb-3">
                                <div class="font-semibold text-sm mb-2" style="color: var(--accent-primary);"><i class="fas fa-paw mr-2"></i>${pet.petName}</div>
                                ${pet.items.map(item => `
                                    <div class="flex justify-between text-sm mb-1 pl-6">
                                        <span>${item.name}</span>
                                        <span class="font-semibold">$${item.price.toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `).join('')}
                        <div class="border-t pt-3 mt-3 flex justify-between items-center" style="border-color: var(--border);">
                            <span class="font-bold text-lg">Total</span>
                            <span class="font-bold text-xl" style="color: var(--accent-primary);">$${totalCost.toFixed(2)}</span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Update Status</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="updateAppointmentStatus(${apt.id}, 'pending')" class="btn ${apt.status === 'pending' ? 'btn-primary' : 'btn-secondary'} btn-sm">
                                <i class="fas fa-clock mr-2"></i>Pending
                            </button>
                            <button onclick="updateAppointmentStatus(${apt.id}, 'confirmed')" class="btn ${apt.status === 'confirmed' ? 'btn-primary' : 'btn-secondary'} btn-sm">
                                <i class="fas fa-check mr-2"></i>Confirmed
                            </button>
                            <button onclick="updateAppointmentStatus(${apt.id}, 'completed')" class="btn ${apt.status === 'completed' ? 'btn-primary' : 'btn-secondary'} btn-sm">
                                <i class="fas fa-check-double mr-2"></i>Completed
                            </button>
                            <button onclick="updateAppointmentStatus(${apt.id}, 'cancelled')" class="btn ${apt.status === 'cancelled' ? 'btn-primary' : 'btn-secondary'} btn-sm">
                                <i class="fas fa-xmark mr-2"></i>Cancelled
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Close</button>
                <button onclick="this.closest('.modal-overlay').remove(); editAppointment(${apt.id})" class="btn btn-secondary">
                    <i class="fas fa-edit mr-2"></i>Edit
                </button>
                <button onclick="exportAppointmentToCalendar(${apt.id})" class="btn btn-secondary">
                    <i class="fas fa-calendar-plus mr-2"></i>Export
                </button>
                <button onclick="showSmsOptionsModal(${apt.id})" class="btn btn-secondary">
                    <i class="fas fa-message mr-2"></i>Send SMS
                </button>
                ${apt.status !== 'completed' && apt.status !== 'cancelled' ? `
                <button onclick="openCheckoutModal(${apt.id})" class="btn btn-primary">
                    <i class="fas fa-cash-register mr-2"></i>Check Out
                </button>
                ` : apt.status === 'completed' && apt.checkout ? `
                <button onclick="this.closest('.modal-overlay').remove(); viewCheckoutDetails(${apt.id})" class="btn btn-secondary">
                    <i class="fas fa-receipt mr-2"></i>View Receipt
                </button>
                ` : apt.status === 'completed' ? `
                <button onclick="openCheckoutModal(${apt.id})" class="btn btn-primary">
                    <i class="fas fa-cash-register mr-2"></i>Add Payment
                </button>
                ` : ''}
            `;

            showModal('Appointment Details', content, buttons);
        }

        function editAppointment(aptId) {
            const apt = appointments.find(a => a.id === aptId);
            if (!apt) return;

            const client = clients.find(c => c.id === apt.clientId);
            if (!client) return;

            // Build the edit form similar to new appointment but pre-filled
            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="block mb-2 font-semibold" style="color: var(--text-primary);">Client</label>
                        <select id="editAptClient" onchange="updateEditPetSelectionOptions()" class="w-full p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 1.125rem;">
                            ${clients.map(c => `<option value="${c.id}" ${c.id === client.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div id="editPetSelection"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block mb-2 font-semibold" style="color: var(--text-primary);">Date</label>
                            <input type="date" id="editAptDate" value="${apt.date.toISOString().split('T')[0]}" class="w-full p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 1.125rem;">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold" style="color: var(--text-primary);">Time</label>
                            <input type="time" id="editAptTime" value="${apt.date.toTimeString().slice(0,5)}" class="w-full p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 1.125rem;">
                        </div>
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold" style="color: var(--text-primary);">Notes</label>
                        <textarea id="editAptNotes" rows="3" class="w-full p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 1.125rem;">${apt.notes || ''}</textarea>
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
                <button onclick="saveAppointmentEdit(${aptId})" class="btn btn-primary">Save Changes</button>
            `;

            showModal('Edit Appointment', content, buttons);

            // Initialize pet selection
            setTimeout(() => {
                updateEditPetSelectionOptions(apt);
            }, 100);
        }

        function updateEditPetSelectionOptions(existingApt = null) {
            const clientId = parseInt(document.getElementById('editAptClient').value);
            const client = clients.find(c => c.id === clientId);
            const container = document.getElementById('editPetSelection');

            if (!client || !client.pets || client.pets.length === 0) {
                container.innerHTML = '<p class="text-sm" style="color: var(--text-tertiary);">This client has no pets. Please add pets to the client first.</p>';
                return;
            }

            container.innerHTML = `
                <div>
                    <label class="block mb-2 font-semibold" style="color: var(--text-primary);">Select Pets & Services</label>
                    ${client.pets.map((pet, idx) => {
                        const existingPet = existingApt?.pets.find(p => p.name === pet.name);
                        const isChecked = existingPet ? 'checked' : '';
                        return `
                            <div class="p-3 mb-3 rounded-lg" style="background: var(--bg-tertiary);">
                                <label class="flex items-center mb-2">
                                    <input type="checkbox" id="editPet${idx}" value="${pet.name}" ${isChecked} onchange="toggleEditPetServices(${idx})" class="mr-3" style="width: 1.25rem; height: 1.25rem;">
                                    <span class="font-semibold">${pet.name} (${pet.breed})</span>
                                </label>
                                <div id="editPetServices${idx}" class="ml-6 ${isChecked ? '' : 'hidden'}">
                                    ${[...services, ...items].map(svc => {
                                        const existingService = existingPet?.items.find(i => i.id === svc.id && i.type === svc.type);
                                        const svcChecked = existingService ? 'checked' : '';
                                        return `
                                            <label class="flex items-center justify-between py-2">
                                                <div class="flex items-center">
                                                    <input type="checkbox" name="editPet${idx}Service" value="${svc.id}-${svc.type}" ${svcChecked} class="mr-2" style="width: 1rem; height: 1rem;">
                                                    <span class="text-sm">${svc.name}</span>
                                                </div>
                                                <span class="text-sm font-semibold">$${svc.price}</span>
                                            </label>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function toggleEditPetServices(idx) {
            const checkbox = document.getElementById(`editPet${idx}`);
            const services = document.getElementById(`editPetServices${idx}`);
            services.classList.toggle('hidden', !checkbox.checked);
        }

        function saveAppointmentEdit(aptId) {
            const apt = appointments.find(a => a.id === aptId);
            if (!apt) return;

            const clientId = parseInt(document.getElementById('editAptClient').value);
            const date = document.getElementById('editAptDate').value;
            const time = document.getElementById('editAptTime').value;
            const notes = document.getElementById('editAptNotes').value;

            if (!clientId || !date || !time) {
                showAlert('Please fill in all required fields');
                return;
            }

            const client = clients.find(c => c.id === clientId);

            // Get selected pets and services
            const selectedPets = [];
            client.pets.forEach((pet, idx) => {
                const checkbox = document.getElementById(`editPet${idx}`);
                if (checkbox && checkbox.checked) {
                    const serviceCheckboxes = document.querySelectorAll(`input[name="editPet${idx}Service"]:checked`);
                    const items = Array.from(serviceCheckboxes).map(cb => {
                        const [id, type] = cb.value.split('-');
                        return { id: parseInt(id), type };
                    });

                    if (items.length > 0) {
                        selectedPets.push({
                            name: pet.name,
                            items: items
                        });
                    }
                }
            });

            if (selectedPets.length === 0) {
                showAlert('Please select at least one pet and service');
                return;
            }

            // Update appointment
            const [year, month, day] = date.split('-').map(Number);
            const [hours, minutes] = time.split(':').map(Number);
            const appointmentDate = new Date(year, month - 1, day, hours, minutes);

            // Check if date changed to navigate to new week
            const oldDate = new Date(apt.date);
            const dateChanged = oldDate.toDateString() !== appointmentDate.toDateString();

            apt.clientId = clientId;
            apt.date = appointmentDate;
            apt.pets = selectedPets;
            apt.notes = notes;

            document.querySelector('.modal-overlay').remove();

            // If date changed, navigate to the new week
            if (dateChanged) {
                // Set the week to show the new appointment date
                const newDate = new Date(appointmentDate);
                const dayOfWeek = newDate.getDay();
                const weekStart = new Date(newDate);
                weekStart.setDate(newDate.getDate() - dayOfWeek);
                weekStartDate = weekStart;
                selectedDate = new Date(appointmentDate);
                updateMonthYearDisplay();
            }

            renderWeekTimeline();
            renderCalendar();
            showAlert('Appointment updated successfully!');
        }

        // Store added items for checkout
        window.checkoutAddedItems = [];

        function openCheckoutModal(aptId) {
            // First close any existing modal
            var existingModal = document.querySelector('.modal-overlay');
            if (existingModal) {
                existingModal.remove();
            }

            // Store for later
            window.checkoutAptId = aptId;
            window.checkoutAddedItems = [];

            renderCheckoutScreen();
        }

        function renderCheckoutScreen() {
            var aptId = window.checkoutAptId;
            var apt = appointments.find(function(a) { return a.id === aptId; });
            if (!apt) return;

            var client = clients.find(function(c) { return c.id === apt.clientId; });
            if (!client) return;

            // Calculate total from appointment items
            var totalCost = 0;
            var servicesHtml = '';

            for (var i = 0; i < apt.pets.length; i++) {
                var pet = apt.pets[i];
                servicesHtml += '<div class="mb-2"><span class="font-medium" style="color: var(--accent-primary);">' + pet.name + '</span></div>';
                for (var j = 0; j < pet.items.length; j++) {
                    var item = pet.items[j];
                    var svc = null;
                    if (item.type === 'service') {
                        svc = services.find(function(s) { return s.id === item.id; });
                    } else {
                        svc = items.find(function(s) { return s.id === item.id; });
                    }
                    if (svc) {
                        totalCost += svc.price;
                        servicesHtml += '<div class="flex justify-between ml-4 mb-1"><span>' + svc.name + '</span><span>$' + svc.price.toFixed(2) + '</span></div>';
                    }
                }
            }

            // Add any extra items added during checkout
            if (window.checkoutAddedItems.length > 0) {
                servicesHtml += '<div class="mt-3 pt-3 border-t" style="border-color: var(--border);"><span class="font-medium" style="color: var(--accent-primary);">Added Items</span></div>';
                for (var k = 0; k < window.checkoutAddedItems.length; k++) {
                    var addedItem = window.checkoutAddedItems[k];
                    totalCost += addedItem.price;
                    servicesHtml += '<div class="flex justify-between ml-4 mb-1"><span>' + addedItem.name + '</span><span>$' + addedItem.price.toFixed(2) + ' <button onclick="removeCheckoutItem(' + k + ')" class="text-red-500 ml-2"><i class="fas fa-times"></i></button></span></div>';
                }
            }

            window.checkoutTotal = totalCost;

            // Build services/items dropdown for adding
            var allServicesItems = services.concat(items);
            var addItemOptions = '<option value="">-- Select to add --</option>';
            for (var m = 0; m < allServicesItems.length; m++) {
                var si = allServicesItems[m];
                addItemOptions += '<option value="' + si.id + '-' + si.type + '">' + si.name + ' ($' + si.price.toFixed(2) + ')</option>';
            }

            var html = '<div class="space-y-4">';
            html += '<div class="p-4 rounded-lg text-center" style="background: var(--bg-tertiary);">';
            html += '<i class="fas fa-cash-register text-4xl mb-2" style="color: var(--accent-primary);"></i>';
            html += '<div class="text-2xl font-bold">' + client.name + '</div>';
            html += '</div>';

            // Services list
            html += '<div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">';
            html += '<div class="font-semibold mb-3">Services & Items</div>';
            html += servicesHtml;
            html += '<div class="border-t pt-3 mt-3 flex justify-between" style="border-color: var(--border);">';
            html += '<span class="font-bold text-xl">Total</span>';
            html += '<span class="font-bold text-2xl" style="color: var(--accent-primary);">$' + totalCost.toFixed(2) + '</span>';
            html += '</div></div>';

            // Add item section
            html += '<div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">';
            html += '<label class="font-semibold mb-2 block">Add Last-Minute Item</label>';
            html += '<select id="addItemSelect" onchange="addCheckoutItem()" class="w-full p-3 rounded-lg" style="background: var(--bg-secondary); color: var(--text-primary); border: 1.5px solid var(--border); font-size: 16px;">';
            html += addItemOptions;
            html += '</select>';
            html += '</div>';

            // Payment method
            html += '<div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">';
            html += '<label class="font-semibold mb-2 block">Payment Method</label>';
            html += '<select id="checkoutPayment" class="w-full p-3 rounded-lg border" style="background: var(--bg-secondary); color: var(--text-primary);">';
            html += '<option value="cash">Cash</option>';
            html += '<option value="card">Card</option>';
            html += '<option value="digital">Digital</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';

            var buttons = '<button onclick="this.closest(\'.modal-overlay\').remove()" class="btn btn-secondary">Cancel</button>';
            buttons += '<button onclick="finishCheckout()" class="btn btn-primary"><i class="fas fa-check mr-2"></i>Complete</button>';

            // Update or create modal
            var existingModal = document.querySelector('.modal-overlay');
            if (existingModal) {
                existingModal.remove();
            }
            showModal('Check Out', html, buttons);
        }

        function addCheckoutItem() {
            var select = document.getElementById('addItemSelect');
            if (!select || !select.value) return;

            var parts = select.value.split('-');
            var itemId = parseInt(parts[0]);
            var itemType = parts[1];

            var svc = null;
            if (itemType === 'service') {
                svc = services.find(function(s) { return s.id === itemId; });
            } else {
                svc = items.find(function(s) { return s.id === itemId; });
            }

            if (svc) {
                window.checkoutAddedItems.push({
                    id: svc.id,
                    type: svc.type,
                    name: svc.name,
                    price: svc.price
                });
                renderCheckoutScreen();
                showNotification(svc.name + ' added - $' + svc.price.toFixed(2));
            }
        }

        function removeCheckoutItem(index) {
            window.checkoutAddedItems.splice(index, 1);
            renderCheckoutScreen();
        }

        function finishCheckout() {
            var aptId = window.checkoutAptId;
            var totalCost = window.checkoutTotal;
            var apt = appointments.find(function(a) { return a.id === aptId; });
            if (!apt) return;

            var payment = document.getElementById('checkoutPayment');
            var paymentMethod = payment ? payment.value : 'cash';

            // Add any last-minute items to the appointment
            if (window.checkoutAddedItems.length > 0) {
                // Add to first pet or create a general entry
                if (apt.pets.length > 0) {
                    for (var i = 0; i < window.checkoutAddedItems.length; i++) {
                        var addedItem = window.checkoutAddedItems[i];
                        apt.pets[0].items.push({
                            id: addedItem.id,
                            type: addedItem.type
                        });
                    }
                }
            }

            apt.checkout = {
                timestamp: new Date(),
                paymentMethod: paymentMethod,
                total: totalCost,
                addedItems: window.checkoutAddedItems.slice()
            };
            apt.status = 'completed';

            // Clear added items
            window.checkoutAddedItems = [];

            // Close modal and return to calendar
            var modal = document.querySelector('.modal-overlay');
            if (modal) modal.remove();

            renderWeekTimeline();
            renderCalendar();
            showNotification('Check out completed! $' + totalCost.toFixed(2) + ' via ' + paymentMethod);
        }

        function viewCheckoutDetails(aptId) {
            var apt = appointments.find(function(a) { return a.id === aptId; });
            if (!apt || !apt.checkout) {
                showNotification('No checkout information found');
                return;
            }

            var client = clients.find(function(c) { return c.id === apt.clientId; });
            if (!client) return;

            // Build services HTML
            var servicesHtml = '';
            for (var i = 0; i < apt.pets.length; i++) {
                var pet = apt.pets[i];
                servicesHtml += '<div class="mb-3"><div class="font-medium mb-2" style="color: var(--accent-primary);"><i class="fas fa-dog mr-2"></i>' + pet.name + '</div>';
                for (var j = 0; j < pet.items.length; j++) {
                    var item = pet.items[j];
                    var svc = null;
                    if (item.type === 'service') {
                        svc = services.find(function(s) { return s.id === item.id; });
                    } else {
                        svc = items.find(function(s) { return s.id === item.id; });
                    }
                    if (svc) {
                        servicesHtml += '<div class="flex justify-between items-center ml-6 mb-2"><span style="color: var(--text-secondary);">' + svc.name + '</span><span class="font-medium">$' + svc.price.toFixed(2) + '</span></div>';
                    }
                }
                servicesHtml += '</div>';
            }

            var checkoutDate = apt.checkout.timestamp ? new Date(apt.checkout.timestamp).toLocaleString() : 'N/A';
            var totalPaid = apt.checkout.total ? apt.checkout.total.toFixed(2) : '0.00';
            var paymentMethod = apt.checkout.paymentMethod || 'cash';

            var html = '<div class="space-y-4">';
            html += '<div class="p-4 rounded-lg text-center" style="background: var(--bg-tertiary);">';
            html += '<i class="fas fa-receipt text-4xl mb-2" style="color: var(--accent-primary);"></i>';
            html += '<div class="text-2xl font-bold">Receipt</div>';
            html += '<div class="text-sm" style="color: var(--text-secondary);">Checked out: ' + checkoutDate + '</div>';
            html += '</div>';

            html += '<div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">';
            html += '<div class="mb-3"><div class="font-semibold" style="color: var(--text-secondary);">Client</div>';
            html += '<div class="text-lg">' + client.name + '</div></div>';
            html += '<div class="mb-3"><div class="font-semibold" style="color: var(--text-secondary);">Appointment Date</div>';
            html += '<div>' + formatDate(apt.date) + ' at ' + formatTime(apt.date) + '</div></div>';
            html += '</div>';

            html += '<div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">';
            html += '<div class="font-semibold mb-3 text-lg">Services</div>';
            html += servicesHtml;
            html += '<div class="border-t pt-3 mt-3 flex justify-between items-center" style="border-color: var(--border);">';
            html += '<span class="font-bold text-xl">Total Paid</span>';
            html += '<span class="font-bold text-2xl" style="color: var(--accent-primary);">$' + totalPaid + '</span>';
            html += '</div></div>';

            html += '<div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">';
            html += '<div class="font-semibold mb-2">Payment Method</div>';
            html += '<div class="capitalize">' + paymentMethod + '</div>';
            html += '</div>';

            // Share options
            html += '<div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">';
            html += '<div class="font-semibold mb-3">Share Invoice</div>';
            html += '<div class="grid grid-cols-3 gap-2">';
            html += '<button onclick="generateInvoicePDF(' + aptId + ', \'download\')" class="btn btn-secondary btn-sm flex flex-col items-center py-3"><i class="fas fa-download text-lg mb-1"></i><span class="text-xs">Download</span></button>';
            html += '<button onclick="shareInvoicePDF(' + aptId + ', \'email\')" class="btn btn-secondary btn-sm flex flex-col items-center py-3"><i class="fas fa-envelope text-lg mb-1"></i><span class="text-xs">Email</span></button>';
            html += '<button onclick="showShareModalJPG(' + aptId + ')" class="btn btn-secondary btn-sm flex flex-col items-center py-3"><i class="fas fa-message text-lg mb-1"></i><span class="text-xs">SMS</span></button>';
            html += '</div>';
            html += '</div>';

            html += '</div>';

            var buttons = '<button onclick="this.closest(\'.modal-overlay\').remove()" class="btn btn-secondary">Close</button>';

            showModal('Receipt', html, buttons);
        }

        function printReceipt(aptId) {
            const apt = appointments.find(a => a.id === aptId);
            if (!apt || !apt.checkout) return;

            const client = clients.find(c => c.id === apt.clientId);

            // Create a printable receipt
            const serviceBreakdown = apt.pets.map(pet => {
                const petServices = pet.items.map(item => {
                    const svc = item.type === 'service' ?
                        services.find(s => s.id === item.id) :
                        items.find(i => i.id === item.id);
                    return `    ${svc?.name || 'Unknown'}: $${(svc?.price || 0).toFixed(2)}`;
                });
                return `  ${pet.petName}:\n${petServices.join('\n')}`;
            });

            const receiptText = `
RECEIPT
===============================

Client: ${client.name}
Date: ${formatDate(apt.date)}
Time: ${formatTime(apt.date)}

SERVICES PROVIDED
-------------------------------
${serviceBreakdown.join('\n\n')}

-------------------------------
TOTAL: $${apt.checkout.total.toFixed(2)}

Payment Method: ${apt.checkout.paymentMethod}
Checked Out: ${new Date(apt.checkout.timestamp).toLocaleString()}

${apt.checkout.notes ? `Notes: ${apt.checkout.notes}\n` : ''}
===============================

Thank you for your business!
            `.trim();

            // Copy to clipboard
            navigator.clipboard.writeText(receiptText).then(() => {
                showAlert('Receipt copied to clipboard!');
            }).catch(() => {
                // Fallback: show receipt in alert
                showAlert('Receipt:\n\n' + receiptText);
            });
        }

        function generateInvoicePDF(aptId, action) {
            var apt = appointments.find(function(a) { return a.id === aptId; });
            if (!apt || !apt.checkout) {
                showNotification('No checkout information found');
                return;
            }

            var client = clients.find(function(c) { return c.id === apt.clientId; });
            if (!client) {
                showNotification('Client not found');
                return;
            }

            // Create PDF using jsPDF
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();

            var pageWidth = doc.internal.pageSize.getWidth();
            var margin = 20;
            var yPos = 20;

            // Invoice number (use appointment ID and timestamp)
            var invoiceNum = 'INV-' + apt.id + '-' + new Date(apt.checkout.timestamp).getTime().toString().slice(-6);

            // Header - Business Name
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(199, 99, 44); // Accent color
            doc.text(settings.businessName || 'Maya Groom Pro', margin, yPos);
            yPos += 10;

            // ABN prominently displayed
            if (settings.abn) {
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(80, 80, 80);
                doc.text('ABN: ' + settings.abn, margin, yPos);
                yPos += 7;
            }

            // Business contact details
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100, 100, 100);
            if (settings.address) {
                doc.text(settings.address, margin, yPos);
                yPos += 5;
            }
            if (settings.phone) {
                doc.text('Phone: ' + settings.phone, margin, yPos);
                yPos += 5;
            }
            if (settings.email) {
                doc.text('Email: ' + settings.email, margin, yPos);
                yPos += 5;
            }

            // Invoice title and number on right side
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(50, 50, 50);
            doc.text('TAX INVOICE', pageWidth - margin, 25, { align: 'right' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(invoiceNum, pageWidth - margin, 32, { align: 'right' });

            yPos += 10;

            // Horizontal line
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 15;

            // Bill To section
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(50, 50, 50);
            doc.text('BILL TO:', margin, yPos);
            yPos += 7;

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.text(client.name, margin, yPos);
            yPos += 5;
            if (client.address) {
                doc.text(client.address, margin, yPos);
                yPos += 5;
            }
            if (client.phone) {
                doc.text(client.phone, margin, yPos);
                yPos += 5;
            }
            if (client.email) {
                doc.text(client.email, margin, yPos);
                yPos += 5;
            }

            // Invoice date on right
            doc.setFont('helvetica', 'bold');
            doc.text('Date:', pageWidth - 70, yPos - 20);
            doc.setFont('helvetica', 'normal');
            doc.text(formatDate(apt.checkout.timestamp), pageWidth - 70, yPos - 15);

            yPos += 15;

            // Services table header
            doc.setFillColor(245, 234, 216);
            doc.rect(margin, yPos - 5, pageWidth - (margin * 2), 10, 'F');
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.setTextColor(50, 50, 50);
            doc.text('Description', margin + 5, yPos + 2);
            doc.text('Amount', pageWidth - margin - 5, yPos + 2, { align: 'right' });
            yPos += 12;

            // Services list
            doc.setFont('helvetica', 'normal');
            var subtotal = 0;

            for (var i = 0; i < apt.pets.length; i++) {
                var pet = apt.pets[i];
                // Pet name as subheader
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(199, 99, 44);
                doc.text(pet.name, margin + 5, yPos);
                yPos += 6;

                doc.setFont('helvetica', 'normal');
                doc.setTextColor(80, 80, 80);

                for (var j = 0; j < pet.items.length; j++) {
                    var item = pet.items[j];
                    var svc = null;
                    if (item.type === 'service') {
                        svc = services.find(function(s) { return s.id === item.id; });
                    } else {
                        svc = items.find(function(s) { return s.id === item.id; });
                    }
                    if (svc) {
                        doc.text('   ' + svc.name, margin + 5, yPos);
                        doc.text('$' + svc.price.toFixed(2), pageWidth - margin - 5, yPos, { align: 'right' });
                        subtotal += svc.price;
                        yPos += 6;
                    }
                }
                yPos += 3;
            }

            yPos += 5;

            // Totals section
            doc.setDrawColor(200, 200, 200);
            doc.line(pageWidth - 80, yPos, pageWidth - margin, yPos);
            yPos += 8;

            doc.setFont('helvetica', 'normal');
            doc.text('Subtotal:', pageWidth - 80, yPos);
            doc.text('$' + subtotal.toFixed(2), pageWidth - margin - 5, yPos, { align: 'right' });
            yPos += 6;

            if (settings.gstEnabled) {
                var gst = subtotal * 0.1;
                doc.text('GST (10%):', pageWidth - 80, yPos);
                doc.text('$' + gst.toFixed(2), pageWidth - margin - 5, yPos, { align: 'right' });
                yPos += 6;
            }

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('TOTAL PAID:', pageWidth - 80, yPos + 3);
            doc.setTextColor(199, 99, 44);
            doc.text('$' + apt.checkout.total.toFixed(2), pageWidth - margin - 5, yPos + 3, { align: 'right' });
            yPos += 15;

            // Payment info
            doc.setTextColor(80, 80, 80);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('Payment Method: ' + apt.checkout.paymentMethod.charAt(0).toUpperCase() + apt.checkout.paymentMethod.slice(1), margin, yPos);
            yPos += 5;
            doc.text('Date Paid: ' + new Date(apt.checkout.timestamp).toLocaleDateString(), margin, yPos);

            // Footer
            yPos = doc.internal.pageSize.getHeight() - 30;
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 8;
            doc.setFontSize(9);
            doc.setTextColor(120, 120, 120);
            doc.text('Thank you for choosing ' + (settings.businessName || 'Maya Groom Pro') + '!', pageWidth / 2, yPos, { align: 'center' });
            yPos += 5;
            doc.text('We appreciate your business.', pageWidth / 2, yPos, { align: 'center' });

            // Generate filename
            var fileName = 'Invoice_' + invoiceNum + '_' + client.name.replace(/\s+/g, '_') + '.pdf';

            // Create PDF blob and file for sharing
            var pdfBlob = doc.output('blob');
            var pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });

            if (action === 'download') {
                // Download the PDF
                doc.save(fileName);
                showNotification('Invoice downloaded!');
            } else if (action === 'share') {
                // Use native Share API to share PDF with attachment
                shareInvoiceNatively(pdfFile, client, invoiceNum, apt);
            } else if (action === 'email') {
                // Use direct mailto: link to pre-fill recipient
                sendEmailWithInvoice(doc, fileName, client, invoiceNum, apt);
            } else if (action === 'sms') {
                // Use direct sms: link to pre-fill recipient
                sendSmsWithInvoice(doc, fileName, client, invoiceNum, apt);
            }
        }

        function shareInvoiceNatively(pdfFile, client, invoiceNum, apt) {
            var firstName = client.name.split(' ')[0];
            var messageText = 'Hi ' + firstName + ', here is your invoice from ' + (settings.businessName || 'Maya Groom Pro') + ' for $' + apt.checkout.total.toFixed(2);

            // Check if Web Share API with files is supported
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                navigator.share({
                    title: 'Invoice ' + invoiceNum,
                    text: messageText,
                    files: [pdfFile]
                }).then(function() {
                    showNotification('Invoice sent to ' + firstName + '!');
                }).catch(function(err) {
                    if (err.name !== 'AbortError') {
                        showNotification('Could not share. Try download instead.');
                    }
                });
            } else {
                // Fallback - download the file
                var url = URL.createObjectURL(pdfFile);
                var a = document.createElement('a');
                a.href = url;
                a.download = pdfFile.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('Share not supported. Invoice downloaded instead.');
            }
        }

        function generateInvoiceImage(aptId, callback) {
            var apt = appointments.find(function(a) { return a.id === aptId; });
            if (!apt || !apt.checkout) {
                showNotification('No checkout information found');
                return;
            }

            var client = clients.find(function(c) { return c.id === apt.clientId; });
            if (!client) {
                showNotification('Client not found');
                return;
            }

            var invoiceNum = 'INV-' + apt.id + '-' + new Date(apt.checkout.timestamp).getTime().toString().slice(-6);
            var firstName = client.name.split(' ')[0];

            // Create canvas for invoice image
            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext('2d');
            var width = 800;
            var height = 1000;
            canvas.width = width;
            canvas.height = height;

            // Background
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, width, height);

            var margin = 50;
            var yPos = 60;

            // Header - Business Name
            ctx.fillStyle = '#C7632C';
            ctx.font = 'bold 32px Arial';
            ctx.fillText(settings.businessName || 'Maya Groom Pro', margin, yPos);
            yPos += 35;

            // ABN
            if (settings.abn) {
                ctx.fillStyle = '#505050';
                ctx.font = 'bold 14px Arial';
                ctx.fillText('ABN: ' + settings.abn, margin, yPos);
                yPos += 20;
            }

            // Contact details
            ctx.fillStyle = '#707070';
            ctx.font = '12px Arial';
            if (settings.address) {
                ctx.fillText(settings.address, margin, yPos);
                yPos += 16;
            }
            if (settings.phone) {
                ctx.fillText('Phone: ' + settings.phone, margin, yPos);
                yPos += 16;
            }
            if (settings.email) {
                ctx.fillText('Email: ' + settings.email, margin, yPos);
                yPos += 16;
            }

            // Invoice title on right
            ctx.fillStyle = '#333333';
            ctx.font = 'bold 28px Arial';
            ctx.textAlign = 'right';
            ctx.fillText('TAX INVOICE', width - margin, 60);
            ctx.font = '14px Arial';
            ctx.fillText(invoiceNum, width - margin, 85);
            ctx.textAlign = 'left';

            yPos += 20;

            // Divider line
            ctx.strokeStyle = '#DDDDDD';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(margin, yPos);
            ctx.lineTo(width - margin, yPos);
            ctx.stroke();
            yPos += 30;

            // Bill To
            ctx.fillStyle = '#333333';
            ctx.font = 'bold 14px Arial';
            ctx.fillText('BILL TO:', margin, yPos);
            yPos += 20;

            ctx.font = '14px Arial';
            ctx.fillText(client.name, margin, yPos);
            yPos += 18;
            if (client.phone) {
                ctx.fillText(client.phone, margin, yPos);
                yPos += 18;
            }
            if (client.email) {
                ctx.fillText(client.email, margin, yPos);
                yPos += 18;
            }

            // Date on right
            ctx.textAlign = 'right';
            ctx.font = 'bold 14px Arial';
            ctx.fillText('Date:', width - margin - 100, yPos - 50);
            ctx.font = '14px Arial';
            ctx.fillText(formatDate(apt.checkout.timestamp), width - margin - 100, yPos - 32);
            ctx.textAlign = 'left';

            yPos += 30;

            // Services header
            ctx.fillStyle = '#F5EAD8';
            ctx.fillRect(margin, yPos - 15, width - margin * 2, 25);
            ctx.fillStyle = '#333333';
            ctx.font = 'bold 12px Arial';
            ctx.fillText('Description', margin + 10, yPos);
            ctx.textAlign = 'right';
            ctx.fillText('Amount', width - margin - 10, yPos);
            ctx.textAlign = 'left';
            yPos += 25;

            // Services list
            var subtotal = 0;
            apt.pets.forEach(function(pet) {
                ctx.fillStyle = '#C7632C';
                ctx.font = 'bold 13px Arial';
                ctx.fillText(pet.name, margin + 10, yPos);
                yPos += 20;

                ctx.fillStyle = '#505050';
                ctx.font = '12px Arial';
                pet.items.forEach(function(item) {
                    var svc = item.type === 'service' ?
                        services.find(function(s) { return s.id === item.id; }) :
                        items.find(function(s) { return s.id === item.id; });
                    if (svc) {
                        ctx.fillText('   ' + svc.name, margin + 10, yPos);
                        ctx.textAlign = 'right';
                        ctx.fillText('$' + svc.price.toFixed(2), width - margin - 10, yPos);
                        ctx.textAlign = 'left';
                        subtotal += svc.price;
                        yPos += 18;
                    }
                });
                yPos += 10;
            });

            yPos += 10;

            // Totals
            ctx.strokeStyle = '#DDDDDD';
            ctx.beginPath();
            ctx.moveTo(width - 200, yPos);
            ctx.lineTo(width - margin, yPos);
            ctx.stroke();
            yPos += 20;

            ctx.fillStyle = '#333333';
            ctx.font = '13px Arial';
            ctx.textAlign = 'right';
            ctx.fillText('Subtotal:', width - 100, yPos);
            ctx.fillText('$' + subtotal.toFixed(2), width - margin - 10, yPos);
            yPos += 20;

            if (settings.gstEnabled) {
                var gst = subtotal * 0.1;
                ctx.fillText('GST (10%):', width - 100, yPos);
                ctx.fillText('$' + gst.toFixed(2), width - margin - 10, yPos);
                yPos += 20;
            }

            ctx.font = 'bold 16px Arial';
            ctx.fillStyle = '#C7632C';
            ctx.fillText('TOTAL PAID:', width - 120, yPos);
            ctx.fillText('$' + apt.checkout.total.toFixed(2), width - margin - 10, yPos);
            ctx.textAlign = 'left';
            yPos += 40;

            // Payment info
            ctx.fillStyle = '#505050';
            ctx.font = '12px Arial';
            ctx.fillText('Payment Method: ' + apt.checkout.paymentMethod.charAt(0).toUpperCase() + apt.checkout.paymentMethod.slice(1), margin, yPos);
            yPos += 18;
            ctx.fillText('Date Paid: ' + new Date(apt.checkout.timestamp).toLocaleDateString(), margin, yPos);

            // Footer
            yPos = height - 60;
            ctx.strokeStyle = '#DDDDDD';
            ctx.beginPath();
            ctx.moveTo(margin, yPos);
            ctx.lineTo(width - margin, yPos);
            ctx.stroke();
            yPos += 25;

            ctx.fillStyle = '#888888';
            ctx.font = '11px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Thank you for choosing ' + (settings.businessName || 'Maya Groom Pro') + '!', width / 2, yPos);
            yPos += 16;
            ctx.fillText('We appreciate your business.', width / 2, yPos);

            // Convert to blob and call callback
            canvas.toBlob(function(blob) {
                var fileName = 'Invoice_' + invoiceNum + '_' + client.name.replace(/\s+/g, '_') + '.png';
                var imageFile = new File([blob], fileName, { type: 'image/png' });
                callback(imageFile, client, invoiceNum, apt);
            }, 'image/png');
        }

        function shareInvoicePDF(aptId, method) {
            var apt = appointments.find(function(a) { return a.id === aptId; });
            if (!apt || !apt.checkout) {
                showNotification('No checkout information found');
                return;
            }

            var client = clients.find(function(c) { return c.id === apt.clientId; });
            if (!client) {
                showNotification('Client not found');
                return;
            }

            var firstName = client.name.split(' ')[0];

            // Copy appropriate contact to clipboard - clean phone number (digits only)
            var contactInfo = method === 'sms' ? client.phone : client.email;
            if (!contactInfo) {
                contactInfo = client.phone || client.email || '';
            }

            // For SMS, clean and convert to international format (+61)
            if (method === 'sms' && contactInfo) {
                // Remove all non-digits
                contactInfo = contactInfo.replace(/[^0-9]/g, '');
                // Convert Australian numbers starting with 0 to +61 format
                if (contactInfo.startsWith('0') && contactInfo.length === 10) {
                    contactInfo = '+61' + contactInfo.substring(1);
                }
            }

            // Close modals
            document.querySelectorAll('.modal-overlay').forEach(function(modal) { modal.remove(); });

            // Copy contact to clipboard first, then share after a short delay
            if (contactInfo && navigator.clipboard) {
                navigator.clipboard.writeText(contactInfo).then(function() {
                    showNotification('Copied: ' + contactInfo);
                    // Small delay before opening share to let clipboard complete
                    setTimeout(function() {
                        generateInvoicePDF(aptId, 'share');
                    }, 300);
                }).catch(function() {
                    generateInvoicePDF(aptId, 'share');
                });
            } else {
                generateInvoicePDF(aptId, 'share');
            }
        }

        function sendEmailWithInvoice(doc, fileName, client, invoiceNum, apt) {
            // Get customer first name
            var firstName = client.name.split(' ')[0];

            // Use override contact if available, otherwise use client email
            var emailAddress = window.shareContactOverride || client.email || '';
            window.shareContactOverride = null; // Clear after use

            // Create PDF file for sharing
            var pdfBlob = doc.output('blob');
            var pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });

            var messageText = 'Hi ' + firstName + ',\n\n' +
                'Please find attached your invoice for services provided on ' + formatDate(apt.date) + '.\n\n' +
                'Invoice Number: ' + invoiceNum + '\n' +
                'Total: $' + apt.checkout.total.toFixed(2) + '\n\n' +
                'Thank you for choosing us!\n\n' +
                'Kind regards,\n' +
                (settings.businessName || 'Maya Groom Pro') + '\n' +
                (settings.phone ? 'Ph: ' + settings.phone : '');

            // Close all modals
            document.querySelectorAll('.modal-overlay').forEach(function(modal) { modal.remove(); });

            // Open email with customer's email and message
            var subject = encodeURIComponent('Invoice from ' + (settings.businessName || 'Maya Groom Pro') + ' - ' + invoiceNum);
            var body = encodeURIComponent(messageText);
            var mailtoLink = 'mailto:' + emailAddress + '?subject=' + subject + '&body=' + body;
            window.location.href = mailtoLink;
        }

        function sendSmsWithInvoice(doc, fileName, client, invoiceNum, apt) {
            // Get customer first name
            var firstName = client.name.split(' ')[0];

            // Use override contact if available, otherwise use client phone
            var phoneNumber = window.shareContactOverride || client.phone || '';
            phoneNumber = phoneNumber.replace(/[^0-9+]/g, ''); // Keep only numbers and +
            window.shareContactOverride = null; // Clear after use

            // Convert PDF to JPG for SMS (MMS-friendly)
            var scale = 2; // Higher resolution
            var canvas = document.createElement('canvas');
            var page = doc.internal.pages[1];
            var pageWidth = doc.internal.pageSize.getWidth();
            var pageHeight = doc.internal.pageSize.getHeight();

            // Set canvas size (72 DPI base, scaled up)
            canvas.width = pageWidth * scale * 2.83; // Convert mm to pixels at 72dpi * scale
            canvas.height = pageHeight * scale * 2.83;

            // Get PDF as image data URL
            var imgData = doc.output('datauristring');

            // Use jsPDF's built-in canvas output for better quality
            var pdfCanvas = doc.output('datauristring', { type: 'image/jpeg', quality: 0.92 });

            // Convert PDF to image using pdf.js would be ideal, but for simplicity
            // we'll create a JPG from the PDF data
            // Since jsPDF doesn't directly export to JPG, we'll use the canvas approach

            // Create image from first page
            var imgFileName = fileName.replace('.pdf', '.jpg');

            // Use jsPDF's output as dataurl and convert
            var pdfDataUri = doc.output('datauristring');

            // For iOS/mobile, use Web Share API with the image
            // First, render PDF page to canvas using pdf.js or alternative method

            // Simpler approach: Create a visual invoice as canvas directly
            createInvoiceImage(apt, client, invoiceNum, function(jpgBlob, jpgDataUrl) {
                var jpgFile = new File([jpgBlob], imgFileName, { type: 'image/jpeg' });

                // Build SMS message with customer name
                var smsBody = 'Hi ' + firstName + '! Here is your invoice from ' + (settings.businessName || 'Maya Groom Pro') + '.\n' +
                    'Invoice: ' + invoiceNum + '\n' +
                    'Total: $' + apt.checkout.total.toFixed(2) + '\n' +
                    'Date: ' + formatDate(apt.date) + '\n' +
                    'Thank you for your business!';

                // Close all modals
                document.querySelectorAll('.modal-overlay').forEach(function(modal) { modal.remove(); });

                // Try Web Share API first (works on iOS Safari)
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [jpgFile] })) {
                    navigator.share({
                        files: [jpgFile],
                        title: 'Invoice ' + invoiceNum,
                        text: smsBody
                    }).catch(function(err) {
                        console.log('Share cancelled or failed:', err);
                        // Fallback to regular SMS link
                        openSmsLink(phoneNumber, smsBody);
                    });
                } else {
                    // Fallback: Open SMS with text only
                    openSmsLink(phoneNumber, smsBody);
                    showNotification('Invoice image saved - attach it manually from Photos');

                    // Auto-download the image so user can attach it
                    var link = document.createElement('a');
                    link.href = jpgDataUrl;
                    link.download = imgFileName;
                    link.click();
                }
            });
        }

        function openSmsLink(phoneNumber, smsBody) {
            var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            var smsLink;
            if (isIOS) {
                smsLink = 'sms:' + phoneNumber + '&body=' + encodeURIComponent(smsBody);
            } else {
                smsLink = 'sms:' + phoneNumber + '?body=' + encodeURIComponent(smsBody);
            }
            window.location.href = smsLink;
        }

        function showShareModalJPG(aptId) {
            var apt = appointments.find(function(a) { return a.id === aptId; });
            if (!apt || !apt.checkout) {
                showNotification('No checkout information found');
                return;
            }

            var client = clients.find(function(c) { return c.id === apt.clientId; });
            if (!client) {
                showNotification('Client not found');
                return;
            }

            var title = 'Send Invoice via SMS';
            var fieldValue = client.phone || '';

            var content = '<div class="space-y-4">';
            content += '<div class="text-center p-4 rounded-lg" style="background: var(--bg-tertiary);">';
            content += '<i class="fas fa-message text-3xl mb-2" style="color: var(--accent-primary);"></i>';
            content += '<div class="font-semibold">' + client.name + '</div>';
            content += '<div class="text-sm" style="color: var(--text-secondary);">Invoice Total: $' + apt.checkout.total.toFixed(2) + '</div>';
            content += '</div>';

            content += '<div>';
            content += '<label class="block text-sm font-semibold mb-2">Phone Number</label>';
            content += '<input type="tel" id="smsPhoneInput" class="input-field" value="' + fieldValue + '" placeholder="Enter phone number">';
            content += '</div>';

            if (!fieldValue) {
                content += '<div class="text-sm p-3 rounded" style="background: rgba(217, 74, 61, 0.1); color: var(--danger);">';
                content += '<i class="fas fa-exclamation-circle mr-2"></i>No phone number on file for this client. Please enter one above.';
                content += '</div>';
            }

            content += '<div class="text-sm p-3 rounded" style="background: var(--bg-tertiary);">';
            content += '<i class="fas fa-info-circle mr-2" style="color: var(--accent-primary);"></i>Invoice will be sent as a JPG image';
            content += '</div>';

            content += '</div>';

            var buttons = '<button onclick="this.closest(\'.modal-overlay\').remove()" class="btn btn-secondary">Cancel</button>';
            buttons += '<button onclick="confirmShareJPG(' + aptId + ')" class="btn btn-primary"><i class="fas fa-paper-plane mr-2"></i>Send</button>';

            showModal(title, content, buttons);
        }

        function confirmShareJPG(aptId) {
            var phoneInput = document.getElementById('smsPhoneInput');
            var phoneValue = phoneInput ? phoneInput.value.trim() : '';

            if (!phoneValue) {
                showNotification('Please enter a phone number');
                return;
            }

            // Clean phone number
            var cleanPhone = phoneValue.replace(/[^0-9+]/g, '');
            if (cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                cleanPhone = '+61' + cleanPhone.substring(1);
            }

            // Close the modal
            document.querySelectorAll('.modal-overlay').forEach(function(modal) { modal.remove(); });

            // Get appointment and client data
            var apt = appointments.find(function(a) { return a.id === aptId; });
            var client = clients.find(function(c) { return c.id === apt.clientId; });
            var firstName = client.name.split(' ')[0];
            var invoiceNum = 'INV-' + apt.id + '-' + new Date(apt.checkout.timestamp).getTime().toString().slice(-6);
            var imgFileName = 'Invoice-' + invoiceNum + '.jpg';

            // Build SMS message
            var smsBody = 'Hi ' + firstName + '!\n\n' +
                'Here is your invoice from ' + (settings.businessName || 'Maya Groom Pro') + '.\n\n' +
                'Invoice: ' + invoiceNum + '\n' +
                'Total: $' + apt.checkout.total.toFixed(2) + '\n' +
                'Date: ' + formatDate(apt.date) + '\n\n' +
                'Thank you for your business!';

            // Store SMS data for later use
            window.pendingSmsData = {
                phone: cleanPhone,
                message: smsBody
            };

            // Create JPG invoice and show in modal for saving
            createInvoiceImage(apt, client, invoiceNum, function(jpgBlob, jpgDataUrl) {
                // Show modal with image and instructions
                var content = `
                    <div class="space-y-4">
                        <div class="p-3 rounded-lg" style="background: var(--bg-tertiary);">
                            <div class="font-semibold mb-1">Phone Number:</div>
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${cleanPhone}</span>
                                <button onclick="navigator.clipboard.writeText('${cleanPhone}'); showNotification('Phone copied!')" class="btn btn-secondary btn-sm">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-sm font-semibold">Long-press image to save to Photos:</div>
                        <div class="rounded-lg overflow-hidden border" style="border-color: var(--border);">
                            <img src="${jpgDataUrl}" alt="Invoice" style="width: 100%; display: block;">
                        </div>
                        <div class="text-xs" style="color: var(--text-tertiary);">
                            <i class="fas fa-info-circle mr-1"></i>After saving, open Messages, paste the phone number, and attach the image from Photos.
                        </div>
                    </div>
                `;

                var buttons = `
                    <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Close</button>
                    <button onclick="openPendingSms()" class="btn btn-primary">
                        <i class="fas fa-message mr-2"></i>Open SMS
                    </button>
                `;

                showModal('Save Invoice for SMS', content, buttons);
            });
        }

        function openPendingSms() {
            if (window.pendingSmsData) {
                document.querySelectorAll('.modal-overlay').forEach(function(m) { m.remove(); });
                openSmsLink(window.pendingSmsData.phone, window.pendingSmsData.message);
            }
        }

        function createInvoiceImage(apt, client, invoiceNum, callback) {
            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext('2d');

            // Set canvas size (mobile-friendly dimensions)
            var width = 800;
            var height = 1200;
            canvas.width = width;
            canvas.height = height;

            // White background
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, width, height);

            var margin = 40;
            var yPos = 50;

            // Header - Business Name
            ctx.fillStyle = '#C7632C';
            ctx.font = 'bold 32px Arial, sans-serif';
            ctx.fillText(settings.businessName || 'Maya Groom Pro', margin, yPos);
            yPos += 35;

            // ABN
            if (settings.abn) {
                ctx.fillStyle = '#505050';
                ctx.font = 'bold 16px Arial, sans-serif';
                ctx.fillText('ABN: ' + settings.abn, margin, yPos);
                yPos += 25;
            }

            // Business details
            ctx.fillStyle = '#666666';
            ctx.font = '14px Arial, sans-serif';
            if (settings.address) {
                ctx.fillText(settings.address, margin, yPos);
                yPos += 20;
            }
            if (settings.phone) {
                ctx.fillText('Phone: ' + settings.phone, margin, yPos);
                yPos += 20;
            }
            if (settings.email) {
                ctx.fillText('Email: ' + settings.email, margin, yPos);
                yPos += 20;
            }

            // TAX INVOICE title (right aligned)
            ctx.fillStyle = '#323232';
            ctx.font = 'bold 28px Arial, sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText('TAX INVOICE', width - margin, 60);
            ctx.font = '14px Arial, sans-serif';
            ctx.fillText(invoiceNum, width - margin, 85);
            ctx.textAlign = 'left';

            yPos += 20;

            // Horizontal line
            ctx.strokeStyle = '#CCCCCC';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(margin, yPos);
            ctx.lineTo(width - margin, yPos);
            ctx.stroke();
            yPos += 30;

            // Bill To
            ctx.fillStyle = '#323232';
            ctx.font = 'bold 16px Arial, sans-serif';
            ctx.fillText('BILL TO:', margin, yPos);
            yPos += 25;

            ctx.font = '15px Arial, sans-serif';
            ctx.fillText(client.name, margin, yPos);
            yPos += 20;
            if (client.address) {
                ctx.fillText(client.address, margin, yPos);
                yPos += 20;
            }
            if (client.phone) {
                ctx.fillText(client.phone, margin, yPos);
                yPos += 20;
            }

            // Invoice date (right side)
            ctx.textAlign = 'right';
            ctx.font = 'bold 14px Arial, sans-serif';
            ctx.fillText('Date: ' + formatDate(apt.date), width - margin, yPos - 40);
            ctx.textAlign = 'left';

            yPos += 30;

            // Table header
            ctx.fillStyle = '#F5F5F5';
            ctx.fillRect(margin, yPos, width - margin * 2, 35);
            ctx.fillStyle = '#323232';
            ctx.font = 'bold 14px Arial, sans-serif';
            yPos += 24;
            ctx.fillText('Description', margin + 10, yPos);
            ctx.textAlign = 'right';
            ctx.fillText('Amount', width - margin - 10, yPos);
            ctx.textAlign = 'left';
            yPos += 20;

            // Services
            ctx.font = '14px Arial, sans-serif';
            if (apt.checkout.services && apt.checkout.services.length > 0) {
                apt.checkout.services.forEach(function(service) {
                    yPos += 25;
                    ctx.fillText(service.name, margin + 10, yPos);
                    ctx.textAlign = 'right';
                    ctx.fillText('$' + service.price.toFixed(2), width - margin - 10, yPos);
                    ctx.textAlign = 'left';
                });
            }

            // Products
            if (apt.checkout.products && apt.checkout.products.length > 0) {
                apt.checkout.products.forEach(function(product) {
                    yPos += 25;
                    var productText = product.name + (product.quantity > 1 ? ' x' + product.quantity : '');
                    ctx.fillText(productText, margin + 10, yPos);
                    ctx.textAlign = 'right';
                    ctx.fillText('$' + (product.price * product.quantity).toFixed(2), width - margin - 10, yPos);
                    ctx.textAlign = 'left';
                });
            }

            yPos += 30;

            // Subtotals line
            ctx.strokeStyle = '#CCCCCC';
            ctx.beginPath();
            ctx.moveTo(margin, yPos);
            ctx.lineTo(width - margin, yPos);
            ctx.stroke();
            yPos += 25;

            // Subtotal
            var subtotal = apt.checkout.subtotal || apt.checkout.total || 0;
            ctx.font = '14px Arial, sans-serif';
            ctx.fillText('Subtotal:', width - 200, yPos);
            ctx.textAlign = 'right';
            ctx.fillText('$' + subtotal.toFixed(2), width - margin - 10, yPos);
            ctx.textAlign = 'left';
            yPos += 22;

            // Discount if any
            if (apt.checkout.discount && apt.checkout.discount > 0) {
                ctx.fillStyle = '#D94A3D';
                ctx.fillText('Discount:', width - 200, yPos);
                ctx.textAlign = 'right';
                ctx.fillText('-$' + apt.checkout.discount.toFixed(2), width - margin - 10, yPos);
                ctx.textAlign = 'left';
                ctx.fillStyle = '#323232';
                yPos += 22;
            }

            // GST
            var gstAmount = apt.checkout.total / 11;
            ctx.fillText('GST (incl.):', width - 200, yPos);
            ctx.textAlign = 'right';
            ctx.fillText('$' + gstAmount.toFixed(2), width - margin - 10, yPos);
            ctx.textAlign = 'left';
            yPos += 30;

            // Total
            ctx.fillStyle = '#C7632C';
            ctx.font = 'bold 20px Arial, sans-serif';
            ctx.fillText('TOTAL:', width - 200, yPos);
            ctx.textAlign = 'right';
            ctx.fillText('$' + apt.checkout.total.toFixed(2), width - margin - 10, yPos);
            ctx.textAlign = 'left';
            yPos += 40;

            // Payment method
            ctx.fillStyle = '#666666';
            ctx.font = '14px Arial, sans-serif';
            ctx.fillText('Payment Method: ' + (apt.checkout.paymentMethod || 'N/A').toUpperCase(), margin, yPos);
            yPos += 50;

            // Thank you message
            ctx.fillStyle = '#323232';
            ctx.font = 'italic 16px Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Thank you for your business!', width / 2, yPos);
            ctx.textAlign = 'left';

            // Convert canvas to JPG blob
            canvas.toBlob(function(blob) {
                var dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                callback(blob, dataUrl);
            }, 'image/jpeg', 0.9);
        }

        function showShareModal(aptId, shareType) {
            var apt = appointments.find(function(a) { return a.id === aptId; });
            if (!apt || !apt.checkout) return;

            var client = clients.find(function(c) { return c.id === apt.clientId; });
            if (!client) return;

            var isEmail = shareType === 'email';
            var title = isEmail ? 'Send Invoice via Email' : 'Send Invoice via SMS';
            var icon = isEmail ? 'fa-envelope' : 'fa-message';
            var fieldLabel = isEmail ? 'Email Address' : 'Phone Number';
            var fieldValue = isEmail ? (client.email || '') : (client.phone || '');
            var fieldType = isEmail ? 'email' : 'tel';
            var placeholder = isEmail ? 'Enter email address' : 'Enter phone number';

            var content = '<div class="space-y-4">';
            content += '<div class="text-center p-4 rounded-lg" style="background: var(--bg-tertiary);">';
            content += '<i class="fas ' + icon + ' text-3xl mb-2" style="color: var(--accent-primary);"></i>';
            content += '<div class="font-semibold">' + client.name + '</div>';
            content += '<div class="text-sm" style="color: var(--text-secondary);">Invoice Total: $' + apt.checkout.total.toFixed(2) + '</div>';
            content += '</div>';

            content += '<div>';
            content += '<label class="block text-sm font-semibold mb-2">' + fieldLabel + '</label>';
            content += '<input type="' + fieldType + '" id="shareContactInput" class="input-field" value="' + fieldValue + '" placeholder="' + placeholder + '">';
            content += '</div>';

            if (!fieldValue) {
                content += '<div class="text-sm p-3 rounded" style="background: rgba(217, 74, 61, 0.1); color: var(--danger);">';
                content += '<i class="fas fa-exclamation-circle mr-2"></i>No ' + (isEmail ? 'email' : 'phone number') + ' on file for this client. Please enter one above.';
                content += '</div>';
            }

            content += '</div>';

            var buttons = '<button onclick="this.closest(\'.modal-overlay\').remove()" class="btn btn-secondary">Cancel</button>';
            buttons += '<button onclick="confirmShare(' + aptId + ', \'' + shareType + '\')" class="btn btn-primary"><i class="fas fa-paper-plane mr-2"></i>Send</button>';

            showModal(title, content, buttons);
        }

        function confirmShare(aptId, shareType) {
            var contactInput = document.getElementById('shareContactInput');
            var contactValue = contactInput ? contactInput.value.trim() : '';

            if (!contactValue) {
                showNotification('Please enter a ' + (shareType === 'email' ? 'email address' : 'phone number'));
                return;
            }

            // Store the contact value for use in share
            window.shareContactOverride = contactValue;

            // Close the modal
            var modal = document.querySelector('.modal-overlay');
            if (modal) modal.remove();

            // Generate and share the invoice
            generateInvoicePDF(aptId, shareType);
        }

        function showClientDetails(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            const clientAppointments = appointments
                .filter(a => a.clientId === client.id)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const content = `
                <div class="space-y-4">
                    <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                        <h3 class="font-bold text-lg mb-3">${client.name}</h3>
                        <div class="space-y-2 text-sm">
                            <div onclick="showPhoneOptions('${client.phone.replace(/'/g, "\\'")}');" class="cursor-pointer hover:text-blue-600">
                                <i class="fas fa-phone mr-2" style="color: var(--accent-primary);"></i>${client.phone}
                            </div>
                            <a href="mailto:${client.email}" class="cursor-pointer hover:text-blue-600 transition-colors block">
                                <i class="fas fa-envelope mr-2" style="color: var(--accent-primary);"></i>${client.email}
                            </a>
                            <div onclick="openMaps('${client.address.replace(/'/g, "\\'")}');" class="cursor-pointer hover:text-blue-600">
                                <i class="fas fa-location-dot mr-2" style="color: var(--accent-primary);"></i>${client.address}
                            </div>
                        </div>
                    </div>

                    ${client.pets && client.pets.length > 0 ? `
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                            <div class="font-semibold mb-2">Pets</div>
                            ${client.pets.map(pet => `
                                <div class="mb-2">
                                    <div class="font-semibold text-sm"><i class="fas fa-paw mr-2" style="color: var(--accent-primary);"></i>${pet.name}</div>
                                    <div class="text-xs ml-6" style="color: var(--text-secondary);">${pet.breed}${pet.age ? `, ${pet.age}` : ''}</div>
                                    ${pet.notes ? `<div class="text-xs ml-6 mt-1" style="color: var(--text-tertiary);">${pet.notes}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    ${clientAppointments.length > 0 ? `
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                            <div class="font-semibold mb-2">Appointment History</div>
                            <div class="space-y-2">
                                ${clientAppointments.slice(0, 5).map(apt => {
                                    const aptDate = new Date(apt.date);
                                    return `
                                        <div class="text-sm p-2 rounded cursor-pointer hover:opacity-80" style="background: var(--bg-primary);" onclick="this.closest('.modal-overlay').remove(); openAppointmentDetails(${apt.id})">
                                            <div class="font-semibold">${aptDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at ${formatTime(aptDate)}</div>
                                            <div class="text-xs" style="color: var(--text-tertiary);">${apt.pets.map(p => p.name).join(', ')} - ${apt.status}</div>
                                        </div>
                                    `;
                                }).join('')}
                                ${clientAppointments.length > 5 ? `<div class="text-xs text-center" style="color: var(--text-tertiary);">+${clientAppointments.length - 5} more appointments</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Close</button>
                <button onclick="this.closest('.modal-overlay').remove(); editClient(${clientId})" class="btn btn-primary">
                    <i class="fas fa-edit mr-2"></i>Edit Client
                </button>
            `;

            showModal(`Client Details`, content, buttons);
        }

        function updateAppointmentStatus(aptId, newStatus) {
            const apt = appointments.find(a => a.id === aptId);
            if (!apt) return;

            const oldStatus = apt.status;
            apt.status = newStatus;

            renderWeekTimeline();
            renderCalendar();

            // Close and reopen the modal to refresh
            document.querySelector('.modal-overlay').remove();
            openAppointmentDetails(aptId);

            showAlert(`Appointment status updated to ${newStatus}!`);
        }

        function showSmsOptionsModal(aptId) {
            const apt = appointments.find(a => a.id === aptId);
            const client = clients.find(c => c.id === apt.clientId);

            if (!client || !apt) return;

            const content = `
                <div class="space-y-3">
                    <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                        <div class="font-semibold">${client.name}</div>
                        <div class="text-sm" style="color: var(--text-secondary);">${client.phone}</div>
                    </div>
                    <div class="text-sm font-semibold" style="color: var(--text-secondary);">Select message type:</div>
                    <button onclick="this.closest('.modal-overlay').remove(); sendConfirmationMessage(${aptId})" class="w-full p-4 rounded-lg text-left hover:opacity-80 transition-opacity" style="background: var(--bg-tertiary);">
                        <div class="font-semibold"><i class="fas fa-check-circle mr-2" style="color: var(--success);"></i>Confirmation Request</div>
                        <div class="text-sm mt-1" style="color: var(--text-secondary);">Ask customer to confirm their appointment</div>
                    </button>
                    <button onclick="this.closest('.modal-overlay').remove(); sendReminderMessage(${aptId})" class="w-full p-4 rounded-lg text-left hover:opacity-80 transition-opacity" style="background: var(--bg-tertiary);">
                        <div class="font-semibold"><i class="fas fa-bell mr-2" style="color: var(--warning);"></i>Reminder</div>
                        <div class="text-sm mt-1" style="color: var(--text-secondary);">Remind customer about upcoming appointment</div>
                    </button>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
            `;

            showModal('Send SMS', content, buttons);
        }

        function sendConfirmationMessage(aptId) {
            const apt = appointments.find(a => a.id === aptId);
            const client = clients.find(c => c.id === apt.clientId);

            if (!client || !apt) return;

            // Use the confirmation template from settings
            const confirmationMessage = processMessageTemplate(
                settings.messageTemplates.confirmation,
                client,
                apt
            );

            const cleanPhone = client.phone.replace(/\s/g, '');
            const escapedMessage = confirmationMessage.replace(/'/g, "\\'").replace(/\n/g, '\\n');

            const content = `
                <div class="space-y-4">
                    <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                        <div class="text-sm font-semibold mb-2">Send to: ${client.name}</div>
                        <div class="text-sm mb-3" style="color: var(--text-secondary);">${client.phone}</div>
                        <div class="text-sm whitespace-pre-wrap p-3 rounded" style="background: var(--bg-primary); border: 1px solid var(--border);">
${confirmationMessage}
                        </div>
                    </div>
                    <div class="text-xs" style="color: var(--text-tertiary);">
                        <i class="fas fa-info-circle mr-1"></i>This will open your SMS app with the message pre-filled
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
                <button onclick="sendBookingSMS('${cleanPhone}', '${escapedMessage}', null, ${aptId})" class="btn btn-primary">
                    <i class="fas fa-message mr-2"></i>Send Confirmation
                </button>
            `;

            showModal('Send Confirmation Request', content, buttons);
        }

        function sendReminderMessage(aptId) {
            const apt = appointments.find(a => a.id === aptId);
            const client = clients.find(c => c.id === apt.clientId);

            if (!client || !apt) return;

            // Use the reminder template from settings
            const reminderMessage = processMessageTemplate(
                settings.messageTemplates.reminder,
                client,
                apt
            );

            const cleanPhone = client.phone.replace(/\s/g, '');
            const escapedMessage = reminderMessage.replace(/'/g, "\\'").replace(/\n/g, '\\n');

            const content = `
                <div class="space-y-4">
                    <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                        <div class="text-sm font-semibold mb-2">Send to: ${client.name}</div>
                        <div class="text-sm mb-3" style="color: var(--text-secondary);">${client.phone}</div>
                        <div class="text-sm whitespace-pre-wrap p-3 rounded" style="background: var(--bg-primary); border: 1px solid var(--border);">
${reminderMessage}
                        </div>
                    </div>
                    <div class="text-xs" style="color: var(--text-tertiary);">
                        <i class="fas fa-info-circle mr-1"></i>This will open your SMS app with the message pre-filled
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
                <button onclick="sendBookingSMS('${cleanPhone}', '${escapedMessage}', null, ${aptId})" class="btn btn-primary">
                    <i class="fas fa-bell mr-2"></i>Send Reminder
                </button>
            `;

            showModal('Send Reminder', content, buttons);
        }

        // Reschedule Appointment Function
        function rescheduleAppointment(aptId) {
            const apt = appointments.find(a => a.id === aptId);
            if (!apt) return;

            const client = clients.find(c => c.id === apt.clientId);
            if (!client) return;

            // Check if this is a recurring appointment
            if (apt.isRecurring) {
                // Show option: reschedule only this or the series
                const content = `
                    <div class="space-y-4">
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                            <div class="font-semibold mb-2">This is a recurring appointment</div>
                            <div class="text-sm" style="color: var(--text-secondary);">Choose how you want to reschedule:</div>
                        </div>
                        <button onclick="showRescheduleForm(${apt.id}, false)" class="w-full text-left p-4 rounded-lg hover:bg-opacity-80 transition-all" style="background: var(--bg-tertiary);">
                            <div class="font-semibold text-lg">Only this appointment</div>
                            <div class="text-sm" style="color: var(--text-tertiary);">Reschedule just this single appointment</div>
                        </button>
                        <button onclick="showRescheduleForm(${apt.id}, true)" class="w-full text-left p-4 rounded-lg hover:bg-opacity-80 transition-all" style="background: var(--bg-tertiary);">
                            <div class="font-semibold text-lg">The series</div>
                            <div class="text-sm" style="color: var(--text-tertiary);">Reschedule this and all future appointments in the series</div>
                        </button>
                    </div>
                `;
                showModal('Reschedule Recurring Appointment', content, '');
            } else {
                // Direct reschedule for non-recurring appointments
                showRescheduleForm(apt.id, false);
            }
        }

        function showRescheduleForm(aptId, rescheduleSeries) {
            const apt = appointments.find(a => a.id === aptId);
            if (!apt) return;

            const client = clients.find(c => c.id === apt.clientId);
            if (!client) return;

            const aptDate = new Date(apt.date);
            const dateStr = aptDate.toISOString().split('T')[0];
            const timeStr = aptDate.toTimeString().slice(0, 5);

            const content = `
                <div class="space-y-4">
                    <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                        <div class="font-semibold mb-1">${client.name}</div>
                        <div class="text-sm" style="color: var(--text-secondary);">
                            ${apt.pets.map(p => p.name).join(', ')}
                            ${rescheduleSeries ? ' - Rescheduling entire series' : ''}
                        </div>
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold" style="color: var(--text-primary);">New Date</label>
                        <input type="date" id="rescheduleDate" value="${dateStr}" class="w-full p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 1.125rem;">
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold" style="color: var(--text-primary);">New Time</label>
                        <input type="time" id="rescheduleTime" value="${timeStr}" class="w-full p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 1.125rem;">
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
                <button onclick="confirmReschedule(${apt.id}, ${rescheduleSeries})" class="btn btn-primary">
                    <i class="fas fa-check mr-2"></i>Confirm Reschedule
                </button>
            `;

            showModal('Reschedule Appointment', content, buttons);
        }

        function confirmReschedule(aptId, rescheduleSeries) {
            const apt = appointments.find(a => a.id === aptId);
            if (!apt) return;

            const newDateStr = document.getElementById('rescheduleDate').value;
            const newTimeStr = document.getElementById('rescheduleTime').value;

            if (!newDateStr || !newTimeStr) {
                showNotification('Please select both date and time');
                return;
            }

            const oldDate = new Date(apt.date);
            const newDate = new Date(newDateStr + 'T' + newTimeStr);

            if (rescheduleSeries && apt.isRecurring) {
                // Reschedule all future appointments in the series
                const timeDiff = newDate - oldDate;
                const seriesAppointments = appointments.filter(a =>
                    a.recurringId === apt.recurringId &&
                    new Date(a.date) >= oldDate
                );

                seriesAppointments.forEach(a => {
                    a.date = new Date(new Date(a.date).getTime() + timeDiff);
                });

                showNotification(`Rescheduled ${seriesAppointments.length} appointments in the series`);
            } else {
                // Reschedule only this appointment
                apt.date = newDate;

                // If this was part of a series, mark it as no longer recurring
                if (apt.isRecurring && !rescheduleSeries) {
                    apt.isRecurring = false;
                    apt.recurringId = null;
                }

                showNotification('Appointment rescheduled');
            }

            // Close modal and refresh views
            document.querySelector('.modal-overlay')?.remove();
            renderWeekTimeline();
            renderCalendar();
        }

        // Calendar Export Functions
        function generateICS(appointment, client) {
            const aptDate = new Date(appointment.date);

            // Calculate end time based on service duration
            const totalMinutes = appointment.pets.reduce((sum, pet) => {
                return sum + pet.items.reduce((itemSum, item) => {
                    const serviceOrItem = [...services, ...items].find(s => s.id === item.id && s.type === item.type);
                    return itemSum + (serviceOrItem?.duration || 30);
                }, 0);
            }, 0);

            const endDate = new Date(aptDate.getTime() + totalMinutes * 60000);

            // Format dates for ICS (YYYYMMDDTHHMMSS)
            const formatICSDate = (date) => {
                const pad = (n) => n.toString().padStart(2, '0');
                return date.getFullYear() +
                       pad(date.getMonth() + 1) +
                       pad(date.getDate()) + 'T' +
                       pad(date.getHours()) +
                       pad(date.getMinutes()) +
                       pad(date.getSeconds());
            };

            const now = new Date();
            const timestamp = formatICSDate(now);
            const startTime = formatICSDate(aptDate);
            const endTime = formatICSDate(endDate);

            // Create description
            const petsList = appointment.pets.map(pet => {
                const serviceNames = pet.items.map(item => {
                    const svc = item.type === 'service' ?
                        services.find(s => s.id === item.id) :
                        items.find(i => i.id === item.id);
                    return svc ? svc.name : '';
                }).filter(s => s).join(', ');
                return `${pet.name}: ${serviceNames}`;
            }).join('\\n');

            const description = `Grooming appointment for ${client.name}\\n\\nPets:\\n${petsList}${appointment.notes ? '\\n\\nNotes: ' + appointment.notes : ''}\\n\\nClient: ${client.phone}\\n${client.address}`;

            // Generate ICS content
            const ics = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Maya Groom Pro//Appointment//EN',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                'X-WR-CALNAME:Maya Groom Pro Appointments',
                'X-WR-TIMEZONE:' + Intl.DateTimeFormat().resolvedOptions().timeZone,
                'BEGIN:VEVENT',
                'UID:' + appointment.id + '@mayagroompro.app',
                'DTSTAMP:' + timestamp,
                'DTSTART:' + startTime,
                'DTEND:' + endTime,
                'SUMMARY:' + client.name + ' - ' + appointment.pets.map(p => p.name).join(', '),
                'DESCRIPTION:' + description,
                'LOCATION:' + client.address,
                'STATUS:' + (appointment.status === 'confirmed' ? 'CONFIRMED' : 'TENTATIVE'),
                'SEQUENCE:0',
                'BEGIN:VALARM',
                'TRIGGER:-PT1H',
                'DESCRIPTION:Appointment in 1 hour',
                'ACTION:DISPLAY',
                'END:VALARM',
                'END:VEVENT',
                'END:VCALENDAR'
            ].join('\r\n');

            return ics;
        }

        function exportAppointmentToCalendar(aptId) {
            const apt = appointments.find(a => a.id === aptId);
            const client = clients.find(c => c.id === apt.clientId);

            if (!apt || !client) {
                showAlert('Error: Appointment or client not found');
                return;
            }

            // Show modal with calendar options
            showAddToCalendarModal(apt, client);
        }

        function showAddToCalendarModal(apt, client) {
            const aptDate = new Date(apt.date);

            // Calculate end time
            const totalMinutes = apt.pets.reduce((sum, pet) => {
                return sum + pet.items.reduce((itemSum, item) => {
                    const serviceOrItem = [...services, ...items].find(s => s.id === item.id && s.type === item.type);
                    return itemSum + (serviceOrItem?.duration || 30);
                }, 0);
            }, 0);
            const endDate = new Date(aptDate.getTime() + totalMinutes * 60000);

            // Format for display
            const dateStr = aptDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            const timeStr = formatTime(aptDate);

            // Create URLs for different calendar services
            const googleUrl = createGoogleCalendarUrl(apt, client, aptDate, endDate);
            const outlookUrl = createOutlookCalendarUrl(apt, client, aptDate, endDate);

            const content = `
                <div class="space-y-4">
                    <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                        <div class="font-bold mb-2">${client.name}</div>
                        <div class="text-sm mb-1"><i class="fas fa-calendar mr-2"></i>${dateStr}</div>
                        <div class="text-sm"><i class="fas fa-clock mr-2"></i>${timeStr}</div>
                    </div>

                    <div class="text-sm font-semibold mb-2">Add to your calendar:</div>

                    <div class="grid grid-cols-1 gap-2">
                        <button onclick="openLink('${googleUrl}')" class="btn btn-primary w-full">
                            <i class="fab fa-google mr-2"></i>Google Calendar
                            <div class="text-xs opacity-75 mt-1"> Instant - no download</div>
                        </button>
                        <button onclick="openLink('${outlookUrl}')" class="btn btn-secondary w-full">
                            <i class="fab fa-microsoft mr-2"></i>Outlook Calendar
                            <div class="text-xs opacity-75 mt-1"> Instant - no download</div>
                        </button>
                        <button onclick="downloadICS(${apt.id})" class="btn btn-secondary w-full">
                            <i class="fas fa-apple mr-2"></i>Apple Calendar / Other
                            <div class="text-xs opacity-75 mt-1"> Downloads file</div>
                        </button>
                    </div>

                    <div class="text-xs p-3 rounded" style="background: var(--bg-tertiary); color: var(--text-secondary);">
                        <div class="font-semibold mb-1"><i class="fas fa-apple mr-1"></i> iPhone users:</div>
                        1. Tap "Apple Calendar"<br>
                        2. Save to Files<br>
                        3. Open Files app  Tap the .ics file<br>
                        4. Tap "Add to Calendar"  Done! 
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Close</button>
            `;

            showModal('Add to Calendar', content, buttons);
        }

        function createGoogleCalendarUrl(apt, client, startDate, endDate) {
            // Format dates for Google Calendar (YYYYMMDDTHHMMSS)
            const formatGoogleDate = (date) => {
                const pad = (n) => n.toString().padStart(2, '0');
                return date.getFullYear() +
                       pad(date.getMonth() + 1) +
                       pad(date.getDate()) + 'T' +
                       pad(date.getHours()) +
                       pad(date.getMinutes()) +
                       pad(date.getSeconds());
            };

            const petsList = apt.pets.map(pet => {
                const serviceNames = pet.items.map(item => {
                    const svc = item.type === 'service' ?
                        services.find(s => s.id === item.id) :
                        items.find(i => i.id === item.id);
                    return svc ? svc.name : '';
                }).filter(s => s).join(', ');
                return `${pet.name}: ${serviceNames}`;
            }).join('\\n');

            const description = `Grooming appointment\\n\\nPets:\\n${petsList}${apt.notes ? '\\n\\nNotes: ' + apt.notes : ''}\\n\\nClient Contact:\\nPhone: ${client.phone}\\nEmail: ${client.email}`;

            const params = new URLSearchParams({
                action: 'TEMPLATE',
                text: `${client.name} - Grooming`,
                dates: `${formatGoogleDate(startDate)}/${formatGoogleDate(endDate)}`,
                details: description,
                location: client.address,
                trp: 'false' // Don't show "guests can modify" option
            });

            return `https://calendar.google.com/calendar/render?${params.toString()}`;
        }

        function createOutlookCalendarUrl(apt, client, startDate, endDate) {
            const petsList = apt.pets.map(pet => {
                const serviceNames = pet.items.map(item => {
                    const svc = item.type === 'service' ?
                        services.find(s => s.id === item.id) :
                        items.find(i => i.id === item.id);
                    return svc ? svc.name : '';
                }).filter(s => s).join(', ');
                return `${pet.name}: ${serviceNames}`;
            }).join('\\n');

            const description = `Grooming appointment\\n\\nPets:\\n${petsList}${apt.notes ? '\\n\\nNotes: ' + apt.notes : ''}\\n\\nClient Contact:\\nPhone: ${client.phone}\\nEmail: ${client.email}`;

            const params = new URLSearchParams({
                path: '/calendar/action/compose',
                rru: 'addevent',
                subject: `${client.name} - Grooming`,
                startdt: startDate.toISOString(),
                enddt: endDate.toISOString(),
                body: description,
                location: client.address
            });

            return `https://outlook.live.com/calendar/0/deeplink/compose?${params.toString()}`;
        }

        function downloadICS(aptId) {
            const apt = appointments.find(a => a.id === aptId);
            const client = clients.find(c => c.id === apt.clientId);

            if (!apt || !client) {
                showAlert('Error: Appointment or client not found');
                return;
            }

            const icsContent = generateICS(apt, client);

            // Create download
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `appointment-${client.name.replace(/\s/g, '_')}-${apt.date.toISOString().split('T')[0]}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            // Close the modal
            const modal = document.querySelector('.modal-overlay');
            if (modal) modal.remove();

            showAlert(' File saved! Open Files app and tap the .ics file to add to your calendar.');
        }

        function exportAllAppointments() {
            if (appointments.length === 0) {
                showAlert('No appointments to export');
                return;
            }

            // Show modal with calendar options
            showExportAllModal();
        }

        function showExportAllModal() {
            const appointmentCount = appointments.length;

            // Get date range
            const sortedApts = [...appointments].sort((a, b) => new Date(a.date) - new Date(b.date));
            const firstDate = new Date(sortedApts[0].date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const lastDate = new Date(sortedApts[sortedApts.length - 1].date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

            // Create Google Calendar URL for importing
            const googleImportUrl = 'https://calendar.google.com/calendar/r/settings/export';

            const content = `
                <div class="space-y-4">
                    <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                        <div class="font-bold mb-2">${appointmentCount} Appointment${appointmentCount > 1 ? 's' : ''}</div>
                        <div class="text-sm"><i class="fas fa-calendar-range mr-2"></i>${firstDate} - ${lastDate}</div>
                    </div>

                    <div class="text-sm font-semibold mb-2">Add to your calendar:</div>

                    <div class="grid grid-cols-1 gap-2">
                        <button onclick="downloadAllICS(); showGoogleImportInstructions();" class="btn btn-primary w-full">
                            <i class="fab fa-google mr-2"></i>Google Calendar
                            <div class="text-xs opacity-75 mt-1"> Download then import</div>
                        </button>
                        <button onclick="downloadAllICS(); showOutlookImportInstructions();" class="btn btn-secondary w-full">
                            <i class="fab fa-microsoft mr-2"></i>Outlook Calendar
                            <div class="text-xs opacity-75 mt-1"> Download then import</div>
                        </button>
                        <button onclick="downloadAllICS()" class="btn btn-secondary w-full">
                            <i class="fas fa-apple mr-2"></i>Apple Calendar / Other
                            <div class="text-xs opacity-75 mt-1"> Downloads file</div>
                        </button>
                    </div>

                    <div class="text-xs p-3 rounded" style="background: var(--bg-tertiary); color: var(--text-secondary);">
                        <div class="font-semibold mb-1"><i class="fas fa-info-circle mr-1"></i> How it works:</div>
                        1. Download the calendar file (.ics)<br>
                        2. Import it to your calendar app<br>
                        3. All ${appointmentCount} appointments will be added! 
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Close</button>
            `;

            showModal('Export All Appointments', content, buttons);
        }

        function downloadAllICS() {
            const now = new Date();
            const timestamp = now.getFullYear() +
                             (now.getMonth() + 1).toString().padStart(2, '0') +
                             now.getDate().toString().padStart(2, '0') + 'T' +
                             now.getHours().toString().padStart(2, '0') +
                             now.getMinutes().toString().padStart(2, '0') +
                             now.getSeconds().toString().padStart(2, '0');

            // Build ICS with all appointments
            let icsEvents = [];

            appointments.forEach(apt => {
                const client = clients.find(c => c.id === apt.clientId);
                if (!client) return;

                const aptDate = new Date(apt.date);
                const totalMinutes = apt.pets.reduce((sum, pet) => {
                    return sum + pet.items.reduce((itemSum, item) => {
                        const serviceOrItem = [...services, ...items].find(s => s.id === item.id && s.type === item.type);
                        return itemSum + (serviceOrItem?.duration || 30);
                    }, 0);
                }, 0);

                const endDate = new Date(aptDate.getTime() + totalMinutes * 60000);

                const formatICSDate = (date) => {
                    const pad = (n) => n.toString().padStart(2, '0');
                    return date.getFullYear() +
                           pad(date.getMonth() + 1) +
                           pad(date.getDate()) + 'T' +
                           pad(date.getHours()) +
                           pad(date.getMinutes()) +
                           pad(date.getSeconds());
                };

                const startTime = formatICSDate(aptDate);
                const endTime = formatICSDate(endDate);

                const petsList = apt.pets.map(pet => {
                    const serviceNames = pet.items.map(item => {
                        const svc = item.type === 'service' ?
                            services.find(s => s.id === item.id) :
                            items.find(i => i.id === item.id);
                        return svc ? svc.name : '';
                    }).filter(s => s).join(', ');
                    return `${pet.name}: ${serviceNames}`;
                }).join('\\n');

                const description = `Grooming appointment for ${client.name}\\n\\nPets:\\n${petsList}${apt.notes ? '\\n\\nNotes: ' + apt.notes : ''}\\n\\nClient: ${client.phone}\\n${client.address}`;

                icsEvents.push([
                    'BEGIN:VEVENT',
                    'UID:' + apt.id + '@mayagroompro.app',
                    'DTSTAMP:' + timestamp,
                    'DTSTART:' + startTime,
                    'DTEND:' + endTime,
                    'SUMMARY:' + client.name + ' - ' + appointment.pets.map(p => p.name).join(', '),
                    'DESCRIPTION:' + description,
                    'LOCATION:' + client.address,
                    'STATUS:' + (apt.status === 'confirmed' ? 'CONFIRMED' : 'TENTATIVE'),
                    'SEQUENCE:0',
                    'BEGIN:VALARM',
                    'TRIGGER:-PT1H',
                    'DESCRIPTION:Appointment in 1 hour',
                    'ACTION:DISPLAY',
                    'END:VALARM',
                    'END:VEVENT'
                ].join('\r\n'));
            });

            const ics = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Maya Groom Pro//Appointments//EN',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                'X-WR-CALNAME:Maya Groom Pro Appointments',
                'X-WR-TIMEZONE:' + Intl.DateTimeFormat().resolvedOptions().timeZone,
                ...icsEvents,
                'END:VCALENDAR'
            ].join('\r\n');

            // Create download
            const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `maya-groom-pro-appointments-${new Date().toISOString().split('T')[0]}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showAlert(` Downloaded ${appointments.length} appointment(s)!`);
        }

        function showGoogleImportInstructions() {
            setTimeout(() => {
                const content = `
                    <div class="space-y-3">
                        <div class="text-sm font-semibold mb-2">Next steps to import to Google Calendar:</div>
                        <ol class="text-sm space-y-2 list-decimal list-inside">
                            <li>Open <a href="https://calendar.google.com/calendar/r/settings/export" target="_blank" class="text-blue-600 underline">Google Calendar Settings</a></li>
                            <li>Click "Import & Export" on the left</li>
                            <li>Click "Select file from your computer"</li>
                            <li>Choose the downloaded .ics file</li>
                            <li>Click "Import"</li>
                            <li>All appointments will appear! </li>
                        </ol>
                        <div class="p-3 rounded text-xs" style="background: var(--bg-tertiary);">
                            <i class="fas fa-mobile mr-1"></i> On iPhone: File is in Files app, follow steps above in mobile browser
                        </div>
                    </div>
                `;
                const buttons = `<button onclick="this.closest('.modal-overlay').remove()" class="btn btn-primary">Got it!</button>`;
                showModal('Import to Google Calendar', content, buttons);
            }, 500);
        }

        function showOutlookImportInstructions() {
            setTimeout(() => {
                const content = `
                    <div class="space-y-3">
                        <div class="text-sm font-semibold mb-2">Next steps to import to Outlook:</div>
                        <ol class="text-sm space-y-2 list-decimal list-inside">
                            <li>Open Outlook Calendar</li>
                            <li>Click "File"  "Open & Export"  "Import/Export"</li>
                            <li>Select "Import an iCalendar (.ics) file"</li>
                            <li>Choose the downloaded .ics file</li>
                            <li>Click "Import"</li>
                            <li>All appointments will appear! </li>
                        </ol>
                        <div class="p-3 rounded text-xs" style="background: var(--bg-tertiary);">
                            <i class="fas fa-mobile mr-1"></i> On iPhone: Open file in Outlook app
                        </div>
                    </div>
                `;
                const buttons = `<button onclick="this.closest('.modal-overlay').remove()" class="btn btn-primary">Got it!</button>`;
                showModal('Import to Outlook', content, buttons);
            }, 500);
        }

        function exportClientToContacts(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            // Generate vCard (VCF format)
            const vcard = generateVCard(client);

            // Create blob and download
            const blob = new Blob([vcard], { type: 'text/vcard;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${client.name.replace(/\s+/g, '_')}.vcf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            // Show instructions
            setTimeout(() => {
                const content = `
                    <div class="space-y-4">
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                            <div class="font-bold mb-2">${client.name}</div>
                            <div class="text-sm mb-1"><i class="fas fa-phone mr-2"></i>${client.phone}</div>
                            <a href="mailto:${client.email}" class="text-sm cursor-pointer hover:text-blue-600 transition-colors block" onclick="event.stopPropagation();"><i class="fas fa-envelope mr-2"></i>${client.email}</a>
                        </div>

                        <div class="text-sm font-semibold">Contact saved! </div>

                        <div class="p-4 rounded-lg text-sm space-y-2" style="background: var(--bg-tertiary);">
                            <div class="font-semibold mb-2"><i class="fas fa-apple mr-2"></i>On iPhone:</div>
                            <ol class="list-decimal list-inside space-y-1 ml-2">
                                <li>Save file to Files app</li>
                                <li>Open Files app</li>
                                <li>Tap the .vcf file</li>
                                <li>Tap "Add to Contacts"</li>
                                <li>Done! </li>
                            </ol>
                        </div>

                        <div class="p-4 rounded-lg text-sm space-y-2" style="background: var(--bg-tertiary);">
                            <div class="font-semibold mb-2"><i class="fab fa-android mr-2"></i>On Android:</div>
                            <ol class="list-decimal list-inside space-y-1 ml-2">
                                <li>Open the downloaded .vcf file</li>
                                <li>Choose "Contacts" app</li>
                                <li>Tap "Import"</li>
                                <li>Done! </li>
                            </ol>
                        </div>

                        <div class="text-xs p-3 rounded" style="background: var(--bg-primary); color: var(--text-tertiary); border: 1px solid var(--border);">
                            <i class="fas fa-info-circle mr-1"></i> The contact will include name, phone, email, and address
                        </div>
                    </div>
                `;

                const buttons = `<button onclick="this.closest('.modal-overlay').remove()" class="btn btn-primary">Got it!</button>`;
                showModal('Export to Contacts', content, buttons);
            }, 300);
        }

        function generateVCard(client) {
            // vCard 3.0 format (widely supported)
            let vcard = 'BEGIN:VCARD\r\n';
            vcard += 'VERSION:3.0\r\n';

            // Name
            const nameParts = client.name.split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';
            vcard += `N:${lastName};${firstName};;;\r\n`;
            vcard += `FN:${client.name}\r\n`;

            // Phone
            if (client.phone) {
                const cleanPhone = client.phone.replace(/\s/g, '');
                vcard += `TEL;TYPE=CELL:${cleanPhone}\r\n`;
            }

            // Email
            if (client.email) {
                vcard += `EMAIL;TYPE=INTERNET:${client.email}\r\n`;
            }

            // Address
            if (client.address) {
                // Format: ADR;TYPE=HOME:;;street;city;state;postal;country
                vcard += `ADR;TYPE=HOME:;;${client.address};;;;\r\n`;
            }

            // Add note with pet information
            if (client.pets && client.pets.length > 0) {
                const petsInfo = client.pets.map(pet => {
                    return `${pet.name} (${pet.breed}, ${pet.age} yrs)${pet.notes ? ' - ' + pet.notes : ''}`;
                }).join('; ');
                vcard += `NOTE:Pets: ${petsInfo}\r\n`;
            }

            // Organization
            vcard += `ORG:${settings.businessName}\r\n`;

            vcard += 'END:VCARD\r\n';

            return vcard;
        }

        function exportAllContactsToCSV() {
            if (clients.length === 0) {
                showAlert('No contacts to export');
                return;
            }

            // Create CSV header
            const headers = ['Name', 'Surname', 'Email', 'Phone', 'Address', 'Pet Name', 'Pet Breed', 'Pet Age', 'Pet Notes'];
            const csvRows = [headers.join(',')];

            // Helper function to split full name into first name and surname
            function splitName(fullName) {
                const parts = (fullName || '').trim().split(/\s+/);
                if (parts.length <= 1) {
                    return { firstName: parts[0] || '', surname: '' };
                }
                const firstName = parts[0];
                const surname = parts.slice(1).join(' ');
                return { firstName, surname };
            }

            // Add each client - one row per pet
            clients.forEach(client => {
                const { firstName, surname } = splitName(client.name);
                if (client.pets && client.pets.length > 0) {
                    client.pets.forEach(pet => {
                        const row = [
                            `"${firstName}"`,
                            `"${surname}"`,
                            `"${client.email || ''}"`,
                            `"${client.phone || ''}"`,
                            `"${(client.address || '').replace(/"/g, '""')}"`,
                            `"${pet.name || ''}"`,
                            `"${pet.breed || ''}"`,
                            pet.age || '',
                            `"${(pet.notes || '').replace(/"/g, '""')}"`
                        ];
                        csvRows.push(row.join(','));
                    });
                } else {
                    // Client with no pets
                    const row = [
                        `"${firstName}"`,
                        `"${surname}"`,
                        `"${client.email || ''}"`,
                        `"${client.phone || ''}"`,
                        `"${(client.address || '').replace(/"/g, '""')}"`,
                        '', '', '', ''
                    ];
                    csvRows.push(row.join(','));
                }
            });

            // Create and download CSV
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;

            // Generate filename with current date
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
            link.download = `Maya_Groom_Pro_Contacts_${dateStr}.csv`;

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showAlert(` Exported ${clients.length} contacts to CSV file!`);
        }

        function openImportClientsModal() {
            const content = `
                <div class="space-y-4">
                    <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                        <div class="font-semibold mb-2">Supported CSV Formats:</div>
                        <div class="text-sm space-y-2" style="color: var(--text-secondary);">
                            <div><strong>Square Export:</strong> Auto-detected from Square Customers export</div>
                            <div><strong>Maya Groom Pro:</strong> Name, Surname, Email, Phone, Address, Pet Name, Pet Breed, Pet Age, Pet Notes</div>
                        </div>
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold" style="color: var(--text-primary);">Select CSV File</label>
                        <input type="file" id="csvFileInput" accept=".csv" class="w-full p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 1.125rem;">
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
                <button onclick="importClientsFromCSV()" class="btn btn-primary">Import Clients</button>
            `;

            showModal('Import Clients from CSV', content, buttons);
        }

        function importClientsFromCSV() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];

            if (!file) {
                showAlert('Please select a CSV file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');

                    if (lines.length < 2) {
                        showAlert('CSV file is empty or invalid');
                        return;
                    }

                    // Detect format by checking header row
                    const headerLine = lines[0].trim();
                    const headerFields = parseCSVLine(headerLine);
                    const isSquareFormat = headerFields.some(h =>
                        h.toLowerCase().includes('square customer id') ||
                        h.toLowerCase().includes('street address 1') ||
                        h.toLowerCase().includes('creation source')
                    );

                    let importedClients = 0;
                    let importedPets = 0;
                    let skippedDeleted = 0;
                    const clientMap = new Map(); // Track clients by name to avoid duplicates

                    if (isSquareFormat) {
                        // Square CSV format parsing
                        // Detect column indices from header
                        const headerLower = headerFields.map(h => h.toLowerCase().trim());
                        const colFirstName = headerLower.findIndex(h => h === 'first name');
                        const colSurname = headerLower.findIndex(h => h === 'surname' || h === 'last name');
                        const colEmail = headerLower.findIndex(h => h.includes('email'));
                        const colPhone = headerLower.findIndex(h => h.includes('phone'));
                        const colStreet1 = headerLower.findIndex(h => h === 'street address 1');
                        const colStreet2 = headerLower.findIndex(h => h === 'street address 2');
                        const colCity = headerLower.findIndex(h => h === 'city');
                        const colState = headerLower.findIndex(h => h === 'state');
                        const colPostal = headerLower.findIndex(h => h === 'postal code');
                        const colMemo = headerLower.findIndex(h => h === 'memo');

                        for (let i = 1; i < lines.length; i++) {
                            try {
                                const line = lines[i];
                                if (!line || !line.trim()) continue;

                                const fields = parseCSVLine(line.trim());
                                if (!fields || fields.length < 4) continue;

                                // Get first name and surname
                                let firstName = colFirstName >= 0 ? (fields[colFirstName] || '').trim() : '';
                                let surname = colSurname >= 0 ? (fields[colSurname] || '').trim() : '';

                                // Clean surname - extract just the name part if it contains pet info in parentheses
                                let petInfo = '';
                                if (surname.includes('(')) {
                                    const match = surname.match(/^([^(]+)\s*\((.+)\)\s*$/);
                                    if (match) {
                                        surname = match[1].trim();
                                        petInfo = match[2].trim();
                                    }
                                }

                                let clientName = (firstName + ' ' + surname).trim();

                                // Skip deleted customers (marked with **DELETED**)
                                if (clientName.includes('**DELETED**') || firstName.includes('**DELETED**')) {
                                    skippedDeleted++;
                                    continue;
                                }

                                // Clean phone number (remove leading apostrophe if present)
                                let phone = colPhone >= 0 ? ((fields[colPhone] || '').trim()).replace(/^'+/, '') : '';

                                const email = colEmail >= 0 ? (fields[colEmail] || '').trim() : '';
                                const streetAddress1 = colStreet1 >= 0 ? (fields[colStreet1] || '').trim() : '';
                                const streetAddress2 = colStreet2 >= 0 ? (fields[colStreet2] || '').trim() : '';
                                const city = colCity >= 0 ? (fields[colCity] || '').trim() : '';
                                const state = colState >= 0 ? (fields[colState] || '').trim() : '';
                                const postalCode = colPostal >= 0 ? (fields[colPostal] || '').trim() : '';
                                const memo = colMemo >= 0 ? (fields[colMemo] || '').trim() : '';

                                // Build full address
                                let addressParts = [];
                                if (streetAddress1) addressParts.push(streetAddress1);
                                if (streetAddress2) addressParts.push(streetAddress2);
                                if (city) addressParts.push(city);
                                if (state) addressParts.push(state);
                                if (postalCode) addressParts.push(postalCode);
                                const address = addressParts.join(', ');

                                if (!clientName) continue;

                                // Check if client already exists
                                let client = clientMap.get(clientName.toLowerCase());

                                if (!client) {
                                    client = clients.find(c => c.name && c.name.toLowerCase() === clientName.toLowerCase());

                                    if (!client) {
                                        const newClientId = clients.length > 0 ? Math.max(...clients.map(c => c.id || 0)) + 1 : 1;
                                        client = {
                                            id: newClientId,
                                            name: clientName,
                                            email: email,
                                            phone: phone,
                                            address: address,
                                            notes: memo,
                                            pets: []
                                        };

                                        // Parse pet info from surname field like "Breed - PetName" or "PetName"
                                        if (petInfo) {
                                            // Handle formats like "Maltese - Linsay" or "Groodle - Loui & Alfie"
                                            const petParts = petInfo.split(' - ');
                                            if (petParts.length >= 2) {
                                                const breed = petParts[0].trim();
                                                const petNames = petParts.slice(1).join(' - ').trim();
                                                // Handle multiple pets separated by & or ,
                                                const individualPets = petNames.split(/\s*[&,]\s*/);
                                                individualPets.forEach(petName => {
                                                    if (petName.trim()) {
                                                        client.pets.push({
                                                            name: petName.trim(),
                                                            breed: breed,
                                                            age: 0,
                                                            notes: ''
                                                        });
                                                        importedPets++;
                                                    }
                                                });
                                            } else {
                                                // Just pet name, no breed specified
                                                client.pets.push({
                                                    name: petInfo.trim(),
                                                    breed: '',
                                                    age: 0,
                                                    notes: ''
                                                });
                                                importedPets++;
                                            }
                                        }

                                        clients.push(client);
                                        importedClients++;
                                    }

                                    clientMap.set(clientName.toLowerCase(), client);
                                }
                            } catch (lineError) {
                                console.error('Error parsing line ' + i + ':', lineError);
                                continue; // Skip problematic lines
                            }
                        }

                        renderClients();
                        const modal = document.querySelector('.modal-overlay');
                        if (modal) modal.remove();
                        let message = ` Successfully imported ${importedClients} clients`;
                        if (importedPets > 0) {
                            message += ` and ${importedPets} pets`;
                        }
                        message += ` from Square!`;
                        if (skippedDeleted > 0) {
                            message += `\n(Skipped ${skippedDeleted} deleted customers)`;
                        }
                        showAlert(message);
                        return;
                    }

                    // Maya Groom Pro format (Name, Surname, Email, Phone, Address, Pet fields...)
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        // Parse CSV line (handle quoted fields)
                        const fields = parseCSVLine(line);

                        if (fields.length < 5) continue; // Need at least name, surname, email, phone, address

                        const firstName = fields[0].trim();
                        const surname = fields[1].trim();
                        const email = fields[2].trim();
                        const phone = fields[3].trim();
                        const address = fields[4].trim();
                        const petName = fields[5]?.trim() || '';
                        const petBreed = fields[6]?.trim() || '';
                        const petAge = fields[7]?.trim() || '';
                        const petNotes = fields[8]?.trim() || '';

                        // Combine first name and surname
                        const clientName = surname ? `${firstName} ${surname}`.trim() : firstName;

                        if (!clientName) continue;

                        // Check if client already exists in our map
                        let client = clientMap.get(clientName.toLowerCase());

                        if (!client) {
                            // Find if client already exists in the app
                            client = clients.find(c => c.name.toLowerCase() === clientName.toLowerCase());

                            if (!client) {
                                // Create new client
                                const newClientId = clients.length > 0 ? Math.max(...clients.map(c => c.id)) + 1 : 1;
                                client = {
                                    id: newClientId,
                                    name: clientName,
                                    email: email,
                                    phone: phone,
                                    address: address,
                                    pets: []
                                };
                                clients.push(client);
                                importedClients++;
                            }

                            clientMap.set(clientName.toLowerCase(), client);
                        }

                        // Add pet if pet name exists
                        if (petName) {
                            const pet = {
                                name: petName,
                                breed: petBreed,
                                age: petAge,
                                notes: petNotes
                            };
                            client.pets.push(pet);
                            importedPets++;
                        }
                    }

                    renderClients();
                    const modal2 = document.querySelector('.modal-overlay');
                    if (modal2) modal2.remove();
                    showAlert(` Successfully imported ${importedClients} clients and ${importedPets} pets!`);

                } catch (error) {
                    console.error('Import error:', JSON.stringify(error.message || error));
                    showAlert('Error importing CSV file: ' + (error.message || 'Unknown error. Please check format.'));
                }
            };

            reader.onerror = function() {
                showAlert('Error reading file. Please try again.');
            };

            reader.readAsText(file);
        }

        function parseCSVLine(line) {
            const fields = [];
            let field = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Escaped quote
                        field += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // Field separator
                    fields.push(field);
                    field = '';
                } else {
                    field += char;
                }
            }

            // Add last field
            fields.push(field);

            return fields;
        }

        function previousWeek() {
            // Keep the same day of the week (adjusted for Monday-first: Mon=0, Sun=6)
            const dayOfWeek = selectedDate.getDay();
            const adjustedDayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

            weekStartDate.setDate(weekStartDate.getDate() - 7);
            currentDate = new Date(weekStartDate);

            // Set selectedDate to same day of week in new week
            selectedDate = new Date(weekStartDate);
            selectedDate.setDate(selectedDate.getDate() + adjustedDayOfWeek);

            renderWeekTimeline();
            updateMonthYearDisplay();
        }

        function nextWeek() {
            // Keep the same day of the week (adjusted for Monday-first: Mon=0, Sun=6)
            const dayOfWeek = selectedDate.getDay();
            const adjustedDayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

            weekStartDate.setDate(weekStartDate.getDate() + 7);
            currentDate = new Date(weekStartDate);

            // Set selectedDate to same day of week in new week
            selectedDate = new Date(weekStartDate);
            selectedDate.setDate(selectedDate.getDate() + adjustedDayOfWeek);

            renderWeekTimeline();
            updateMonthYearDisplay();
        }

        // Swipe functionality for week navigation
        let weekSwipeStartX = 0;
        let weekSwipeEndX = 0;
        let weekSwipeInitialized = false;

        function setupWeekSwipe() {
            // Only setup once to avoid multiple event listeners
            if (weekSwipeInitialized) return;

            const weekContainer = document.getElementById('weekDaysNav');
            if (!weekContainer) return;

            weekSwipeInitialized = true;

            weekContainer.addEventListener('touchstart', (e) => {
                weekSwipeStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            weekContainer.addEventListener('touchend', (e) => {
                weekSwipeEndX = e.changedTouches[0].screenX;
                handleWeekSwipe();
            }, { passive: true });
        }

        function handleWeekSwipe() {
            const swipeThreshold = 50;
            const diff = weekSwipeStartX - weekSwipeEndX;

            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    // Swiped left - next week
                    nextWeek();
                } else {
                    // Swiped right - previous week
                    previousWeek();
                }
            }
        }

        // Helper functions to open native apps
        function openSMS(phone) {
            const cleanPhone = phone.replace(/\s/g, '');
            const smsUrl = `sms:${cleanPhone}`;

            // Create a temporary link and click it
            const link = document.createElement('a');
            link.href = smsUrl;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            document.body.appendChild(link);
            link.click();

            setTimeout(() => {
                document.body.removeChild(link);
            }, 100);
        }

        function showPhoneOptions(phone) {
            const cleanPhone = phone.replace(/\s/g, '');

            const content = `
                <div class="space-y-3">
                    <div class="p-4 rounded-lg text-center" style="background: var(--bg-tertiary);">
                        <div class="text-2xl font-bold mono">${phone}</div>
                    </div>
                    <div class="grid grid-cols-1 gap-2">
                        <button onclick="openLink('tel:${cleanPhone}')" class="btn btn-primary w-full">
                            <i class="fas fa-phone mr-2"></i>Call
                        </button>
                        <button onclick="openLink('sms:${cleanPhone}')" class="btn btn-secondary w-full">
                            <i class="fas fa-message mr-2"></i>Send SMS
                        </button>
                        <button onclick="copyToClipboard('${phone.replace(/'/g, "\\'")}'); showAlert('Phone number copied!');" class="btn btn-secondary w-full">
                            <i class="fas fa-copy mr-2"></i>Copy Number
                        </button>
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
            `;

            showModal('Contact', content, buttons);
        }

        function openMaps(address) {
            const encodedAddress = encodeURIComponent(address);

            const content = `
                <div class="space-y-3">
                    <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                        <div class="text-sm">${address}</div>
                    </div>
                    <div class="grid grid-cols-1 gap-2">
                        <button onclick="openMapApp('apple', '${encodedAddress}')" class="btn btn-primary w-full">
                            <i class="fas fa-map mr-2"></i>Apple Maps
                        </button>
                        <button onclick="openMapApp('google', '${encodedAddress}')" class="btn btn-secondary w-full">
                            <i class="fas fa-map-location-dot mr-2"></i>Google Maps
                        </button>
                        <button onclick="openMapApp('waze', '${encodedAddress}')" class="btn btn-secondary w-full">
                            <i class="fas fa-route mr-2"></i>Waze
                        </button>
                        <button onclick="copyToClipboard('${address.replace(/'/g, "\\'")}'); showAlert('Address copied!');" class="btn btn-secondary w-full">
                            <i class="fas fa-copy mr-2"></i>Copy Address
                        </button>
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
            `;

            showModal('Open in Maps', content, buttons);
        }

        function processMessageTemplate(template, client, appointment) {
            // Format date and time
            const aptDate = new Date(appointment.date);
            const dateStr = aptDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            const timeStr = aptDate.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: !settings.use24HourClock
            });

            // Get services list
            const servicesList = appointment.pets.map(pet => {
                const servicesText = pet.items.map(item => {
                    if (item.type === 'service') {
                        const svc = services.find(s => s.id === item.id);
                        return svc ? svc.name : '';
                    } else {
                        const itm = items.find(i => i.id === item.id);
                        return itm ? itm.name : '';
                    }
                }).filter(s => s).join(', ');
                return `${pet.name}: ${servicesText}`;
            }).join('\n');

            const firstName = client.name.split(' ')[0];

            // Replace template variables
            return template
                .replace(/{clientFirstName}/g, firstName)
                .replace(/{clientName}/g, client.name)
                .replace(/{businessName}/g, settings.businessName)
                .replace(/{date}/g, dateStr)
                .replace(/{time}/g, timeStr)
                .replace(/{pets}/g, servicesList);
        }

        function sendBookingConfirmation(client, appointment) {
            // Use the booking template from settings
            const bookingMessage = processMessageTemplate(
                settings.messageTemplates.booking,
                client,
                appointment
            );

            const cleanPhone = client.phone.replace(/\s/g, '');
            const escapedMessage = bookingMessage.replace(/'/g, "\\'").replace(/\n/g, '\\n');

            const content = `
                <div class="space-y-4">
                    <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                        <div class="text-sm font-semibold mb-2">Send to: ${client.name}</div>
                        <div class="text-sm mb-3" style="color: var(--text-secondary);">${client.phone}</div>
                        <div class="text-sm whitespace-pre-wrap p-3 rounded" style="background: var(--bg-primary); border: 1px solid var(--border);">
${bookingMessage}
                        </div>
                    </div>
                    <div class="text-xs" style="color: var(--text-tertiary);">
                        <i class="fas fa-info-circle mr-1"></i>This will open your SMS app with the message pre-filled
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove();" class="btn btn-secondary">Skip</button>
                <button onclick="sendBookingSMS('${cleanPhone}', '${escapedMessage}')" class="btn btn-primary">
                    <i class="fas fa-message mr-2"></i>Send Booking Message
                </button>
            `;

            showModal('Send Booking Confirmation', content, buttons);
        }

        function sendBookingSMS(phone, message, clientId, aptId) {
            const decodedMessage = message.replace(/\\n/g, '\n').replace(/\\'/g, "'");
            const link = document.createElement('a');
            link.href = `sms:${phone}?&body=${encodeURIComponent(decodedMessage)}`;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            document.body.appendChild(link);
            link.click();
            setTimeout(() => {
                document.body.removeChild(link);
                // Close only the SMS modal, then re-open appointment details
                document.querySelectorAll('.modal-overlay').forEach(modal => modal.remove());
                if (aptId) {
                    setTimeout(() => showAppointmentDetails(aptId), 100);
                }
            }, 100);
        }

        function openLink(url) {
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            document.body.appendChild(link);
            link.click();
            setTimeout(() => {
                document.body.removeChild(link);
                const modal = document.querySelector('.modal-overlay');
                if (modal) modal.remove();
            }, 100);
        }

        function openMapApp(app, encodedAddress) {
            let mapsUrl;

            switch(app) {
                case 'apple':
                    // iOS Apple Maps - works on iPhone/iPad
                    mapsUrl = `http://maps.apple.com/?q=${encodedAddress}`;
                    break;
                case 'google':
                    // Google Maps - universal link that opens app if installed
                    mapsUrl = `https://maps.google.com/?q=${encodedAddress}`;
                    break;
                case 'waze':
                    // Waze deep link
                    mapsUrl = `https://waze.com/ul?q=${encodedAddress}&navigate=yes`;
                    break;
            }

            // Create a temporary link and click it
            const link = document.createElement('a');
            link.href = mapsUrl;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            document.body.appendChild(link);
            link.click();

            setTimeout(() => {
                document.body.removeChild(link);
                // Close the modal
                const modal = document.querySelector('.modal-overlay');
                if (modal) modal.remove();
            }, 100);
        }

        // Clients Functions
        function renderClients() {
            const list = document.getElementById('clientsList');

            if (clients.length === 0) {
                list.innerHTML = `
                    <div class="col-span-full text-center py-12" style="color: var(--text-tertiary);">
                        <i class="fas fa-users text-5xl mb-4"></i>
                        <p class="text-lg">No clients yet</p>
                        <p class="text-sm mt-2">Add your first client to get started</p>
                    </div>
                `;
                return;
            }

            // Filter clients based on search query
            const filteredClients = clients.filter(client => {
                if (!clientSearchQuery) return true;

                const searchLower = clientSearchQuery.toLowerCase();
                const nameMatch = client.name.toLowerCase().includes(searchLower);
                const phoneMatch = client.phone.toLowerCase().includes(searchLower);
                const emailMatch = client.email.toLowerCase().includes(searchLower);
                const petMatch = client.pets.some(pet => pet.name.toLowerCase().includes(searchLower));

                return nameMatch || phoneMatch || emailMatch || petMatch;
            });

            if (filteredClients.length === 0) {
                list.innerHTML = `
                    <div class="col-span-full text-center py-12" style="color: var(--text-tertiary);">
                        <i class="fas fa-search text-5xl mb-4"></i>
                        <p class="text-lg">No clients found</p>
                        <p class="text-sm mt-2">Try a different search term</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = filteredClients.map(client => `
                <div class="card card-hover" style="padding: 0.75rem;">
                    <div class="flex justify-between items-start mb-2">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold" style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-dark)); font-size: 0.75rem;">
                            ${client.name.charAt(0)}
                        </div>
                        <button onclick="editClient(${client.id})" class="p-1.5 rounded-lg hover:bg-opacity-10" style="background: var(--bg-tertiary);">
                            <i class="fas fa-ellipsis-vertical" style="font-size: 0.75rem;"></i>
                        </button>
                    </div>
                    <h3 class="font-bold mb-1" style="font-size: 0.875rem;">${client.name}</h3>
                    <div class="space-y-0.5 mb-2" style="color: var(--text-secondary); font-size: 0.688rem;">
                        <a href="mailto:${client.email}" class="cursor-pointer hover:text-blue-600 transition-colors block" onclick="event.stopPropagation();"><i class="fas fa-envelope w-3"></i> ${client.email}</a>
                        <div onclick="showPhoneOptions('${client.phone.replace(/'/g, "\\'")}'); event.stopPropagation();" class="cursor-pointer hover:text-blue-600 transition-colors">
                            <i class="fas fa-phone w-3"></i> ${client.phone}
                        </div>
                        <div onclick="openMaps('${client.address.replace(/'/g, "\\'")}'); event.stopPropagation();" class="cursor-pointer hover:text-blue-600 transition-colors">
                            <i class="fas fa-location-dot w-3"></i> ${client.address}
                        </div>
                    </div>
                    <div class="border-t pt-2" style="border-color: var(--border);">
                        <div class="font-semibold mb-1" style="color: var(--text-tertiary); font-size: 0.563rem;">PETS</div>
                        ${client.pets.map(pet => `
                            <div class="flex items-center gap-1.5 mb-1">
                                <i class="fas fa-paw" style="color: var(--accent-primary); font-size: 0.625rem;"></i>
                                <div class="flex-1">
                                    <div class="font-semibold" style="font-size: 0.688rem;">${pet.name}</div>
                                    <div style="color: var(--text-tertiary); font-size: 0.563rem;">${pet.breed}, ${pet.age} yrs</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="border-t pt-2 mt-2 space-y-1" style="border-color: var(--border);">
                        <button onclick="viewClientAppointments(${client.id})" class="btn btn-secondary w-full" style="padding: 0.375rem 0.5rem; font-size: 0.625rem;">
                            <i class="fas fa-calendar-days mr-1"></i>View Appointments
                        </button>
                        <button onclick="exportClientToContacts(${client.id})" class="btn btn-secondary w-full" style="padding: 0.375rem 0.5rem; font-size: 0.625rem;">
                            <i class="fas fa-address-card mr-1"></i>Export to Contacts
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function viewClientAppointments(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            const clientApts = appointments.filter(apt => apt.clientId === clientId);
            const now = new Date();

            const futureApts = clientApts.filter(apt => new Date(apt.date) >= now).sort((a, b) => new Date(a.date) - new Date(b.date));
            const pastApts = clientApts.filter(apt => new Date(apt.date) < now).sort((a, b) => new Date(b.date) - new Date(a.date));

            const formatAptDate = (date) => {
                const d = new Date(date);
                return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            };

            const formatAptTime = (date) => {
                const d = new Date(date);
                return d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: !settings.use24HourClock });
            };

            const renderAptList = (apts, title, emptyMsg) => {
                if (apts.length === 0) {
                    return `<p class="text-sm text-center py-4" style="color: var(--text-tertiary);">${emptyMsg}</p>`;
                }
                return `
                    <div class="space-y-2 max-h-64 overflow-y-auto">
                        ${apts.map(apt => {
                            const servicesText = apt.pets.map(pet => {
                                const serviceNames = pet.items.map(item => {
                                    const svc = item.type === 'service' ?
                                        services.find(s => s.id === item.id) :
                                        items.find(i => i.id === item.id);
                                    return svc ? svc.name : '';
                                }).filter(s => s).join(', ');
                                return `${pet.name}: ${serviceNames}`;
                            }).join('<br>');

                            const statusColors = {
                                pending: 'var(--warning)',
                                confirmed: 'var(--accent-primary)',
                                completed: 'var(--success)',
                                cancelled: 'var(--danger)'
                            };

                            return `
                                <div class="p-3 rounded-lg cursor-pointer hover:opacity-80 transition-opacity" style="background: var(--bg-tertiary);" onclick="openAppointmentDetails(${apt.id})">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="font-semibold">${formatAptDate(apt.date)}</div>
                                        <div class="text-xs px-2 py-1 rounded" style="background: ${statusColors[apt.status]}; color: white;">${apt.status}</div>
                                    </div>
                                    <div class="text-sm mb-1" style="color: var(--text-secondary);">
                                        <i class="fas fa-clock mr-1"></i>${formatAptTime(apt.date)}
                                    </div>
                                    <div class="text-xs" style="color: var(--text-tertiary);">${servicesText}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            };

            const content = `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                            <i class="fas fa-calendar-plus" style="color: var(--accent-primary);"></i>
                            Upcoming Appointments (${futureApts.length})
                        </h3>
                        ${renderAptList(futureApts, 'Upcoming', 'No upcoming appointments')}
                    </div>
                    <div class="border-t pt-4" style="border-color: var(--border);">
                        <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                            <i class="fas fa-calendar-check" style="color: var(--text-tertiary);"></i>
                            Past Appointments (${pastApts.length})
                        </h3>
                        ${renderAptList(pastApts, 'Past', 'No past appointments')}
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Close</button>
            `;

            showModal(`Appointments - ${client.name}`, content, buttons);
        }

        // Services Functions
        function filterServicesItems(filter) {
            servicesItemsFilter = filter;

            // Update button styles
            document.getElementById('filterAll').style.background = filter === 'all' ? 'var(--accent-primary)' : 'var(--bg-tertiary)';
            document.getElementById('filterAll').style.color = filter === 'all' ? 'white' : 'var(--text-secondary)';
            document.getElementById('filterServices').style.background = filter === 'service' ? 'var(--accent-primary)' : 'var(--bg-tertiary)';
            document.getElementById('filterServices').style.color = filter === 'service' ? 'white' : 'var(--text-secondary)';
            document.getElementById('filterItems').style.background = filter === 'item' ? 'var(--accent-primary)' : 'var(--bg-tertiary)';
            document.getElementById('filterItems').style.color = filter === 'item' ? 'white' : 'var(--text-secondary)';

            renderServices();
        }

        function renderServices() {
            const list = document.getElementById('servicesList');
            let allItems = [...services, ...items];

            // Apply filter
            if (servicesItemsFilter === 'service') {
                allItems = allItems.filter(item => item.type === 'service');
            } else if (servicesItemsFilter === 'item') {
                allItems = allItems.filter(item => item.type === 'item');
            }

            if (allItems.length === 0) {
                const emptyMessage = servicesItemsFilter === 'all'
                    ? 'No services or items yet'
                    : servicesItemsFilter === 'service'
                        ? 'No services yet'
                        : 'No items yet';
                const emptySubtext = servicesItemsFilter === 'all'
                    ? 'Add services and items you offer'
                    : servicesItemsFilter === 'service'
                        ? 'Add services you offer'
                        : 'Add items you sell';

                list.innerHTML = `
                    <div class="col-span-full text-center py-12" style="color: var(--text-tertiary);">
                        <i class="fas fa-${servicesItemsFilter === 'item' ? 'box' : 'scissors'} text-5xl mb-4"></i>
                        <p class="text-lg">${emptyMessage}</p>
                        <p class="text-sm mt-2">${emptySubtext}</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = allItems.map(item => {
                const isService = item.type === 'service';
                const priceWithGST = calculateTotalWithGST(item.price);

                return `
                    <div class="card card-hover" style="padding: 0.75rem;">
                        <div class="flex justify-between items-start mb-2">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: rgba(236, 72, 153, 0.1); color: var(--accent-primary);">
                                <i class="fas fa-${isService ? 'scissors' : 'box'}" style="font-size: 0.75rem;"></i>
                            </div>
                            <button onclick="editServiceOrItem(${item.id}, '${item.type}')" class="p-1.5 rounded-lg hover:bg-opacity-10" style="background: var(--bg-tertiary);">
                                <i class="fas fa-ellipsis-vertical" style="font-size: 0.75rem;"></i>
                            </button>
                        </div>
                        <div class="flex items-center gap-1 mb-1">
                            <h3 class="font-bold" style="font-size: 0.875rem;">${item.name}</h3>
                            <span class="badge badge-primary" style="font-size: 0.5rem; padding: 0.125rem 0.375rem;">${isService ? 'Service' : 'Item'}</span>
                        </div>
                        <p class="mb-2" style="color: var(--text-secondary); font-size: 0.688rem; line-height: 1.3;">${item.description}</p>
                        <div class="flex justify-between items-center">
                            ${isService ? `
                                <span class="badge badge-primary" style="font-size: 0.563rem; padding: 0.125rem 0.375rem;">
                                    <i class="fas fa-clock mr-1"></i>${item.duration} min
                                </span>
                            ` : '<div></div>'}
                            <div>
                                <div class="font-bold mono" style="color: var(--accent-primary); font-size: 0.938rem;">$${priceWithGST.toFixed(2)}</div>
                                ${settings.gstEnabled ? `<div style="color: var(--text-tertiary); font-size: 0.563rem;">inc. GST</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Waitlist Functions
        function renderWaitlist() {
            const container = document.getElementById('waitlistContainer');

            if (waitlist.length === 0) {
                container.innerHTML = `
                    <div class="card text-center py-12" style="color: var(--text-tertiary);">
                        <i class="fas fa-clock text-5xl mb-4"></i>
                        <p class="text-lg">Waitlist is empty</p>
                        <p class="text-sm mt-2">Add clients who are waiting for appointments</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = waitlist.map(item => {
                const client = clients.find(c => c.id === item.clientId);
                return `
                    <div class="card mb-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg mb-2">${client?.name || 'Unknown'}</h3>
                                <div class="text-sm mb-2" style="color: var(--text-secondary);">
                                    <i class="fas fa-dog mr-2"></i>${item.petName}
                                </div>
                                <div class="text-sm mb-2" style="color: var(--text-secondary);">
                                    <i class="fas fa-calendar mr-2"></i>Preferred: ${item.preferredDate || 'Any time'}
                                </div>
                                ${item.notes ? `<div class="text-sm" style="color: var(--text-tertiary);">${item.notes}</div>` : ''}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="scheduleFromWaitlist(${item.id})" class="btn btn-secondary btn-sm">
                                    <i class="fas fa-calendar-plus mr-2"></i>Schedule
                                </button>
                                <button onclick="removeFromWaitlist(${item.id})" class="btn btn-secondary btn-sm" style="color: var(--danger);">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Tab Switching
        function switchTab(tab) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

            // Reset all bottom nav buttons to inactive state
            document.getElementById('tabSchedule').style.color = 'var(--text-tertiary)';
            document.getElementById('tabClients').style.color = 'var(--text-tertiary)';
            document.getElementById('tabServices').style.color = 'var(--text-tertiary)';
            document.getElementById('tabWaitlist').style.color = 'var(--text-tertiary)';

            // Activate the selected tab button
            const tabId = 'tab' + tab.charAt(0).toUpperCase() + tab.slice(1);
            document.getElementById(tabId).style.color = 'var(--accent-primary)';

            // Show the selected content
            document.getElementById(tab + 'View').classList.remove('hidden');

            // If switching to schedule, scroll to current time
            if (tab === 'schedule') {
                renderDayTimeline();
            }
        }

        // Modal Functions
        function showModal(title, content, buttons) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="p-6 border-b" style="border-color: var(--border);">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold">${title}</h2>
                            <button onclick="this.closest('.modal-overlay').remove()" class="p-2 rounded-lg hover:bg-opacity-10" style="background: var(--bg-tertiary);">
                                <i class="fas fa-xmark text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        ${content}
                    </div>
                    <div class="p-6 border-t flex gap-3 justify-end flex-wrap" style="border-color: var(--border); padding-bottom: 2rem;">
                        ${buttons}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }

        function closeAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.remove());
        }

        // Menu Functions (Square Appointments style)
        function showScheduleMenu() {
            const content = `
                <div class="space-y-2">
                    <button onclick="this.closest('.modal-overlay').remove(); openNewAppointmentModal();" class="w-full text-left p-3 rounded-lg hover:bg-opacity-10 transition-all" style="background: var(--bg-tertiary);">
                        <div class="font-semibold" style="font-size: 1rem;">New Appointment</div>
                        <div style="color: var(--text-tertiary); font-size: 0.813rem;">Single appointment</div>
                    </button>
                    <button onclick="this.closest('.modal-overlay').remove(); showRecurringOptions();" class="w-full text-left p-3 rounded-lg hover:bg-opacity-10 transition-all" style="background: var(--bg-tertiary);">
                        <div class="font-semibold" style="font-size: 1rem;">Recurring Appointments</div>
                        <div style="color: var(--text-tertiary); font-size: 0.813rem;">Create a series of appointments</div>
                    </button>
                    <button onclick="this.closest('.modal-overlay').remove(); showRouteOptimization();" class="w-full text-left p-3 rounded-lg hover:bg-opacity-10 transition-all" style="background: var(--bg-tertiary);">
                        <div class="font-semibold" style="font-size: 1rem;">Today's Route</div>
                        <div style="color: var(--text-tertiary); font-size: 0.813rem;">Optimized route plan</div>
                    </button>
                    <button onclick="this.closest('.modal-overlay').remove(); openRevenueDashboard();" class="w-full text-left p-3 rounded-lg hover:bg-opacity-10 transition-all" style="background: var(--bg-tertiary);">
                        <div class="font-semibold" style="font-size: 1rem;">Revenue Dashboard</div>
                        <div style="color: var(--text-tertiary); font-size: 0.813rem;">View earnings & stats</div>
                    </button>
                    <button onclick="this.closest('.modal-overlay').remove(); exportAllAppointments();" class="w-full text-left p-3 rounded-lg hover:bg-opacity-10 transition-all" style="background: var(--bg-tertiary);">
                        <div class="font-semibold" style="font-size: 1rem;">Export All to Calendar</div>
                    </button>
                </div>
            `;
            showModal('Schedule Options', content, '');
        }

        function showClientsMenu() {
            const content = `
                <div class="space-y-2">
                    <button onclick="this.closest('.modal-overlay').remove(); openNewClientModal();" class="w-full text-left p-3 rounded-lg hover:bg-opacity-10 transition-all" style="background: var(--bg-tertiary);">
                        <div class="font-semibold" style="font-size: 1rem;">New Client</div>
                    </button>
                    <button onclick="this.closest('.modal-overlay').remove(); openImportClientsModal();" class="w-full text-left p-3 rounded-lg hover:bg-opacity-10 transition-all" style="background: var(--bg-tertiary);">
                        <div class="font-semibold" style="font-size: 1rem;">Import from CSV</div>
                    </button>
                    <button onclick="this.closest('.modal-overlay').remove(); exportAllContactsToCSV();" class="w-full text-left p-3 rounded-lg hover:bg-opacity-10 transition-all" style="background: var(--bg-tertiary);">
                        <div class="font-semibold" style="font-size: 1rem;">Export All to CSV</div>
                    </button>
                    <button onclick="this.closest('.modal-overlay').remove();" class="w-full text-left p-3 rounded-lg hover:bg-opacity-10 transition-all" style="background: var(--bg-tertiary); color: var(--text-tertiary);">
                        <div class="font-semibold" style="font-size: 1rem;">Cancel</div>
                    </button>
                </div>
            `;
            showModal('', content, '');
        }

        function showServicesMenu() {
            const content = `
                <div class="space-y-2">
                    <button onclick="this.closest('.modal-overlay').remove(); openNewServiceModal();" class="w-full text-left p-3 rounded-lg hover:bg-opacity-10 transition-all" style="background: var(--bg-tertiary);">
                        <div class="font-semibold" style="font-size: 1rem;">New Service</div>
                        <div style="color: var(--text-tertiary); font-size: 0.813rem;">Add a new grooming service</div>
                    </button>
                    <button onclick="this.closest('.modal-overlay').remove(); openNewItemModal();" class="w-full text-left p-3 rounded-lg hover:bg-opacity-10 transition-all" style="background: var(--bg-tertiary);">
                        <div class="font-semibold" style="font-size: 1rem;">New Item</div>
                        <div style="color: var(--text-tertiary); font-size: 0.813rem;">Add a retail item</div>
                    </button>
                    <button onclick="this.closest('.modal-overlay').remove(); showPackagesMenu();" class="w-full text-left p-3 rounded-lg hover:bg-opacity-10 transition-all" style="background: var(--bg-tertiary);">
                        <div class="font-semibold" style="font-size: 1rem;">Service Packages</div>
                        <div style="color: var(--text-tertiary); font-size: 0.813rem;">Create or view packages</div>
                    </button>
                </div>
            `;
            showModal('Services & Items', content, '');
        }

        function openNewAppointmentModal() {
            const allServicesAndItems = [...services, ...items];

            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Client</label>
                        <select id="aptClient" class="input-field" onchange="updatePetSelectionOptions()">
                            <option value="">Select client...</option>
                            ${clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Select Pets, Services & Items</label>
                        <div id="petSelectionContainer" class="space-y-2">
                            <p class="text-sm" style="color: var(--text-tertiary);">Select a client first</p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Date</label>
                        <input type="date" id="aptDate" class="input-field" value="${selectedDate.toISOString().split('T')[0]}">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Time</label>
                        <input type="time" id="aptTime" class="input-field" value="09:00">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Recurring</label>
                        <select id="aptRecurrence" class="input-field" onchange="toggleRecurrenceOptions()">
                            <option value="none">No recurrence</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="biweekly">Every 2 weeks</option>
                            <option value="monthly">Monthly</option>
                            <option value="custom">Custom frequency</option>
                        </select>
                    </div>
                    <div id="recurrenceOptions" class="hidden space-y-4">
                        <div id="customFrequencyOptions" class="hidden">
                            <label class="block text-sm font-semibold mb-2">Every</label>
                            <div class="flex gap-2">
                                <input type="number" id="aptCustomNumber" class="input-field flex-1" min="1" value="4" placeholder="4">
                                <select id="aptCustomUnit" class="input-field flex-1">
                                    <option value="days">Days</option>
                                    <option value="weeks" selected>Weeks</option>
                                    <option value="months">Months</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Repeat until</label>
                            <input type="date" id="aptRecurrenceEnd" class="input-field">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Notes</label>
                        <textarea id="aptNotes" class="input-field" rows="3" placeholder="Any special instructions..."></textarea>
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
                <button onclick="saveAppointment()" class="btn btn-primary">Create Appointment</button>
            `;

            showModal('New Appointment', content, buttons);
        }

        function updatePetSelectionOptions() {
            const clientId = parseInt(document.getElementById('aptClient').value);
            const client = clients.find(c => c.id === clientId);
            const container = document.getElementById('petSelectionContainer');
            const allServicesAndItems = [...services, ...items];

            if (client && client.pets) {
                container.innerHTML = client.pets.map((pet, petIdx) => `
                    <div class="p-3 rounded-lg" style="background: var(--bg-tertiary);">
                        <div class="flex items-start gap-3 mb-3">
                            <div class="checkbox-custom" onclick="togglePetCheckbox(${petIdx})" id="petCheck${petIdx}">
                                <i class="fas fa-check text-white text-xs" style="display: none;" id="petCheckIcon${petIdx}"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-semibold">${pet.name}</div>
                                <div class="text-xs mb-2" style="color: var(--text-tertiary);">${pet.breed}, ${pet.age} yrs</div>
                            </div>
                        </div>
                        <div id="petItems${petIdx}" class="ml-8 space-y-2" style="display: none;">
                            <div class="text-xs font-semibold mb-2" style="color: var(--text-tertiary);">SELECT SERVICES & ITEMS</div>
                            <div id="petItemsList${petIdx}" class="space-y-2"></div>
                            <button onclick="addItemToPet(${petIdx})" class="btn btn-secondary btn-sm w-full">
                                <i class="fas fa-plus mr-2"></i>Add Service/Item
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-sm" style="color: var(--text-tertiary);">Select a client first</p>';
            }
        }

        function togglePetCheckbox(petIdx) {
            const checkbox = document.getElementById(`petCheck${petIdx}`);
            const icon = document.getElementById(`petCheckIcon${petIdx}`);
            const itemsContainer = document.getElementById(`petItems${petIdx}`);

            const isChecked = checkbox.classList.contains('checked');

            if (isChecked) {
                checkbox.classList.remove('checked');
                icon.style.display = 'none';
                itemsContainer.style.display = 'none';
            } else {
                checkbox.classList.add('checked');
                icon.style.display = 'block';
                itemsContainer.style.display = 'block';
                // Add first item selector
                if (document.getElementById(`petItemsList${petIdx}`).children.length === 0) {
                    addItemToPet(petIdx);
                }
            }
        }

        let itemCounters = {};

        function addItemToPet(petIdx) {
            if (!itemCounters[petIdx]) itemCounters[petIdx] = 0;
            const itemIdx = itemCounters[petIdx]++;

            const allServicesAndItems = [...services, ...items];
            const container = document.getElementById(`petItemsList${petIdx}`);

            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex gap-2';
            itemDiv.id = `petItem${petIdx}_${itemIdx}`;
            itemDiv.innerHTML = `
                <select class="input-field flex-1" id="petItemSelect${petIdx}_${itemIdx}">
                    <option value="">Select service or item...</option>
                    ${allServicesAndItems.map(s => {
                        const priceWithGST = calculateTotalWithGST(s.price);
                        const duration = s.duration ? ` (${s.duration}min)` : '';
                        return `<option value="${s.id}_${s.type}">${s.name} - $${priceWithGST.toFixed(2)}${duration}</option>`;
                    }).join('')}
                </select>
                <button onclick="document.getElementById('petItem${petIdx}_${itemIdx}').remove()" class="btn btn-secondary btn-sm">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(itemDiv);
        }

        function toggleRecurrenceOptions() {
            const recurrence = document.getElementById('aptRecurrence').value;
            const options = document.getElementById('recurrenceOptions');
            const customOptions = document.getElementById('customFrequencyOptions');

            if (recurrence !== 'none') {
                options.classList.remove('hidden');
                if (recurrence === 'custom') {
                    customOptions.classList.remove('hidden');
                } else {
                    customOptions.classList.add('hidden');
                }
            } else {
                options.classList.add('hidden');
                customOptions.classList.add('hidden');
            }
        }

        function saveAppointment() {
            const clientId = parseInt(document.getElementById('aptClient').value);
            const date = document.getElementById('aptDate').value;
            const time = document.getElementById('aptTime').value;
            const notes = document.getElementById('aptNotes').value;
            const recurrence = document.getElementById('aptRecurrence').value;
            const recurrenceEnd = document.getElementById('aptRecurrenceEnd')?.value;

            if (!clientId || !date || !time) {
                showAlert('Please fill in all required fields');
                return;
            }

            if (recurrence !== 'none' && !recurrenceEnd) {
                showAlert('Please select an end date for recurring appointments');
                return;
            }

            const client = clients.find(c => c.id === clientId);
            const selectedPets = [];

            client.pets.forEach((pet, petIdx) => {
                const checkbox = document.getElementById(`petCheck${petIdx}`);
                if (checkbox && checkbox.classList.contains('checked')) {
                    const itemsList = document.getElementById(`petItemsList${petIdx}`);
                    const items = [];

                    if (itemsList) {
                        itemsList.querySelectorAll('select').forEach(select => {
                            if (select.value) {
                                const [id, type] = select.value.split('_');
                                items.push({ id: parseInt(id), type });
                            }
                        });
                    }

                    if (items.length > 0) {
                        selectedPets.push({ name: pet.name, items });
                    }
                }
            });

            if (selectedPets.length === 0) {
                showAlert('Please select at least one pet with services/items');
                return;
            }

            const appointmentDate = new Date(date + 'T' + time);

            // Create recurring appointments
            const appointmentsToCreate = [];

            if (recurrence === 'none') {
                appointmentsToCreate.push({
                    id: appointments.length + appointmentsToCreate.length + 1,
                    clientId,
                    pets: selectedPets,
                    date: new Date(appointmentDate),
                    status: 'pending',
                    notes,
                    isRecurring: false
                });
            } else {
                const endDate = new Date(recurrenceEnd);
                let currentDate = new Date(appointmentDate);
                let loopCount = 0;
                const maxIterations = 365; // Safety limit

                while (currentDate.getTime() <= endDate.getTime() && loopCount < maxIterations) {
                    appointmentsToCreate.push({
                        id: appointments.length + appointmentsToCreate.length + 1,
                        clientId,
                        pets: JSON.parse(JSON.stringify(selectedPets)),
                        date: new Date(currentDate),
                        status: 'pending',
                        notes,
                        isRecurring: true,
                        recurrenceType: recurrence
                    });

                    // Increment date based on recurrence type
                    switch (recurrence) {
                        case 'daily':
                            currentDate = new Date(currentDate.getTime() + 24 * 60 * 60 * 1000);
                            break;
                        case 'weekly':
                            currentDate = new Date(currentDate.getTime() + 7 * 24 * 60 * 60 * 1000);
                            break;
                        case 'biweekly':
                            currentDate = new Date(currentDate.getTime() + 14 * 24 * 60 * 60 * 1000);
                            break;
                        case 'monthly':
                            currentDate = new Date(currentDate.setMonth(currentDate.getMonth() + 1));
                            break;
                        case 'custom':
                            const customNumber = parseInt(document.getElementById('aptCustomNumber').value) || 1;
                            const customUnit = document.getElementById('aptCustomUnit').value;
                            if (customUnit === 'days') {
                                currentDate = new Date(currentDate.getTime() + customNumber * 24 * 60 * 60 * 1000);
                            } else if (customUnit === 'weeks') {
                                currentDate = new Date(currentDate.getTime() + customNumber * 7 * 24 * 60 * 60 * 1000);
                            } else if (customUnit === 'months') {
                                currentDate = new Date(currentDate.setMonth(currentDate.getMonth() + customNumber));
                            }
                            break;
                    }
                    loopCount++;
                }
            }

            appointments.push(...appointmentsToCreate);

            // Auto-remove client from waitlist if they have an entry
            const waitlistEntry = waitlist.find(w => w.clientId === clientId);
            if (waitlistEntry) {
                waitlist = waitlist.filter(w => w.id !== waitlistEntry.id);
                renderWaitlist();
            }

            itemCounters = {};
            document.querySelector('.modal-overlay').remove();
            renderWeekTimeline();
            renderCalendar();

            const message = recurrence === 'none'
                ? 'Appointment created successfully!'
                : `${appointmentsToCreate.length} recurring appointments created successfully!`;
            showAlert(message);

            // Offer to send booking confirmation
            if (client.phone) {
                setTimeout(() => {
                    sendBookingConfirmation(client, appointmentsToCreate[0]);
                }, 500);
            }
        }

        function openNewClientModal() {
            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Client Name</label>
                        <input type="text" id="clientName" class="input-field" placeholder="John Doe">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Email</label>
                        <input type="email" id="clientEmail" class="input-field" placeholder="john@email.com">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Phone</label>
                        <input type="tel" id="clientPhone" class="input-field" placeholder="0412 345 678">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Address</label>
                        <textarea id="clientAddress" class="input-field" rows="2" placeholder="123 Main Street, Sydney NSW 2000"></textarea>
                    </div>
                    <div class="border-t pt-4" style="border-color: var(--border);">
                        <label class="block text-sm font-semibold mb-2">Pet Information</label>
                        <div id="petsContainer">
                            <div class="pet-entry space-y-3 mb-4 p-4 rounded-lg" style="background: var(--bg-tertiary);">
                                <input type="text" placeholder="Pet name" class="input-field pet-name">
                                <input type="text" placeholder="Breed" class="input-field pet-breed">
                                <input type="number" placeholder="Age" class="input-field pet-age" min="0">
                                <textarea placeholder="Notes (e.g., temperament, allergies)" class="input-field pet-notes" rows="2"></textarea>
                            </div>
                        </div>
                        <button onclick="addPetEntry()" class="btn btn-secondary w-full">
                            <i class="fas fa-plus mr-2"></i>Add Another Pet
                        </button>
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
                <button onclick="saveClient()" class="btn btn-primary">Add Client</button>
            `;

            showModal('New Client', content, buttons);
        }

        async function importFromContacts() {
            // Check if Contact Picker API is supported
            // Note: As of 2024, Safari on iOS still has limited support for Contact Picker API
            // Even on latest iOS versions, it may not work due to Apple's privacy restrictions
            if (!('contacts' in navigator && 'ContactsManager' in window)) {
                showAlert(' Contact import is not available.\n\nThis feature requires:\n Safari browser on Android, or\n Chrome on Android\n\n(iOS Safari does not support contact import due to Apple privacy restrictions)\n\nPlease enter customer details manually.');
                return;
            }

            try {
                const props = ['name', 'email', 'tel', 'address'];
                const opts = { multiple: false };

                // Show loading state
                const importBtn = document.getElementById('importContactBtn');
                const originalText = importBtn.innerHTML;
                importBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Opening contacts...';
                importBtn.disabled = true;

                const contacts = await navigator.contacts.select(props, opts);

                if (contacts && contacts.length > 0) {
                    const contact = contacts[0];

                    // Fill in name
                    if (contact.name && contact.name.length > 0) {
                        const fullName = contact.name[0];
                        document.getElementById('clientName').value = fullName;
                    }

                    // Fill in email
                    if (contact.email && contact.email.length > 0) {
                        document.getElementById('clientEmail').value = contact.email[0];
                    }

                    // Fill in phone
                    if (contact.tel && contact.tel.length > 0) {
                        document.getElementById('clientPhone').value = contact.tel[0];
                    }

                    // Fill in address
                    if (contact.address && contact.address.length > 0) {
                        const addr = contact.address[0];
                        let addressParts = [];

                        if (addr.addressLine && addr.addressLine.length > 0) {
                            addressParts.push(...addr.addressLine);
                        }
                        if (addr.city) addressParts.push(addr.city);
                        if (addr.region) addressParts.push(addr.region);
                        if (addr.postalCode) addressParts.push(addr.postalCode);
                        if (addr.country) addressParts.push(addr.country);

                        const fullAddress = addressParts.join(', ');
                        if (fullAddress) {
                            document.getElementById('clientAddress').value = fullAddress;
                        }
                    }

                    showAlert('Contact imported! Please review and add pet information.');
                }

                // Restore button
                importBtn.innerHTML = originalText;
                importBtn.disabled = false;

            } catch (error) {
                console.error('Error importing contact:', error);

                // Restore button
                const importBtn = document.getElementById('importContactBtn');
                importBtn.innerHTML = '<i class="fas fa-address-book mr-2"></i>Import from Contacts';
                importBtn.disabled = false;

                if (error.name === 'NotAllowedError') {
                    showAlert('Permission denied. Please allow access to contacts.');
                } else if (error.name === 'AbortError') {
                    // User cancelled - no need to show error
                    console.log('Contact selection cancelled');
                } else {
                    showAlert('Could not import contact. Please enter details manually.');
                }
            }
        }

        function addPetEntry() {
            // Try both containers - one for new client, one for edit client modal
            let container = document.getElementById('petsContainer');
            if (!container) {
                container = document.getElementById('editPetsContainer');
            }
            if (!container) {
                console.error('No pets container found');
                return;
            }
            const entry = document.createElement('div');
            entry.className = 'pet-entry space-y-3 mb-4 p-4 rounded-lg';
            entry.style.background = 'var(--bg-tertiary)';
            entry.innerHTML = `
                <input type="text" placeholder="Pet name" class="input-field pet-name">
                <input type="text" placeholder="Breed" class="input-field pet-breed">
                <input type="number" placeholder="Age" class="input-field pet-age" min="0">
                <textarea placeholder="Notes (e.g., temperament, allergies)" class="input-field pet-notes" rows="2"></textarea>
                <button onclick="removePetEntry(this)" class="btn btn-secondary btn-sm" style="color: var(--danger);">
                    <i class="fas fa-trash mr-2"></i>Remove Pet
                </button>
            `;
            container.appendChild(entry);
        }

        function saveClient() {
            const name = document.getElementById('clientName').value.trim();
            const email = document.getElementById('clientEmail').value.trim();
            const phone = document.getElementById('clientPhone').value.trim();
            const address = document.getElementById('clientAddress').value.trim();

            // Only Name, Mobile & Address are required
            if (!name || !phone || !address) {
                showAlert('Please fill in Name, Mobile and Address');
                return;
            }

            const petEntries = document.querySelectorAll('.pet-entry');
            const pets = [];

            petEntries.forEach(entry => {
                const petName = entry.querySelector('.pet-name').value.trim();
                const breed = entry.querySelector('.pet-breed').value.trim();
                const age = parseInt(entry.querySelector('.pet-age').value) || 0;
                const notes = entry.querySelector('.pet-notes').value.trim();

                // Only pet name is required, breed and other fields are optional
                if (petName) {
                    pets.push({ name: petName, breed, age, notes });
                }
            });

            // Pets are optional - no validation required

            clients.push({
                id: clients.length + 1,
                name,
                email,
                phone,
                address,
                pets
            });

            document.querySelector('.modal-overlay').remove();
            renderClients();
            showAlert('Client added successfully!');
        }

        function openNewServiceModal() {
            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Service Name</label>
                        <input type="text" id="serviceName" class="input-field" placeholder="Full Grooming">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Description</label>
                        <textarea id="serviceDescription" class="input-field" rows="3" placeholder="Bath, haircut, nail trim..."></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Duration (minutes)</label>
                            <input type="number" id="serviceDuration" class="input-field" placeholder="60" min="1">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Price (excl. GST)</label>
                            <input type="number" id="servicePrice" class="input-field" placeholder="45" min="0" step="0.01">
                        </div>
                    </div>
                    ${settings.gstEnabled ? '<p class="text-xs" style="color: var(--text-tertiary);">GST will be added automatically (10%)</p>' : ''}
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
                <button onclick="saveService()" class="btn btn-primary">Add Service</button>
            `;

            showModal('New Service', content, buttons);
        }

        function saveService() {
            const name = document.getElementById('serviceName').value;
            const description = document.getElementById('serviceDescription').value;
            const duration = parseInt(document.getElementById('serviceDuration').value);
            const price = parseFloat(document.getElementById('servicePrice').value);

            if (!name || !description || !duration || !price) {
                showAlert('Please fill in all fields');
                return;
            }

            services.push({
                id: services.length + items.length + 1,
                name,
                description,
                duration,
                price,
                type: 'service'
            });

            document.querySelector('.modal-overlay').remove();
            renderServices();
            showAlert('Service added successfully!');
        }

        function openNewItemModal() {
            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Item Name</label>
                        <input type="text" id="itemName" class="input-field" placeholder="Flea Treatment">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Description</label>
                        <textarea id="itemDescription" class="input-field" rows="3" placeholder="Premium flea & tick treatment"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Price (excl. GST)</label>
                        <input type="number" id="itemPrice" class="input-field" placeholder="25" min="0" step="0.01">
                    </div>
                    ${settings.gstEnabled ? '<p class="text-xs" style="color: var(--text-tertiary);">GST will be added automatically (10%)</p>' : ''}
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
                <button onclick="saveItem()" class="btn btn-primary">Add Item</button>
            `;

            showModal('New Item', content, buttons);
        }

        function saveItem() {
            const name = document.getElementById('itemName').value;
            const description = document.getElementById('itemDescription').value;
            const price = parseFloat(document.getElementById('itemPrice').value);

            if (!name || !description || !price) {
                showAlert('Please fill in all fields');
                return;
            }

            items.push({
                id: services.length + items.length + 1,
                name,
                description,
                price,
                type: 'item'
            });

            document.querySelector('.modal-overlay').remove();
            renderServices();
            showAlert('Item added successfully!');
        }

        function openAddToWaitlistModal() {
            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Client</label>
                        <select id="waitlistClient" class="input-field" onchange="updateWaitlistPetOptions()">
                            <option value="">Select client...</option>
                            ${clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Pet</label>
                        <select id="waitlistPet" class="input-field">
                            <option value="">Select pet...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Preferred Date (Optional)</label>
                        <input type="date" id="waitlistDate" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Notes</label>
                        <textarea id="waitlistNotes" class="input-field" rows="3" placeholder="Any preferences or requirements..."></textarea>
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
                <button onclick="saveToWaitlist()" class="btn btn-primary">Add to Waitlist</button>
            `;

            showModal('Add to Waitlist', content, buttons);
        }

        function updateWaitlistPetOptions() {
            const clientId = parseInt(document.getElementById('waitlistClient').value);
            const client = clients.find(c => c.id === clientId);
            const petSelect = document.getElementById('waitlistPet');

            if (client && client.pets) {
                petSelect.innerHTML = '<option value="">Select pet...</option>' +
                    client.pets.map(p => `<option value="${p.name}">${p.name} (${p.breed})</option>`).join('');
            } else {
                petSelect.innerHTML = '<option value="">Select pet...</option>';
            }
        }

        function saveToWaitlist() {
            const clientId = parseInt(document.getElementById('waitlistClient').value);
            const petName = document.getElementById('waitlistPet').value;
            const preferredDate = document.getElementById('waitlistDate').value;
            const notes = document.getElementById('waitlistNotes').value;

            if (!clientId || !petName) {
                showAlert('Please select client and pet');
                return;
            }

            waitlist.push({
                id: waitlist.length + 1,
                clientId,
                petName,
                preferredDate: preferredDate || null,
                notes,
                addedDate: new Date()
            });

            document.querySelector('.modal-overlay').remove();
            renderWaitlist();
            showAlert('Added to waitlist successfully!');
        }

        function scheduleFromWaitlist(waitlistId) {
            const item = waitlist.find(w => w.id === waitlistId);
            if (!item) return;

            // Remove from modal and open appointment modal
            selectedDate = item.preferredDate ? new Date(item.preferredDate) : new Date();
            openNewAppointmentModal();

            // Pre-select the client
            setTimeout(() => {
                document.getElementById('aptClient').value = item.clientId;
                updatePetSelectionOptions();
            }, 100);
        }

        function removeFromWaitlist(id) {
            showConfirm('Remove this client from the waitlist?', () => {
                waitlist = waitlist.filter(w => w.id !== id);
                renderWaitlist();
            });
        }

        function viewAppointment(id) {
            const apt = appointments.find(a => a.id === id);
            if (!apt) return;

            const client = clients.find(c => c.id === apt.clientId);

            let subtotal = 0;
            const itemizedList = apt.pets.map(pet => {
                const petItems = pet.items.map(item => {
                    const serviceOrItem = [...services, ...items].find(s => s.id === item.id && s.type === item.type);
                    if (serviceOrItem) {
                        subtotal += serviceOrItem.price;
                        return `${serviceOrItem.name} - $${serviceOrItem.price.toFixed(2)}`;
                    }
                    return '';
                }).filter(Boolean).join(', ');

                return `<b>${pet.name}:</b> ${petItems}`;
            }).join('<br>');

            const gst = calculateGST(subtotal);
            const total = subtotal + gst;

            const content = `
                <div class="space-y-4">
                    <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                        <div class="text-sm" style="color: var(--text-tertiary);">DATE & TIME</div>
                        <div class="text-xl font-bold mono mt-1">
                            ${apt.date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
                        </div>
                        <div class="text-lg mono" style="color: var(--accent-primary);">
                            ${formatTime(apt.date)}
                        </div>
                    </div>

                    <div>
                        <div class="text-sm font-semibold mb-2" style="color: var(--text-tertiary);">CLIENT</div>
                        <div class="font-semibold">${client?.name || 'Unknown'}</div>
                        <div onclick="showPhoneOptions('${(client?.phone || '').replace(/'/g, "\\'")}'); event.stopPropagation();" class="text-sm cursor-pointer hover:text-blue-600 transition-colors" style="color: var(--text-secondary);">${client?.phone || ''}</div>
                    </div>

                    <div>
                        <div class="text-sm font-semibold mb-2" style="color: var(--text-tertiary);">ADDRESS</div>
                        <div onclick="openMaps('${(client?.address || 'No address').replace(/'/g, "\\'")}'); event.stopPropagation();" class="cursor-pointer hover:text-blue-600 transition-colors">${client?.address || 'No address'}</div>
                    </div>

                    <div>
                        <div class="text-sm font-semibold mb-2" style="color: var(--text-tertiary);">ITEMIZED SERVICES</div>
                        <div class="p-3 rounded" style="background: var(--bg-tertiary);">
                            ${itemizedList}
                        </div>
                    </div>

                    <div>
                        <div class="text-sm font-semibold mb-2" style="color: var(--text-tertiary);">PRICING</div>
                        <div class="space-y-1">
                            <div class="flex justify-between">
                                <span>Subtotal:</span>
                                <span class="mono">$${subtotal.toFixed(2)}</span>
                            </div>
                            ${settings.gstEnabled ? `
                                <div class="flex justify-between text-sm" style="color: var(--text-secondary);">
                                    <span>GST (10%):</span>
                                    <span class="mono">$${gst.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="flex justify-between font-bold text-lg pt-2 border-t" style="border-color: var(--border); color: var(--accent-primary);">
                                <span>Total:</span>
                                <span class="mono">$${total.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>

                    ${apt.notes ? `
                        <div>
                            <div class="text-sm font-semibold mb-2" style="color: var(--text-tertiary);">NOTES</div>
                            <div>${apt.notes}</div>
                        </div>
                    ` : ''}

                    <div>
                        <div class="text-sm font-semibold mb-2" style="color: var(--text-tertiary);">STATUS</div>
                        <span class="badge ${apt.status === 'confirmed' ? 'badge-success' : apt.status === 'pending' ? 'badge-warning' : 'badge-danger'}">
                            ${apt.status}
                        </span>
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="editAppointment(${id})" class="btn btn-primary btn-sm">
                    <i class="fas fa-edit mr-2"></i>Edit
                </button>
                <button onclick="sendConfirmationRequest(${id})" class="btn btn-secondary btn-sm">
                    <i class="fas fa-paper-plane mr-2"></i>Request Confirmation
                </button>
                <button onclick="sendReminder(${id})" class="btn btn-secondary btn-sm">
                    <i class="fas fa-bell mr-2"></i>Send Reminder
                </button>
                <button onclick="generateInvoicePDF(${id})" class="btn btn-secondary btn-sm">
                    <i class="fas fa-file-pdf mr-2"></i>Generate Invoice
                </button>
                <button onclick="deleteAppointment(${id})" class="btn btn-secondary btn-sm" style="background: var(--danger); color: white;">
                    <i class="fas fa-trash mr-2"></i>Delete
                </button>
            `;

            showModal('Appointment Details', content, buttons);
        }

        // Messaging Functions
        async function sendConfirmationRequest(aptId) {
            const apt = appointments.find(a => a.id === aptId);
            if (!apt) return;

            const client = clients.find(c => c.id === apt.clientId);

            // Show time picker modal first
            const content = `
                <div class="space-y-4">
                    <p>When would you like to request confirmation from the customer?</p>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Hours before appointment</label>
                        <select id="confirmationHours" class="input-field">
                            <option value="1">1 hour before</option>
                            <option value="2">2 hours before</option>
                            <option value="4">4 hours before</option>
                            <option value="12">12 hours before</option>
                            <option value="24" selected>24 hours before (1 day)</option>
                            <option value="48">48 hours before (2 days)</option>
                            <option value="72">72 hours before (3 days)</option>
                        </select>
                    </div>
                    <div class="p-3 rounded" style="background: var(--bg-tertiary);">
                        <div class="text-sm font-semibold mb-1">Appointment Details:</div>
                        <div class="text-sm">Date: ${apt.date.toLocaleDateString('en-AU')}</div>
                        <div class="text-sm">Time: ${formatTime(apt.date)}</div>
                        <div class="text-sm">Client: ${client?.name}</div>
                    </div>
                    <div class="text-xs p-3 rounded" style="background: var(--bg-primary); color: var(--text-tertiary); border: 1px solid var(--border);">
                        <i class="fas fa-info-circle mr-1"></i> This will ask the customer to confirm they can make the appointment
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
                <button onclick="generateConfirmationRequest(${aptId})" class="btn btn-primary">Generate Message</button>
            `;

            showModal('Request Customer Confirmation', content, buttons);
        }

        async function generateConfirmationRequest(aptId) {
            const apt = appointments.find(a => a.id === aptId);
            if (!apt) return;

            const client = clients.find(c => c.id === apt.clientId);
            const petsList = apt.pets.map(pet => pet.name).join(', ');
            const total = calculateTotalWithGST(apt.pets.reduce((sum, pet) => {
                return sum + pet.items.reduce((itemSum, item) => {
                    const serviceOrItem = [...services, ...items].find(s => s.id === item.id && s.type === item.type);
                    return itemSum + (serviceOrItem?.price || 0);
                }, 0);
            }, 0));
            const hours = parseInt(document.getElementById('confirmationHours').value);

            // Close the time picker modal
            document.querySelector('.modal-overlay').remove();

            // Generate confirmation request message from template
            const timePhrase = hours < 24 ? `${hours} hours` : `${Math.floor(hours/24)} day${hours >= 48 ? 's' : ''}`;

            const message = `Hi ${client?.name},

We have your mobile pet grooming appointment coming up in ${timePhrase}!

 Date: ${apt.date.toLocaleDateString('en-AU', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
 Time: ${formatTime(apt.date)}
 Pets: ${petsList}
 Total: $${total.toFixed(2)} (GST included)
 Location: ${client?.address}

Could you please reply to confirm you can still make this appointment? If you need to reschedule, just let us know and we'll find another time that works for you.

Thank you,
${settings.businessName}`;

            showMessagePreview('Confirmation Request', message, client?.phone);
        }

        async function sendReminder(aptId) {
            const apt = appointments.find(a => a.id === aptId);
            if (!apt) return;

            const client = clients.find(c => c.id === apt.clientId);

            // Show time picker modal first
            const content = `
                <div class="space-y-4">
                    <p>When would you like to send the reminder?</p>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Hours before appointment</label>
                        <select id="reminderHours" class="input-field">
                            <option value="1">1 hour before</option>
                            <option value="2">2 hours before</option>
                            <option value="4">4 hours before</option>
                            <option value="12">12 hours before</option>
                            <option value="24" selected>24 hours before (1 day)</option>
                            <option value="48">48 hours before (2 days)</option>
                            <option value="72">72 hours before (3 days)</option>
                        </select>
                    </div>
                    <div class="p-3 rounded" style="background: var(--bg-tertiary);">
                        <div class="text-sm font-semibold mb-1">Appointment Details:</div>
                        <div class="text-sm">Date: ${apt.date.toLocaleDateString('en-AU')}</div>
                        <div class="text-sm">Time: ${formatTime(apt.date)}</div>
                        <div class="text-sm">Client: ${client?.name}</div>
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
                <button onclick="generateReminderMessage(${aptId})" class="btn btn-primary">Generate Reminder</button>
            `;

            showModal('Send Reminder', content, buttons);
        }

        async function generateReminderMessage(aptId) {
            const apt = appointments.find(a => a.id === aptId);
            if (!apt) return;

            const client = clients.find(c => c.id === apt.clientId);
            const petsList = apt.pets.map(pet => pet.name).join(', ');
            const hours = parseInt(document.getElementById('reminderHours').value);

            // Close the time picker modal
            document.querySelector('.modal-overlay').remove();

            // Generate reminder message from template
            const timePhrase = hours < 24 ? `${hours} hours` : `${Math.floor(hours/24)} day${hours >= 48 ? 's' : ''}`;

            const message = `Hi ${client?.name},

This is a friendly reminder about your mobile pet grooming appointment ${timePhrase} from now.

 Date: ${apt.date.toLocaleDateString('en-AU', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
 Time: ${formatTime(apt.date)}
 Pets: ${petsList}
 Location: ${client?.address}

We're looking forward to pampering your fur baby! If you need to reschedule, please let us know as soon as possible.

Thank you,
${settings.businessName}`;

            showMessagePreview('Appointment Reminder', message, client?.phone);
        }

        // Loading and Preview Functions
        function showLoadingMessage(text) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'loadingModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="p-6">
                        <div class="text-center mb-4">
                            <div class="w-12 h-12 rounded-full mx-auto flex items-center justify-center" style="background: rgba(236, 72, 153, 0.1);">
                                <i class="fas fa-spinner fa-spin text-2xl" style="color: var(--accent-primary);"></i>
                            </div>
                        </div>
                        <p class="text-center" id="loadingText">${text}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function updateLoadingMessage(text) {
            const loadingText = document.getElementById('loadingText');
            if (loadingText) {
                loadingText.textContent = text;
            }
        }

        function hideLoadingMessage() {
            const modal = document.getElementById('loadingModal');
            if (modal) {
                modal.remove();
            }
        }

        function showMessagePreview(title, message, phone) {
            const content = `
                <div class="space-y-4">
                    <div>
                        <div class="text-sm font-semibold mb-2" style="color: var(--text-tertiary);">TO</div>
                        <div>${phone}</div>
                    </div>
                    <div>
                        <div class="text-sm font-semibold mb-2" style="color: var(--text-tertiary);">MESSAGE</div>
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary); white-space: pre-wrap;">${message}</div>
                    </div>
                    <div class="text-xs" style="color: var(--text-tertiary);">
                        <i class="fas fa-info-circle mr-1"></i>In a production app, this would be sent via SMS API
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Close</button>
                <button onclick="copyToClipboard(\`${message.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" class="btn btn-primary">
                    <i class="fas fa-copy mr-2"></i>Copy Message
                </button>
            `;

            showModal(title, content, buttons);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('Message copied to clipboard!');
            }).catch(() => {
                showAlert('Could not copy to clipboard');
            });
        }

        function deleteAppointment(id) {
            showConfirm('Are you sure you want to delete this appointment?', () => {
                const deletedApt = appointments.find(a => a.id === id);
                appointments = appointments.filter(a => a.id !== id);
                const modals = document.querySelectorAll('.modal-overlay');
                modals.forEach(m => m.remove());
                renderDayTimeline();
                renderWeekTimeline();
                renderCalendar();

                // Push to undo stack instead of simple alert
                if (deletedApt) {
                    pushToUndoStack('delete_appointment', deletedApt);
                }
            });
        }

        function editClient(id) {
            const client = clients.find(c => c.id === id);
            if (!client) return;

            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Client Name</label>
                        <input type="text" id="editClientName" class="input-field" value="${client.name}">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Email</label>
                        <input type="email" id="editClientEmail" class="input-field" value="${client.email}">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Phone</label>
                        <input type="tel" id="editClientPhone" class="input-field" value="${client.phone}">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Address</label>
                        <textarea id="editClientAddress" class="input-field" rows="2">${client.address}</textarea>
                    </div>
                    <div class="border-t pt-4" style="border-color: var(--border);">
                        <label class="block text-sm font-semibold mb-2">Pet Information</label>
                        <div id="editPetsContainer">
                            ${client.pets.map((pet, idx) => `
                                <div class="pet-entry space-y-3 mb-4 p-4 rounded-lg" style="background: var(--bg-tertiary);" data-pet-idx="${idx}">
                                    <input type="text" placeholder="Pet name" class="input-field pet-name" value="${pet.name}">
                                    <input type="text" placeholder="Breed" class="input-field pet-breed" value="${pet.breed}">
                                    <input type="number" placeholder="Age" class="input-field pet-age" min="0" value="${pet.age}">
                                    <textarea placeholder="Notes" class="input-field pet-notes" rows="2">${pet.notes || ''}</textarea>
                                    ${client.pets.length > 1 ? `
                                        <button onclick="removePetEntry(this)" class="btn btn-secondary btn-sm" style="color: var(--danger);">
                                            <i class="fas fa-trash mr-2"></i>Remove Pet
                                        </button>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="addPetEntry()" class="btn btn-secondary w-full">
                            <i class="fas fa-plus mr-2"></i>Add Another Pet
                        </button>
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
                <button onclick="updateClient(${id})" class="btn btn-primary">Save Changes</button>
                <button onclick="deleteClient(${id})" class="btn btn-secondary" style="background: var(--danger); color: white;">
                    <i class="fas fa-trash mr-2"></i>Delete Client
                </button>
            `;

            showModal('Edit Client', content, buttons);
        }

        function removePetEntry(button) {
            button.closest('.pet-entry').remove();
        }

        function updateClient(id) {
            const client = clients.find(c => c.id === id);
            if (!client) return;

            const name = document.getElementById('editClientName').value.trim();
            const email = document.getElementById('editClientEmail').value.trim();
            const phone = document.getElementById('editClientPhone').value.trim();
            const address = document.getElementById('editClientAddress').value.trim();

            // Only Name, Mobile & Address are required
            if (!name || !phone || !address) {
                showAlert('Please fill in Name, Mobile and Address');
                return;
            }

            const petEntries = document.querySelectorAll('#editPetsContainer .pet-entry');
            const pets = [];

            petEntries.forEach(entry => {
                const petName = entry.querySelector('.pet-name').value.trim();
                const breed = entry.querySelector('.pet-breed').value.trim();
                const age = parseInt(entry.querySelector('.pet-age').value) || 0;
                const notes = entry.querySelector('.pet-notes').value.trim();

                // Only pet name is required, breed and other fields are optional
                if (petName) {
                    pets.push({ name: petName, breed, age, notes });
                }
            });

            // Pets are optional - no validation required

            client.name = name;
            client.email = email;
            client.phone = phone;
            client.address = address;
            client.pets = pets;

            document.querySelector('.modal-overlay').remove();
            renderClients();
            showAlert('Client updated successfully!');
        }

        function deleteClient(id) {
            showConfirm('Are you sure you want to delete this client? This will also delete all their appointments.', () => {
                clients = clients.filter(c => c.id !== id);
                appointments = appointments.filter(a => a.clientId !== id);
                waitlist = waitlist.filter(w => w.clientId !== id);

                const modals = document.querySelectorAll('.modal-overlay');
                modals.forEach(m => m.remove());

                renderClients();
                renderWeekTimeline();
                renderCalendar();
                renderWaitlist();
                showAlert('Client deleted successfully');
            });
        }

        function editServiceOrItem(id, type) {
            const allItems = [...services, ...items];
            const item = allItems.find(s => s.id === id && s.type === type);
            if (!item) return;

            const isService = type === 'service';

            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">${isService ? 'Service' : 'Item'} Name</label>
                        <input type="text" id="editItemName" class="input-field" value="${item.name}">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Description</label>
                        <textarea id="editItemDescription" class="input-field" rows="3">${item.description}</textarea>
                    </div>
                    ${isService ? `
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Duration (minutes)</label>
                                <input type="number" id="editItemDuration" class="input-field" value="${item.duration}" min="1">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Price (excl. GST)</label>
                                <input type="number" id="editItemPrice" class="input-field" value="${item.price}" min="0" step="0.01">
                            </div>
                        </div>
                    ` : `
                        <div>
                            <label class="block text-sm font-semibold mb-2">Price (excl. GST)</label>
                            <input type="number" id="editItemPrice" class="input-field" value="${item.price}" min="0" step="0.01">
                        </div>
                    `}
                    ${settings.gstEnabled ? '<p class="text-xs" style="color: var(--text-tertiary);">GST will be added automatically (10%)</p>' : ''}
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
                <button onclick="updateServiceOrItem(${id}, '${type}')" class="btn btn-primary">Save Changes</button>
                <button onclick="deleteServiceOrItem(${id}, '${type}')" class="btn btn-secondary" style="background: var(--danger); color: white;">
                    <i class="fas fa-trash mr-2"></i>Delete
                </button>
            `;

            showModal(`Edit ${isService ? 'Service' : 'Item'}`, content, buttons);
        }

        function updateServiceOrItem(id, type) {
            const isService = type === 'service';
            const targetArray = isService ? services : items;
            const item = targetArray.find(s => s.id === id && s.type === type);
            if (!item) return;

            const name = document.getElementById('editItemName').value;
            const description = document.getElementById('editItemDescription').value;
            const price = parseFloat(document.getElementById('editItemPrice').value);

            if (!name || !description || !price) {
                showAlert('Please fill in all fields');
                return;
            }

            item.name = name;
            item.description = description;
            item.price = price;

            if (isService) {
                const duration = parseInt(document.getElementById('editItemDuration').value);
                if (!duration) {
                    showAlert('Please enter a valid duration');
                    return;
                }
                item.duration = duration;
            }

            document.querySelector('.modal-overlay').remove();
            renderServices();
            showAlert(`${isService ? 'Service' : 'Item'} updated successfully!`);
        }

        function deleteServiceOrItem(id, type) {
            const isService = type === 'service';
            showConfirm(`Are you sure you want to delete this ${isService ? 'service' : 'item'}?`, () => {
                if (isService) {
                    services = services.filter(s => s.id !== id);
                } else {
                    items = items.filter(i => i.id !== id);
                }

                const modals = document.querySelectorAll('.modal-overlay');
                modals.forEach(m => m.remove());

                renderServices();
                showAlert(`${isService ? 'Service' : 'Item'} deleted successfully`);
            });
        }

        // Settings Functions
        function openSettings() {
            const content = `
                <div class="space-y-2">
                    <!-- Business Information Card -->
                    <div class="rounded-lg overflow-hidden" style="background: var(--bg-tertiary);">
                        <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleSettingsSection('businessSection')">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: var(--accent-primary);">
                                    <i class="fas fa-building text-white text-sm"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-sm">Business Information</h3>
                                </div>
                            </div>
                            <i class="fas fa-chevron-down transition-transform text-sm" id="businessSectionIcon" style="color: var(--text-tertiary);"></i>
                        </div>
                        <div class="px-3 pb-3 space-y-2 hidden" id="businessSection">
                            <div>
                                <label class="block text-xs mb-1" style="color: var(--text-secondary);">Business Name</label>
                                <input type="text" id="settingsBusinessName" class="input-field text-sm py-2" value="${settings.businessName}" placeholder="Your Business Name">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs mb-1" style="color: var(--text-secondary);">ABN</label>
                                    <input type="text" id="settingsABN" class="input-field text-sm py-2" value="${settings.abn}" placeholder="12 345 678 901">
                                </div>
                                <div>
                                    <label class="block text-xs mb-1" style="color: var(--text-secondary);">Phone</label>
                                    <input type="tel" id="settingsPhone" class="input-field text-sm py-2" value="${settings.phone}" placeholder="0412 345 678">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs mb-1" style="color: var(--text-secondary);">Email</label>
                                <input type="email" id="settingsEmail" class="input-field text-sm py-2" value="${settings.email}" placeholder="info@business.com">
                            </div>
                            <div>
                                <label class="block text-xs mb-1" style="color: var(--text-secondary);">Address</label>
                                <input type="text" id="settingsAddress" class="input-field text-sm py-2" value="${settings.address}" placeholder="123 Main St, Sydney NSW 2000">
                            </div>
                        </div>
                    </div>

                    <!-- Payment Details Card -->
                    <div class="rounded-lg overflow-hidden" style="background: var(--bg-tertiary);">
                        <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleSettingsSection('paymentSection')">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: var(--success);">
                                    <i class="fas fa-credit-card text-white text-sm"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-sm">Payment Details</h3>
                                </div>
                            </div>
                            <i class="fas fa-chevron-down transition-transform text-sm" id="paymentSectionIcon" style="color: var(--text-tertiary);"></i>
                        </div>
                        <div class="px-3 pb-3 space-y-2 hidden" id="paymentSection">
                            <div>
                                <label class="block text-xs mb-1" style="color: var(--text-secondary);">PayID</label>
                                <input type="text" id="settingsPayId" class="input-field text-sm py-2" value="${settings.payId}" placeholder="yourname@payid.com.au">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs mb-1" style="color: var(--text-secondary);">BSB</label>
                                    <input type="text" id="settingsBSB" class="input-field text-sm py-2" value="${settings.bsb}" placeholder="062-000">
                                </div>
                                <div>
                                    <label class="block text-xs mb-1" style="color: var(--text-secondary);">Account Number</label>
                                    <input type="text" id="settingsAccountNumber" class="input-field text-sm py-2" value="${settings.accountNumber}" placeholder="12345678">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs mb-1" style="color: var(--text-secondary);">Account Name</label>
                                    <input type="text" id="settingsAccountName" class="input-field text-sm py-2" value="${settings.accountName}" placeholder="Account Name">
                                </div>
                                <div>
                                    <label class="block text-xs mb-1" style="color: var(--text-secondary);">Bank Name</label>
                                    <input type="text" id="settingsBankName" class="input-field text-sm py-2" value="${settings.bankName}" placeholder="CBA">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <button onclick="showPaymentQR()" class="btn btn-secondary btn-sm w-full">
                                    <i class="fas fa-qrcode mr-2"></i>QR Code
                                </button>
                                <button onclick="sharePaymentDetailsSMS()" class="btn btn-primary btn-sm w-full">
                                    <i class="fas fa-sms mr-2"></i>Send SMS
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- App Preferences Card -->
                    <div class="rounded-lg overflow-hidden" style="background: var(--bg-tertiary);">
                        <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleSettingsSection('prefsSection')">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: var(--warning);">
                                    <i class="fas fa-sliders text-white text-sm"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-sm">Preferences</h3>
                                </div>
                            </div>
                            <i class="fas fa-chevron-down transition-transform text-sm" id="prefsSectionIcon" style="color: var(--text-tertiary);"></i>
                        </div>
                        <div class="px-3 pb-3 space-y-2 hidden" id="prefsSection">
                            <div class="flex items-center justify-between p-2 rounded-lg" style="background: var(--bg-secondary);">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-clock text-sm" style="color: var(--accent-primary);"></i>
                                    <span class="text-sm">24-Hour Clock</span>
                                </div>
                                <div class="checkbox-custom ${settings.use24HourClock ? 'checked' : ''}" onclick="toggleSetting('use24HourClock')" id="setting24Hour">
                                    <i class="fas fa-check text-white text-xs" style="${settings.use24HourClock ? '' : 'display: none;'}" id="setting24HourIcon"></i>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-2 rounded-lg" style="background: var(--bg-secondary);">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-percent text-sm" style="color: var(--accent-primary);"></i>
                                    <span class="text-sm">GST Enabled</span>
                                </div>
                                <div class="checkbox-custom ${settings.gstEnabled ? 'checked' : ''}" onclick="toggleSetting('gstEnabled')" id="settingGST">
                                    <i class="fas fa-check text-white text-xs" style="${settings.gstEnabled ? '' : 'display: none;'}" id="settingGSTIcon"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Message Templates Card -->
                    <div class="rounded-lg overflow-hidden" style="background: var(--bg-tertiary);">
                        <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleSettingsSection('templatesSection')">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: #6366f1;">
                                    <i class="fas fa-comment-dots text-white text-sm"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-sm">Message Templates</h3>
                                </div>
                            </div>
                            <i class="fas fa-chevron-down transition-transform text-sm" id="templatesSectionIcon" style="color: var(--text-tertiary);"></i>
                        </div>
                        <div class="px-3 pb-3 hidden" id="templatesSection">
                            <div class="text-xs mb-3 p-2 rounded flex flex-wrap gap-1" style="background: var(--bg-secondary);">
                                <span class="px-1.5 py-0.5 rounded text-xs" style="background: var(--bg-tertiary);">{clientFirstName}</span>
                                <span class="px-1.5 py-0.5 rounded text-xs" style="background: var(--bg-tertiary);">{businessName}</span>
                                <span class="px-1.5 py-0.5 rounded text-xs" style="background: var(--bg-tertiary);">{date}</span>
                                <span class="px-1.5 py-0.5 rounded text-xs" style="background: var(--bg-tertiary);">{time}</span>
                                <span class="px-1.5 py-0.5 rounded text-xs" style="background: var(--bg-tertiary);">{pets}</span>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <div class="flex items-center gap-1.5 mb-1">
                                        <i class="fas fa-calendar-check text-xs" style="color: var(--accent-primary);"></i>
                                        <label class="text-xs font-semibold">Booking Confirmation</label>
                                    </div>
                                    <textarea id="settingsTemplateBooking" class="input-field text-xs" rows="3" placeholder="Booking message...">${settings.messageTemplates.booking}</textarea>
                                </div>
                                <div>
                                    <div class="flex items-center gap-1.5 mb-1">
                                        <i class="fas fa-check-circle text-xs" style="color: var(--success);"></i>
                                        <label class="text-xs font-semibold">Confirmation Request</label>
                                    </div>
                                    <textarea id="settingsTemplateConfirmation" class="input-field text-xs" rows="3" placeholder="Confirmation message...">${settings.messageTemplates.confirmation}</textarea>
                                </div>
                                <div>
                                    <div class="flex items-center gap-1.5 mb-1">
                                        <i class="fas fa-bell text-xs" style="color: var(--warning);"></i>
                                        <label class="text-xs font-semibold">Appointment Reminder</label>
                                    </div>
                                    <textarea id="settingsTemplateReminder" class="input-field text-xs" rows="3" placeholder="Reminder message...">${settings.messageTemplates.reminder}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
                <button onclick="saveSettings()" class="btn btn-primary"><i class="fas fa-save mr-2"></i>Save</button>
            `;

            showModal('Settings', content, buttons);
        }

        function toggleSettingsSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId + 'Icon');

            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                section.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function toggleSetting(setting) {
            const checkbox = document.getElementById(`setting${setting === 'use24HourClock' ? '24Hour' : 'GST'}`);
            const icon = document.getElementById(`setting${setting === 'use24HourClock' ? '24Hour' : 'GST'}Icon`);

            const isChecked = checkbox.classList.contains('checked');

            if (isChecked) {
                checkbox.classList.remove('checked');
                icon.style.display = 'none';
            } else {
                checkbox.classList.add('checked');
                icon.style.display = 'block';
            }
        }

        function saveSettings() {
            settings.businessName = document.getElementById('settingsBusinessName').value;
            settings.abn = document.getElementById('settingsABN').value;
            settings.phone = document.getElementById('settingsPhone').value;
            settings.email = document.getElementById('settingsEmail').value;
            settings.address = document.getElementById('settingsAddress').value;

            // Save payment details
            settings.payId = document.getElementById('settingsPayId').value;
            settings.bankName = document.getElementById('settingsBankName').value;
            settings.bsb = document.getElementById('settingsBSB').value;
            settings.accountNumber = document.getElementById('settingsAccountNumber').value;
            settings.accountName = document.getElementById('settingsAccountName').value;

            settings.use24HourClock = document.getElementById('setting24Hour').classList.contains('checked');
            settings.gstEnabled = document.getElementById('settingGST').classList.contains('checked');

            // Save message templates
            settings.messageTemplates.booking = document.getElementById('settingsTemplateBooking').value;
            settings.messageTemplates.confirmation = document.getElementById('settingsTemplateConfirmation').value;
            settings.messageTemplates.reminder = document.getElementById('settingsTemplateReminder').value;

            document.querySelector('.modal-overlay').remove();
            updateHeaderLogo();
            renderWeekTimeline();
            renderServices();
            showAlert('Settings saved successfully!');
        }

        function sharePaymentDetailsSMS() {
            // Get current values from form
            const payId = document.getElementById('settingsPayId')?.value || settings.payId;
            const bankName = document.getElementById('settingsBankName')?.value || settings.bankName;
            const bsb = document.getElementById('settingsBSB')?.value || settings.bsb;
            const accountNumber = document.getElementById('settingsAccountNumber')?.value || settings.accountNumber;
            const accountName = document.getElementById('settingsAccountName')?.value || settings.accountName;
            const businessName = settings.businessName || 'Our Business';

            let message = `Payment Details for ${businessName}:\n\n`;
            if (payId) message += `PayID: ${payId}\n\n`;
            if (bankName || bsb || accountNumber) {
                message += `Bank Transfer:\n`;
                if (bankName) message += `Bank: ${bankName}\n`;
                if (accountName) message += `Account Name: ${accountName}\n`;
                if (bsb) message += `BSB: ${bsb}\n`;
                if (accountNumber) message += `Account: ${accountNumber}\n`;
            }

            // Build client options for dropdown
            const clientOptions = clients.map(c =>
                `<div class="p-2 rounded cursor-pointer hover:bg-opacity-50" style="background: var(--bg-tertiary);" onclick="selectClientForPaymentSMS('${c.phone}', '${c.name.replace(/'/g, "\\'")}')">
                    <div class="font-semibold text-sm">${c.name}</div>
                    <div class="text-xs" style="color: var(--text-tertiary);">${c.phone}</div>
                </div>`
            ).join('');

            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Search Customer</label>
                        <input type="text" id="paymentClientSearch" class="input-field" placeholder="Search by name..." oninput="filterPaymentClients(this.value)">
                        <div id="paymentClientList" class="mt-2 max-h-32 overflow-y-auto space-y-1" style="display: none;">
                            ${clientOptions}
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Or Enter Custom Number</label>
                        <input type="tel" id="paymentSmsPhone" class="input-field" placeholder="0412 345 678">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Message Preview</label>
                        <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 0.5rem; font-size: 0.813rem; white-space: pre-wrap; color: var(--text-secondary);">${message}</div>
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Cancel</button>
                <button onclick="sendPaymentDetailsSMS()" class="btn btn-primary"><i class="fas fa-paper-plane mr-2"></i>Send</button>
            `;

            showModal('Share Payment Details', content, buttons);
        }

        function filterPaymentClients(query) {
            const list = document.getElementById('paymentClientList');
            if (!query) {
                list.style.display = 'none';
                return;
            }
            list.style.display = 'block';
            const items = list.querySelectorAll('div[onclick]');
            const lowerQuery = query.toLowerCase();
            items.forEach(item => {
                const name = item.querySelector('.font-semibold')?.textContent?.toLowerCase() || '';
                const phone = item.querySelector('.text-xs')?.textContent?.toLowerCase() || '';
                item.style.display = (name.includes(lowerQuery) || phone.includes(lowerQuery)) ? 'block' : 'none';
            });
        }

        function selectClientForPaymentSMS(phone, name) {
            document.getElementById('paymentSmsPhone').value = phone;
            document.getElementById('paymentClientSearch').value = name;
            document.getElementById('paymentClientList').style.display = 'none';
        }

        function sendPaymentDetailsSMS() {
            const phone = document.getElementById('paymentSmsPhone')?.value?.replace(/\s/g, '');
            if (!phone) {
                showAlert('Please enter a phone number');
                return;
            }

            // Use saved settings since form fields may be gone after modal closes
            const payId = settings.payId || '';
            const bankName = settings.bankName || '';
            const bsb = settings.bsb || '';
            const accountNumber = settings.accountNumber || '';
            const accountName = settings.accountName || '';
            const businessName = settings.businessName || 'Our Business';

            let message = `Payment Details for ${businessName}: `;
            if (payId) message += `PayID: ${payId} `;
            if (bsb && accountNumber) {
                message += `| Bank: ${bankName} BSB: ${bsb} Acc: ${accountNumber} Name: ${accountName}`;
            }

            // Store phone and message before closing modals
            const smsPhone = phone;
            const smsMessage = message;

            closeAllModals();

            // Small delay to ensure modals are closed before opening SMS
            setTimeout(function() {
                openSmsLink(smsPhone, smsMessage);
            }, 100);
        }

        function showPaymentQR(amount = null, reference = null) {
            // Get current values from form if in settings, otherwise use saved settings
            const payId = document.getElementById('settingsPayId')?.value || settings.payId;
            const bankName = document.getElementById('settingsBankName')?.value || settings.bankName;
            const bsb = document.getElementById('settingsBSB')?.value || settings.bsb;
            const accountNumber = document.getElementById('settingsAccountNumber')?.value || settings.accountNumber;
            const accountName = document.getElementById('settingsAccountName')?.value || settings.accountName;

            if (!payId && !accountNumber) {
                showAlert('Please enter your PayID or bank account details first.');
                return;
            }

            // Different display for PayID vs Bank details
            let content = '';

            if (payId) {
                // PayID - show QR code that banking apps can scan
                const qrContent = payId; // Just the PayID itself - banking apps recognize this

                content = `
                    <div class="text-center">
                        <div class="mb-4">
                            <div class="w-16 h-16 rounded-full mx-auto flex items-center justify-center mb-3" style="background: rgba(236, 72, 153, 0.1);">
                                <i class="fas fa-qrcode text-3xl" style="color: var(--accent-primary);"></i>
                            </div>
                            <h3 class="font-bold text-lg mb-1">PayID Payment</h3>
                            <p class="text-sm" style="color: var(--text-tertiary);">Scan with banking app to pay</p>
                        </div>

                        ${amount ? `<div class="text-2xl font-bold mb-3" style="color: var(--accent-primary);">$${amount.toFixed(2)}</div>` : ''}
                        ${reference ? `<div class="text-sm mb-3" style="color: var(--text-secondary);">Reference: ${reference}</div>` : ''}

                        <div class="p-4 rounded-lg mb-4" style="background: white;">
                            <div id="paymentQRCode" class="flex justify-center"></div>
                        </div>

                        <div class="text-center mb-2"><span class="font-semibold">PayID:</span> ${payId}</div>
                        ${accountName ? `<div class="text-sm" style="color: var(--text-secondary);">${accountName}</div>` : ''}

                        <p class="text-xs mt-3" style="color: var(--text-tertiary);">
                            <i class="fas fa-info-circle mr-1"></i>
                            Open your banking app, scan this QR or enter the PayID manually.
                        </p>
                    </div>
                `;

                const buttons = `<button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Close</button>`;
                showModal('Payment Details', content, buttons);

                // Generate QR code for PayID
                setTimeout(() => {
                    const qrContainer = document.getElementById('paymentQRCode');
                    if (qrContainer && typeof QRCode !== 'undefined') {
                        qrContainer.innerHTML = '';
                        new QRCode(qrContainer, {
                            text: qrContent,
                            width: 180,
                            height: 180,
                            colorDark: '#2A1F14',
                            colorLight: '#ffffff',
                            correctLevel: QRCode.CorrectLevel.M
                        });
                    }
                }, 100);

            } else {
                // Bank details - show a styled card (no QR as there's no standard for AU bank transfers)
                content = `
                    <div class="text-center">
                        <div class="mb-4">
                            <div class="w-16 h-16 rounded-full mx-auto flex items-center justify-center mb-3" style="background: rgba(236, 72, 153, 0.1);">
                                <i class="fas fa-university text-3xl" style="color: var(--accent-primary);"></i>
                            </div>
                            <h3 class="font-bold text-lg mb-1">Bank Transfer Details</h3>
                            <p class="text-sm" style="color: var(--text-tertiary);">Transfer to this account</p>
                        </div>

                        ${amount ? `<div class="text-2xl font-bold mb-4" style="color: var(--accent-primary);">$${amount.toFixed(2)}</div>` : ''}

                        <div class="p-4 rounded-lg mb-4 text-left" style="background: var(--bg-secondary); border: 1px solid var(--border);">
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm" style="color: var(--text-tertiary);">Bank</span>
                                    <span class="font-semibold">${bankName}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm" style="color: var(--text-tertiary);">BSB</span>
                                    <span class="font-mono font-semibold">${bsb}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm" style="color: var(--text-tertiary);">Account</span>
                                    <span class="font-mono font-semibold">${accountNumber}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm" style="color: var(--text-tertiary);">Name</span>
                                    <span class="font-semibold">${accountName}</span>
                                </div>
                                ${reference ? `
                                <div class="pt-2 border-t" style="border-color: var(--border);">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm" style="color: var(--text-tertiary);">Reference</span>
                                        <span class="font-mono font-semibold">${reference}</span>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <p class="text-xs" style="color: var(--text-tertiary);">
                            <i class="fas fa-info-circle mr-1"></i>
                            Use these details in your banking app to make a transfer.
                        </p>
                    </div>
                `;

                const buttons = `<button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Close</button>`;
                showModal('Payment Details', content, buttons);
            }
        }

        function showPaymentQRForAppointment(aptId) {
            const apt = appointments.find(a => a.id === aptId);
            if (!apt || !apt.checkout) {
                showAlert('No checkout information found for this appointment.');
                return;
            }

            const invoiceNum = 'INV-' + apt.id.toString().padStart(5, '0');
            showPaymentQR(apt.checkout.total, invoiceNum);
        }

        function sendPaymentDetails(aptId, method) {
            const apt = appointments.find(a => a.id === aptId);
            if (!apt || !apt.checkout) {
                showAlert('No checkout information found.');
                return;
            }

            const client = clients.find(c => c.id === apt.clientId);
            if (!client) {
                showAlert('Client not found.');
                return;
            }

            const firstName = client.name.split(' ')[0];
            const invoiceNum = 'INV-' + apt.id.toString().padStart(5, '0');
            const amount = apt.checkout.total.toFixed(2);

            // Build payment details message
            let paymentInfo = '';
            if (settings.payId) {
                paymentInfo = 'PayID: ' + settings.payId;
            } else if (settings.accountNumber) {
                paymentInfo = 'Bank: ' + settings.bankName + '\n' +
                    'BSB: ' + settings.bsb + '\n' +
                    'Account: ' + settings.accountNumber + '\n' +
                    'Name: ' + settings.accountName;
            }

            if (!paymentInfo) {
                showAlert('Please set up your payment details in Settings first.');
                return;
            }

            const message = 'Hi ' + firstName + ',\n\n' +
                'Here are the payment details for your invoice (' + invoiceNum + '):\n\n' +
                'Amount Due: $' + amount + '\n\n' +
                paymentInfo + '\n\n' +
                'Reference: ' + invoiceNum + '\n\n' +
                'Thank you!\n' +
                (settings.businessName || 'Maya Groom Pro');

            if (method === 'email') {
                const emailAddress = client.email || '';
                const subject = encodeURIComponent('Payment Details - ' + invoiceNum + ' - ' + (settings.businessName || 'Maya Groom Pro'));
                const body = encodeURIComponent(message);
                window.open('mailto:' + emailAddress + '?subject=' + subject + '&body=' + body, '_blank');
                showNotification('Email opened with payment details');
            } else if (method === 'sms') {
                const phoneNumber = (client.phone || '').replace(/[^0-9+]/g, '');
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const smsLink = isIOS
                    ? 'sms:' + phoneNumber + '&body=' + encodeURIComponent(message)
                    : 'sms:' + phoneNumber + '?body=' + encodeURIComponent(message);
                window.open(smsLink, '_blank');
                showNotification('SMS opened with payment details');
            }

            // Close modals
            document.querySelectorAll('.modal-overlay').forEach(modal => modal.remove());
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showAlert('File size must be less than 2MB');
                return;
            }

            // Check file type
            if (!file.type.startsWith('image/')) {
                showAlert('Please upload an image file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                settings.logoDataUrl = e.target.result;

                // Update preview in settings modal
                const previewContainer = document.getElementById('logoPreviewContainer');
                previewContainer.innerHTML = `
                    <img src="${settings.logoDataUrl}" alt="Logo" class="h-20 mx-auto" style="object-fit: contain;">
                `;

                // Show remove button
                const uploadButton = previewContainer.nextElementSibling.nextElementSibling;
                uploadButton.outerHTML = `
                    <button onclick="document.getElementById('logoUploadInput').click()" class="btn btn-secondary btn-sm">
                        <i class="fas fa-upload mr-2"></i>Upload Logo
                    </button>
                    <button onclick="removeLogo()" class="btn btn-secondary btn-sm ml-2">
                        <i class="fas fa-trash mr-2"></i>Remove
                    </button>
                `;

                showAlert('Logo uploaded! Click "Save Settings" to apply.');
            };
            reader.readAsDataURL(file);
        }

        function removeLogo() {
            settings.logoDataUrl = '';

            // Update preview in settings modal
            const previewContainer = document.getElementById('logoPreviewContainer');
            previewContainer.innerHTML = `
                <div class="text-4xl mb-2" style="color: var(--text-tertiary);">
                    <i class="fas fa-image"></i>
                </div>
                <div class="text-sm" style="color: var(--text-tertiary);">No logo uploaded</div>
            `;

            // Remove the remove button
            const buttons = previewContainer.parentElement.querySelectorAll('button');
            buttons[buttons.length - 1].remove();

            showAlert('Logo removed! Click "Save Settings" to apply.');
        }

        function openLogoUpload() {
            document.getElementById('headerLogoUploadInput').click();
        }

        function handleHeaderLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showAlert('File size must be less than 2MB');
                return;
            }

            // Check file type
            if (!file.type.startsWith('image/')) {
                showAlert('Please upload an image file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                settings.logoDataUrl = e.target.result;
                updateHeaderLogo();
                showAlert('Logo updated! ');
            };
            reader.readAsDataURL(file);
        }

        function updateHeaderLogo() {
            const headerLogo = document.getElementById('headerLogo');

            if (settings.logoDataUrl) {
                // Show uploaded logo
                headerLogo.innerHTML = `
                    <img src="${settings.logoDataUrl}" alt="${settings.businessName}" class="h-11" style="object-fit: contain;" title="Click to change logo">
                `;
            } else {
                // Show default gradient logo with upload hint
                headerLogo.innerHTML = `
                    <div class="flex items-center gap-2" title="Click to upload logo">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold" style="background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); font-size: 1rem;">
                            <i class="fas fa-paw"></i>
                        </div>
                        <div>
                            <div class="font-bold" style="background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 1.25rem;">
                                ${settings.businessName}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Custom Dialog Functions
        function showAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="p-6">
                        <div class="text-center mb-4">
                            <div class="w-12 h-12 rounded-full mx-auto flex items-center justify-center" style="background: rgba(236, 72, 153, 0.1);">
                                <i class="fas fa-info-circle text-2xl" style="color: var(--accent-primary);"></i>
                            </div>
                        </div>
                        <p class="text-center mb-6">${message}</p>
                        <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-primary w-full">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showConfirm(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="p-6">
                        <div class="text-center mb-4">
                            <div class="w-12 h-12 rounded-full mx-auto flex items-center justify-center" style="background: rgba(239, 68, 68, 0.1);">
                                <i class="fas fa-exclamation-triangle text-2xl" style="color: var(--danger);"></i>
                            </div>
                        </div>
                        <p class="text-center mb-6">${message}</p>
                        <div class="flex gap-3">
                            <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary flex-1">Cancel</button>
                            <button onclick="handleConfirm()" class="btn btn-primary flex-1">Confirm</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            window.handleConfirm = () => {
                modal.remove();
                onConfirm();
            };
        }

        // Dark Mode
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
        }

        // Feature 1: Client Search Filter
        function filterClients() {
            clientSearchQuery = document.getElementById('clientSearch').value.toLowerCase();
            renderClients();
        }

        // Feature 2: Appointment Status Filter
        function showFilterMenu() {
            const content = `
                <div class="space-y-3">
                    <button onclick="setAppointmentFilter('all')" class="w-full text-left p-4 rounded-lg hover:bg-opacity-10 transition-all" style="background: ${appointmentFilter === 'all' ? 'var(--accent-primary)' : 'var(--bg-tertiary)'}; color: ${appointmentFilter === 'all' ? 'white' : 'var(--text-primary)'};">
                        <div class="font-semibold text-lg">All Appointments</div>
                        <div class="text-sm" style="opacity: 0.8;">Show all appointments</div>
                    </button>
                    <button onclick="setAppointmentFilter('confirmed')" class="w-full text-left p-4 rounded-lg hover:bg-opacity-10 transition-all" style="background: ${appointmentFilter === 'confirmed' ? 'var(--accent-primary)' : 'var(--bg-tertiary)'}; color: ${appointmentFilter === 'confirmed' ? 'white' : 'var(--text-primary)'};">
                        <div class="font-semibold text-lg">Confirmed Only</div>
                        <div class="text-sm" style="opacity: 0.8;">Confirmed appointments</div>
                    </button>
                    <button onclick="setAppointmentFilter('pending')" class="w-full text-left p-4 rounded-lg hover:bg-opacity-10 transition-all" style="background: ${appointmentFilter === 'pending' ? 'var(--accent-primary)' : 'var(--bg-tertiary)'}; color: ${appointmentFilter === 'pending' ? 'white' : 'var(--text-primary)'};">
                        <div class="font-semibold text-lg">Pending Only</div>
                        <div class="text-sm" style="opacity: 0.8;">Awaiting confirmation</div>
                    </button>
                    <button onclick="setAppointmentFilter('completed')" class="w-full text-left p-4 rounded-lg hover:bg-opacity-10 transition-all" style="background: ${appointmentFilter === 'completed' ? 'var(--accent-primary)' : 'var(--bg-tertiary)'}; color: ${appointmentFilter === 'completed' ? 'white' : 'var(--text-primary)'};">
                        <div class="font-semibold text-lg">Completed Only</div>
                        <div class="text-sm" style="opacity: 0.8;">Finished appointments</div>
                    </button>
                </div>
            `;
            showModal('Filter Appointments', content, '');
        }

        function setAppointmentFilter(filter) {
            appointmentFilter = filter;
            // Update filter label
            const filterLabel = document.getElementById('filterLabel');
            if (filterLabel) {
                const labels = { all: 'All', confirmed: 'Confirmed', pending: 'Pending', completed: 'Completed' };
                filterLabel.textContent = labels[filter];
            }
            // Close modal
            document.querySelector('.modal-overlay')?.remove();
            renderDayTimeline();
        }

        // Feature 5: Jump to Today
        function jumpToToday() {
            const today = new Date();
            selectedDate = new Date(today);
            currentDate = new Date(today);
            weekStartDate = getWeekStart(today);
            renderWeekTimeline();
            updateMonthYearDisplay();
        }

        // Feature 6: Before/After Photo Gallery
        function openPhotoGallery(petName, clientId) {
            const client = clients.find(c => c.id === clientId);
            const pet = client?.pets.find(p => p.name === petName);

            if (!pet) return;

            const photos = pet.photos || [];
            const photoHTML = photos.length > 0 ? photos.map((photo, idx) => `
                <div class="mb-4">
                    <div class="font-semibold mb-2">${photo.type === 'before' ? 'Before' : 'After'} - ${new Date(photo.date).toLocaleDateString()}</div>
                    <img src="${photo.url}" style="width: 100%; border-radius: 1rem;">
                </div>
            `).join('') : '<p class="text-center" style="color: var(--text-tertiary);">No photos yet</p>';

            const content = `
                <div style="max-height: 60vh; overflow-y: auto;">
                    ${photoHTML}
                </div>
            `;

            const buttons = `
                <button onclick="addPhotoToPet('${petName}', ${clientId})" class="btn btn-primary">
                    <i class="fas fa-camera mr-2"></i>Add Photo
                </button>
            `;

            showModal(`${petName}'s Photos`, content, buttons);
        }

        function addPhotoToPet(petName, clientId) {
            // Close current modal
            document.querySelector('.modal-overlay')?.remove();

            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="block mb-2 font-semibold">Photo Type</label>
                        <select id="photoType" class="w-full p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 1.125rem;">
                            <option value="before">Before Grooming</option>
                            <option value="after">After Grooming</option>
                        </select>
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">Upload Photo</label>
                        <input type="file" id="photoFile" accept="image/*" class="w-full p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); font-size: 1.125rem;">
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="savePhotoToPet('${petName}', ${clientId})" class="btn btn-primary">Save Photo</button>
            `;

            showModal('Add Photo', content, buttons);
        }

        function savePhotoToPet(petName, clientId) {
            const client = clients.find(c => c.id === clientId);
            const pet = client?.pets.find(p => p.name === petName);
            const photoType = document.getElementById('photoType').value;
            const photoFile = document.getElementById('photoFile').files[0];

            if (!pet || !photoFile) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                if (!pet.photos) pet.photos = [];
                pet.photos.push({
                    type: photoType,
                    url: e.target.result,
                    date: new Date().toISOString()
                });

                document.querySelector('.modal-overlay')?.remove();
                renderClients();
                showNotification('Photo added successfully!');
            };
            reader.readAsDataURL(photoFile);
        }

        // Feature 7: Revenue Dashboard
        function showRevenueDashboard() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const weekStart = getWeekStart(new Date());

            // Calculate today's revenue
            const todayRevenue = appointments
                .filter(apt => {
                    const aptDate = new Date(apt.date);
                    aptDate.setHours(0, 0, 0, 0);
                    return aptDate.getTime() === today.getTime() && apt.status === 'completed';
                })
                .reduce((sum, apt) => sum + calculateAppointmentTotal(apt), 0);

            // Calculate week's revenue
            const weekRevenue = appointments
                .filter(apt => apt.date >= weekStart && apt.status === 'completed')
                .reduce((sum, apt) => sum + calculateAppointmentTotal(apt), 0);

            // Most popular services
            const serviceCounts = {};
            appointments.forEach(apt => {
                apt.pets.forEach(pet => {
                    pet.items.forEach(item => {
                        const service = [...services, ...items].find(s => s.id === item.id && s.type === item.type);
                        if (service) {
                            serviceCounts[service.name] = (serviceCounts[service.name] || 0) + 1;
                        }
                    });
                });
            });

            const topServices = Object.entries(serviceCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const weekAppointments = appointments.filter(apt => apt.date >= weekStart).length;

            const content = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                            <div class="text-sm mb-1" style="color: var(--text-tertiary);">Today's Revenue</div>
                            <div class="text-2xl font-bold" style="color: var(--accent-primary);">$${todayRevenue.toFixed(2)}</div>
                        </div>
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                            <div class="text-sm mb-1" style="color: var(--text-tertiary);">Week's Revenue</div>
                            <div class="text-2xl font-bold" style="color: var(--accent-primary);">$${weekRevenue.toFixed(2)}</div>
                        </div>
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                            <div class="text-sm mb-1" style="color: var(--text-tertiary);">This Week</div>
                            <div class="text-2xl font-bold">${weekAppointments} Appointments</div>
                        </div>
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                            <div class="text-sm mb-1" style="color: var(--text-tertiary);">Total Clients</div>
                            <div class="text-2xl font-bold">${clients.length}</div>
                        </div>
                    </div>
                    <div>
                        <div class="font-bold mb-3">Top Services</div>
                        ${topServices.length > 0 ? topServices.map(([name, count]) => `
                            <div class="flex justify-between items-center mb-2 p-3 rounded-lg" style="background: var(--bg-tertiary);">
                                <span>${name}</span>
                                <span class="font-bold" style="color: var(--accent-primary);">${count} bookings</span>
                            </div>
                        `).join('') : '<p style="color: var(--text-tertiary);">No services booked yet</p>'}
                    </div>
                </div>
            `;

            showModal('Revenue Dashboard', content, '');
        }

        function calculateAppointmentTotal(apt) {
            let total = 0;
            apt.pets.forEach(pet => {
                pet.items.forEach(item => {
                    const service = [...services, ...items].find(s => s.id === item.id && s.type === item.type);
                    if (service) total += service.price;
                });
            });
            return total;
        }

        // Feature 8: Recurring Appointments
        function createRecurringAppointment(templateData) {
            // Template includes: clientId, pets, frequency ('weekly', 'biweekly', 'monthly'), occurrences, neverEnds
            const template = {
                id: Date.now(),
                ...templateData,
                createdDate: new Date()
            };
            recurringTemplates.push(template);

            // Generate initial appointments
            generateRecurringAppointments(template);
            const message = templateData.neverEnds ?
                `Created recurring appointment series (${templateData.occurrences} appointments - Never ends)` :
                `Created recurring appointment series (${templateData.occurrences} appointments)`;
            showNotification(message);
        }

        function generateRecurringAppointments(template) {
            const { clientId, pets, frequencyNumber, frequencyUnit, occurrences, startDate, startTime } = template;

            for (let i = 0; i < occurrences; i++) {
                const aptDate = new Date(startDate);

                // Calculate date based on frequency number and unit
                if (frequencyUnit === 'days') {
                    aptDate.setDate(aptDate.getDate() + (i * frequencyNumber));
                } else if (frequencyUnit === 'weeks') {
                    aptDate.setDate(aptDate.getDate() + (i * frequencyNumber * 7));
                } else if (frequencyUnit === 'months') {
                    aptDate.setMonth(aptDate.getMonth() + (i * frequencyNumber));
                } else if (frequencyUnit === 'years') {
                    aptDate.setFullYear(aptDate.getFullYear() + (i * frequencyNumber));
                }

                // Set time
                const [hours, minutes] = startTime.split(':');
                aptDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);

                // Create appointment
                appointments.push({
                    id: Date.now() + i,
                    clientId,
                    pets: pets.map(p => ({ ...p })), // Deep copy
                    date: aptDate,
                    status: 'confirmed',
                    notes: `Recurring appointment (${i + 1}/${occurrences})`,
                    recurringId: template.id,
                    isRecurring: true
                });
            }

            renderWeekTimeline();
        }

        function showRecurringOptions() {
            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="block mb-2 font-semibold" style="color: var(--text-primary);">Client</label>
                        <select id="recurringClient" onchange="updateRecurringPetOptions()" class="w-full p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 1.125rem;">
                            <option value="">Select client...</option>
                            ${clients.map(client => `<option value="${client.id}">${client.name}</option>`).join('')}
                        </select>
                    </div>
                    <div id="recurringPetContainer"></div>
                    <div>
                        <label class="block mb-2 font-semibold" style="color: var(--text-primary);">Start Date</label>
                        <input type="date" id="recurringStartDate" class="w-full p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 1.125rem;">
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold" style="color: var(--text-primary);">Start Time</label>
                        <input type="time" id="recurringStartTime" class="w-full p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 1.125rem;">
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold" style="color: var(--text-primary);">Frequency</label>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 1.125rem; color: var(--text-primary);">Every</span>
                            <input type="number" id="recurringFrequencyNumber" value="1" min="1" max="999" class="p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 1.125rem; width: 5rem;">
                            <select id="recurringFrequencyUnit" class="p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 1.125rem; flex: 1;">
                                <option value="days">Day(s)</option>
                                <option value="weeks" selected>Week(s)</option>
                                <option value="months">Month(s)</option>
                                <option value="years">Year(s)</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="flex items-center p-3 rounded-lg cursor-pointer" style="background: var(--bg-tertiary);">
                            <input type="checkbox" id="recurringNeverEnds" onchange="toggleRecurringOccurrences()" class="mr-3" style="width: 1.25rem; height: 1.25rem;">
                            <span class="font-semibold" style="color: var(--text-primary);">Never ends</span>
                        </label>
                    </div>
                    <div id="recurringOccurrencesContainer">
                        <label class="block mb-2 font-semibold" style="color: var(--text-primary);">Number of Appointments</label>
                        <input type="number" id="recurringOccurrences" value="4" min="2" max="52" class="w-full p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 1.125rem;">
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="saveRecurringAppointment()" class="btn btn-primary">Create Series</button>
            `;

            showModal('Create Recurring Appointments', content, buttons);
        }

        function updateRecurringPetOptions() {
            const clientId = parseInt(document.getElementById('recurringClient').value);
            const client = clients.find(c => c.id === clientId);
            const container = document.getElementById('recurringPetContainer');

            if (!client || !client.pets) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <div>
                    <label class="block mb-2 font-semibold">Select Pet(s)</label>
                    ${client.pets.map((pet, idx) => `
                        <div class="mb-2">
                            <label class="flex items-center p-3 rounded-lg cursor-pointer" style="background: var(--bg-tertiary);">
                                <input type="checkbox" id="recurringPet${idx}" value="${pet.name}" class="mr-3" style="width: 1.25rem; height: 1.25rem;">
                                <span>${pet.name} (${pet.breed})</span>
                            </label>
                        </div>
                    `).join('')}
                </div>
                <div id="recurringPetServices"></div>
            `;
        }

        function toggleRecurringOccurrences() {
            const neverEnds = document.getElementById('recurringNeverEnds').checked;
            const container = document.getElementById('recurringOccurrencesContainer');
            if (neverEnds) {
                container.style.display = 'none';
            } else {
                container.style.display = 'block';
            }
        }

        function saveRecurringAppointment() {
            const clientId = parseInt(document.getElementById('recurringClient').value);
            const startDate = document.getElementById('recurringStartDate').value;
            const startTime = document.getElementById('recurringStartTime').value;
            const frequencyNumber = parseInt(document.getElementById('recurringFrequencyNumber').value);
            const frequencyUnit = document.getElementById('recurringFrequencyUnit').value;
            const neverEnds = document.getElementById('recurringNeverEnds').checked;

            // Calculate smart default occurrences based on frequency (generate ~1 year worth)
            let defaultOccurrences = 52;
            if (neverEnds) {
                if (frequencyUnit === 'days') {
                    defaultOccurrences = Math.floor(365 / frequencyNumber);
                } else if (frequencyUnit === 'weeks') {
                    defaultOccurrences = Math.floor(52 / frequencyNumber);
                } else if (frequencyUnit === 'months') {
                    defaultOccurrences = Math.floor(12 / frequencyNumber);
                } else if (frequencyUnit === 'years') {
                    defaultOccurrences = Math.max(1, Math.floor(5 / frequencyNumber));
                }
            }
            const occurrences = neverEnds ? defaultOccurrences : parseInt(document.getElementById('recurringOccurrences').value);

            if (!clientId || !startDate || !startTime) {
                showNotification('Please fill in all required fields');
                return;
            }

            const client = clients.find(c => c.id === clientId);
            const selectedPets = [];

            client.pets.forEach((pet, idx) => {
                const checkbox = document.getElementById(`recurringPet${idx}`);
                if (checkbox && checkbox.checked) {
                    selectedPets.push({
                        name: pet.name,
                        items: [{ id: 1, type: 'service' }] // Default to first service
                    });
                }
            });

            if (selectedPets.length === 0) {
                showNotification('Please select at least one pet');
                return;
            }

            createRecurringAppointment({
                clientId,
                pets: selectedPets,
                startDate: new Date(startDate),
                startTime,
                frequencyNumber,
                frequencyUnit,
                occurrences,
                neverEnds
            });

            document.querySelector('.modal-overlay')?.remove();
        }

        // Feature 11: No-Show Tracking
        function markAsNoShow(appointmentId) {
            const apt = appointments.find(a => a.id === appointmentId);
            if (!apt) return;

            const client = clients.find(c => c.id === apt.clientId);
            if (client) {
                if (!client.noShowCount) client.noShowCount = 0;
                client.noShowCount++;
                client.lastNoShow = new Date();

                // Update appointment status
                apt.status = 'no-show';

                // Log the no-show
                logCommunication(client.id, 'system', `No-show recorded for appointment on ${apt.date.toLocaleDateString()}`);

                renderWeekTimeline();
                renderClients();
                showNotification(`Marked as no-show. ${client.name} now has ${client.noShowCount} no-show(s)`);
            }
        }

        function viewClientNoShows(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            const noShows = appointments.filter(apt => apt.clientId === clientId && apt.status === 'no-show');

            const content = `
                <div class="mb-4 p-4 rounded-lg" style="background: ${client.noShowCount > 2 ? 'rgba(239, 68, 68, 0.1)' : 'var(--bg-tertiary)'}; border-left: 4px solid ${client.noShowCount > 2 ? '#EF4444' : 'var(--accent-primary)'};">
                    <div class="font-bold text-lg mb-2">${client.name}</div>
                    <div class="text-sm mb-2">Total No-Shows: <span class="font-bold" style="color: ${client.noShowCount > 2 ? '#EF4444' : 'var(--accent-primary)'};">${client.noShowCount || 0}</span></div>
                    ${client.lastNoShow ? `<div class="text-sm">Last No-Show: ${new Date(client.lastNoShow).toLocaleDateString()}</div>` : ''}
                </div>
                <div class="space-y-2">
                    ${noShows.length > 0 ? noShows.map(apt => `
                        <div class="p-3 rounded-lg" style="background: var(--bg-tertiary);">
                            <div class="font-semibold">${apt.date.toLocaleDateString()}</div>
                            <div class="text-sm" style="color: var(--text-tertiary);">${formatTime(apt.date)} - ${apt.pets.map(p => p.name).join(', ')}</div>
                        </div>
                    `).join('') : '<p class="text-center" style="color: var(--text-tertiary);">No previous no-shows</p>'}
                </div>
            `;

            showModal('No-Show History', content, '');
        }

        function resetNoShowCount(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (client) {
                client.noShowCount = 0;
                client.lastNoShow = null;
                renderClients();
                showNotification('No-show count reset');
            }
        }

        // Feature 9: Route Optimization (shows appointments sorted by address)
        function showRouteOptimization() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayEnd = new Date(today);
            todayEnd.setHours(23, 59, 59, 999);

            const todayApts = appointments
                .filter(apt => apt.date >= today && apt.date <= todayEnd && apt.status === 'confirmed')
                .map(apt => {
                    const client = clients.find(c => c.id === apt.clientId);
                    return { ...apt, client };
                })
                .sort((a, b) => a.date - b.date);

            const content = `
                <div class="text-sm mb-4" style="color: var(--text-tertiary);">
                    Optimized route for today's appointments
                </div>
                <div class="space-y-3">
                    ${todayApts.length > 0 ? todayApts.map((apt, idx) => `
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary); border-left: 4px solid var(--accent-primary);">
                            <div class="flex justify-between items-start mb-2">
                                <div class="font-bold text-lg">${idx + 1}. ${apt.client?.name}</div>
                                <div class="text-sm" style="color: var(--text-tertiary);">${formatTime(apt.date)}</div>
                            </div>
                            <div class="text-sm mb-2"><i class="fas fa-map-marker-alt mr-2"></i>${apt.client?.address || 'No address'}</div>
                            <div class="text-sm"><i class="fas fa-paw mr-2"></i>${apt.pets.map(p => p.name).join(', ')}</div>
                        </div>
                    `).join('') : '<p class="text-center" style="color: var(--text-tertiary);">No confirmed appointments today</p>'}
                </div>
            `;

            showModal('Today\'s Route', content, '');
        }

        // Feature 10: Communication Log
        function logCommunication(clientId, type, message) {
            communicationLog.push({
                id: Date.now(),
                clientId,
                type, // 'sms', 'call', 'email'
                message,
                timestamp: new Date()
            });
        }

        function showCommunicationHistory(clientId) {
            const client = clients.find(c => c.id === clientId);
            const logs = communicationLog.filter(log => log.clientId === clientId).sort((a, b) => b.timestamp - a.timestamp);

            const content = `
                <div style="max-height: 60vh; overflow-y: auto;">
                    ${logs.length > 0 ? logs.map(log => `
                        <div class="mb-3 p-3 rounded-lg" style="background: var(--bg-tertiary);">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-semibold">
                                    <i class="fas fa-${log.type === 'sms' ? 'comment' : log.type === 'call' ? 'phone' : 'envelope'} mr-2"></i>
                                    ${log.type.toUpperCase()}
                                </span>
                                <span class="text-sm" style="color: var(--text-tertiary);">${log.timestamp.toLocaleString()}</span>
                            </div>
                            <div class="text-sm">${log.message}</div>
                        </div>
                    `).join('') : '<p class="text-center" style="color: var(--text-tertiary);">No communication history</p>'}
                </div>
            `;

            showModal(`Communication History - ${client?.name}`, content, '');
        }

        // Feature 12: Service Packages
        function showPackagesMenu() {
            const content = `
                <div class="space-y-3">
                    <button onclick="this.closest('.modal-overlay').remove(); openCreatePackageModal();" class="w-full text-left p-4 rounded-lg hover:bg-opacity-10 transition-all" style="background: var(--bg-tertiary);">
                        <div class="font-semibold text-lg">Create New Package</div>
                        <div class="text-sm" style="color: var(--text-tertiary);">Bundle services together</div>
                    </button>
                    <button onclick="this.closest('.modal-overlay').remove(); viewPackages();" class="w-full text-left p-4 rounded-lg hover:bg-opacity-10 transition-all" style="background: var(--bg-tertiary);">
                        <div class="font-semibold text-lg">View Packages</div>
                        <div class="text-sm" style="color: var(--text-tertiary);">Manage existing packages</div>
                    </button>
                </div>
            `;
            showModal('Service Packages', content, '');
        }

        function openCreatePackageModal() {
            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="block mb-2 font-semibold">Package Name</label>
                        <input type="text" id="packageName" placeholder="e.g., Puppy Package" class="w-full p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); font-size: 1.125rem;">
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">Description</label>
                        <textarea id="packageDesc" placeholder="Package details..." class="w-full p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); font-size: 1.125rem;" rows="3"></textarea>
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">Number of Sessions</label>
                        <input type="number" id="packageSessions" value="3" class="w-full p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); font-size: 1.125rem;">
                    </div>
                    <div>
                        <label class="block mb-2 font-semibold">Total Price ($)</label>
                        <input type="number" id="packagePrice" step="0.01" placeholder="0.00" class="w-full p-3 rounded-lg border" style="border-color: var(--border); background: var(--bg-secondary); font-size: 1.125rem;">
                    </div>
                </div>
            `;

            const buttons = `
                <button onclick="savePackage()" class="btn btn-primary">Create Package</button>
            `;

            showModal('Create Service Package', content, buttons);
        }

        function savePackage() {
            const name = document.getElementById('packageName').value.trim();
            const description = document.getElementById('packageDesc').value.trim();
            const sessions = parseInt(document.getElementById('packageSessions').value);
            const price = parseFloat(document.getElementById('packagePrice').value);

            if (!name || !price || !sessions) {
                showNotification('Please fill in all required fields');
                return;
            }

            packages.push({
                id: Date.now(),
                name,
                description,
                sessions,
                price,
                pricePerSession: (price / sessions).toFixed(2)
            });

            document.querySelector('.modal-overlay')?.remove();
            showNotification('Package created successfully!');
        }

        function viewPackages() {
            const content = `
                <div class="space-y-3">
                    ${packages.length > 0 ? packages.map(pkg => `
                        <div class="p-4 rounded-lg" style="background: var(--bg-tertiary);">
                            <div class="font-bold text-lg mb-2">${pkg.name}</div>
                            <div class="text-sm mb-2" style="color: var(--text-tertiary);">${pkg.description}</div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm">${pkg.sessions} sessions</span>
                                <span class="font-bold" style="color: var(--accent-primary);">$${pkg.price} ($${pkg.pricePerSession}/session)</span>
                            </div>
                        </div>
                    `).join('') : '<p class="text-center" style="color: var(--text-tertiary);">No packages created yet</p>'}
                </div>
            `;

            const buttons = packages.length > 0 ? '' : `
                <button onclick="this.closest('.modal-overlay').remove(); openCreatePackageModal();" class="btn btn-primary">Create First Package</button>
            `;

            showModal('Service Packages', content, buttons);
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = 'position: fixed; top: 6rem; left: 50%; transform: translateX(-50%); background: var(--accent-primary); color: white; padding: 1rem 2rem; border-radius: 0.75rem; z-index: 10001; font-size: 1.125rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2);';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Initialize dark mode based on user preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Initialize app with error handling
        try {
            initializeData();
            setupTimelinePinchZoom();
            console.log('App initialized successfully');
        } catch (error) {
            console.error('Initialization error:', error);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            document.body.innerHTML = '<div style="padding: 20px; color: red;">Error: ' + error.message + '</div>';
        }

        // Pinch-to-zoom for timeline
        function setupTimelinePinchZoom() {
            const timeline = document.getElementById('dayTimeline');
            if (!timeline) return;

            let initialDistance = 0;
            let initialZoom = 1;

            timeline.addEventListener('touchstart', function(e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    initialDistance = getDistance(e.touches[0], e.touches[1]);
                    initialZoom = timelineZoom;
                }
            }, { passive: false });

            timeline.addEventListener('touchmove', function(e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const currentDistance = getDistance(e.touches[0], e.touches[1]);
                    const scale = currentDistance / initialDistance;

                    let newZoom = initialZoom * scale;
                    newZoom = Math.max(ZOOM_MIN, Math.min(ZOOM_MAX, newZoom));

                    if (Math.abs(newZoom - timelineZoom) > 0.02) {
                        timelineZoom = newZoom;
                        updateTimelineZoom();
                    }
                }
            }, { passive: false });

            function getDistance(touch1, touch2) {
                const dx = touch1.clientX - touch2.clientX;
                const dy = touch1.clientY - touch2.clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }
        }

        function updateTimelineZoom() {
            const container = document.getElementById('dayTimeline');
            if (!container) return;

            const hourHeight = BASE_HOUR_HEIGHT * timelineZoom;
            container.style.setProperty('--hour-height', `${hourHeight}px`);

            // Update container height
            const totalHeight = 24 * hourHeight;
            container.style.minHeight = `${totalHeight}px`;

            // Update appointment positions - now appointments are inside hour rows
            const aptElements = container.querySelectorAll('.timeline-appointment');
            aptElements.forEach(apt => {
                const aptId = parseInt(apt.dataset.aptId);
                const aptData = window.appointments?.find(a => a.id === aptId);
                if (aptData) {
                    const minute = aptData.date.getMinutes();
                    const minuteOffset = (minute * hourHeight / 60);
                    apt.style.top = `${minuteOffset}px`;

                    // Recalculate height
                    const totalMinutes = aptData.pets.reduce((sum, pet) => {
                        return sum + pet.items.reduce((itemSum, item) => {
                            const serviceOrItem = [...services, ...items].find(s => s.id === item.id && s.type === item.type);
                            return itemSum + (serviceOrItem?.duration || 0);
                        }, 0);
                    }, 0);
                    const calculatedHeight = (totalMinutes * hourHeight / 60);
                    const minHeight = 60 * timelineZoom;
                    apt.style.height = `${Math.max(calculatedHeight, minHeight)}px`;
                }
            });

            // Update current time indicator position
            addCurrentTimeIndicator();
        }

        // Pull-to-refresh functionality
        function setupPullToRefresh() {
            const container = document.getElementById('timelineScrollContainer');
            if (!container) return;

            let startY = 0;
            let pulling = false;
            const threshold = 80;

            container.addEventListener('touchstart', function(e) {
                if (container.scrollTop === 0 && e.touches.length === 1) {
                    startY = e.touches[0].clientY;
                    pulling = true;
                }
            }, { passive: true });

            container.addEventListener('touchmove', function(e) {
                if (!pulling) return;

                const currentY = e.touches[0].clientY;
                const pullDistance = currentY - startY;

                if (pullDistance > 0 && container.scrollTop === 0) {
                    const indicator = document.getElementById('pullToRefreshIndicator');
                    const icon = document.getElementById('refreshIcon');
                    const text = document.getElementById('refreshText');

                    const translateY = Math.min(pullDistance * 0.5, threshold);
                    indicator.style.transform = `translateY(${translateY}px)`;

                    if (pullDistance > threshold) {
                        icon.style.transform = 'rotate(180deg)';
                        text.textContent = 'Release to refresh';
                    } else {
                        icon.style.transform = 'rotate(0deg)';
                        text.textContent = 'Pull to refresh';
                    }
                }
            }, { passive: true });

            container.addEventListener('touchend', function(e) {
                if (!pulling) return;
                pulling = false;

                const indicator = document.getElementById('pullToRefreshIndicator');
                const currentTransform = indicator.style.transform;
                const match = currentTransform.match(/translateY\((\d+)px\)/);
                const translateY = match ? parseInt(match[1]) : 0;

                if (translateY >= threshold * 0.5) {
                    // Trigger refresh
                    const icon = document.getElementById('refreshIcon');
                    const text = document.getElementById('refreshText');
                    icon.classList.add('fa-spin');
                    text.textContent = 'Refreshing...';

                    setTimeout(() => {
                        renderDayTimeline();
                        renderWeekTimeline();
                        renderCalendar();
                        icon.classList.remove('fa-spin');
                        text.textContent = 'Pull to refresh';
                        indicator.style.transform = 'translateY(0)';
                        showToast('Calendar refreshed', 'success');
                    }, 500);
                } else {
                    indicator.style.transform = 'translateY(0)';
                }
            }, { passive: true });
        }

        // Undo functionality
        let undoStack = [];
        const MAX_UNDO_STACK = 10;

        function pushToUndoStack(action, data) {
            undoStack.push({ action, data, timestamp: Date.now() });
            if (undoStack.length > MAX_UNDO_STACK) {
                undoStack.shift();
            }
            showUndoToast(action);
        }

        function showUndoToast(action) {
            const existingToast = document.querySelector('.undo-toast');
            if (existingToast) existingToast.remove();

            const actionText = action === 'delete_appointment' ? 'Appointment deleted' :
                              action === 'delete_client' ? 'Client deleted' :
                              action === 'cancel_appointment' ? 'Appointment cancelled' : 'Action completed';

            const toast = document.createElement('div');
            toast.className = 'undo-toast';
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--bg-secondary);
                color: var(--text-primary);
                padding: 0.75rem 1rem;
                border-radius: 0.75rem;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                gap: 1rem;
                z-index: 9999;
                font-size: 0.875rem;
                border: 1px solid var(--border);
            `;
            toast.innerHTML = `
                <span>${actionText}</span>
                <button onclick="performUndo()" style="background: var(--accent); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer;">
                    Undo
                </button>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.opacity = '0';
                    toast.style.transition = 'opacity 0.3s';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }

        function performUndo() {
            if (undoStack.length === 0) return;

            const lastAction = undoStack.pop();
            const existingToast = document.querySelector('.undo-toast');
            if (existingToast) existingToast.remove();

            if (lastAction.action === 'delete_appointment') {
                appointments.push(lastAction.data);
                renderDayTimeline();
                renderWeekTimeline();
                renderCalendar();
                showToast('Appointment restored', 'success');
            } else if (lastAction.action === 'delete_client') {
                clients.push(lastAction.data);
                renderClients();
                showToast('Client restored', 'success');
            } else if (lastAction.action === 'cancel_appointment') {
                var apt = appointments.find(function(a) { return a.id === lastAction.data.id; });
                if (apt) {
                    apt.status = lastAction.data.previousStatus;
                    renderDayTimeline();
                    renderWeekTimeline();
                    showToast('Appointment restored', 'success');
                }
            }
        }

        // Revenue Dashboard
        function openRevenueDashboard() {
            const today = new Date();
            const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const startOfWeek = new Date(startOfDay);
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1); // Monday
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

            // Calculate revenues
            let dailyRevenue = 0, weeklyRevenue = 0, monthlyRevenue = 0;
            let dailyCount = 0, weeklyCount = 0, monthlyCount = 0;

            appointments.forEach(apt => {
                if (apt.status === 'completed' && apt.checkout && apt.checkout.total) {
                    const aptDate = new Date(apt.date);

                    if (aptDate >= startOfMonth) {
                        monthlyRevenue += apt.checkout.total;
                        monthlyCount++;
                    }
                    if (aptDate >= startOfWeek) {
                        weeklyRevenue += apt.checkout.total;
                        weeklyCount++;
                    }
                    if (aptDate >= startOfDay) {
                        dailyRevenue += apt.checkout.total;
                        dailyCount++;
                    }
                }
            });

            const currency = settings.currency || '$';

            const content = `
                <div style="display: grid; gap: 1rem;">
                    <!-- Today -->
                    <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.05)); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 1rem; padding: 1.25rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em;">Today</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: #22C55E;">${currency}${dailyRevenue.toFixed(2)}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 2rem;"></div>
                                <div style="font-size: 0.75rem; color: var(--text-tertiary);">${dailyCount} appointment${dailyCount !== 1 ? 's' : ''}</div>
                            </div>
                        </div>
                    </div>

                    <!-- This Week -->
                    <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05)); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 1rem; padding: 1.25rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em;">This Week</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: #3B82F6;">${currency}${weeklyRevenue.toFixed(2)}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 2rem;"></div>
                                <div style="font-size: 0.75rem; color: var(--text-tertiary);">${weeklyCount} appointment${weeklyCount !== 1 ? 's' : ''}</div>
                            </div>
                        </div>
                    </div>

                    <!-- This Month -->
                    <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(168, 85, 247, 0.05)); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 1rem; padding: 1.25rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em;">This Month</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: #A855F7;">${currency}${monthlyRevenue.toFixed(2)}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 2rem;"></div>
                                <div style="font-size: 0.75rem; color: var(--text-tertiary);">${monthlyCount} appointment${monthlyCount !== 1 ? 's' : ''}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Averages -->
                    <div style="background: var(--bg-tertiary); border-radius: 1rem; padding: 1rem;">
                        <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">Averages</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Per Appointment</div>
                                <div style="font-weight: 600; color: var(--text-primary);">${currency}${monthlyCount > 0 ? (monthlyRevenue / monthlyCount).toFixed(2) : '0.00'}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Per Day (avg)</div>
                                <div style="font-weight: 600; color: var(--text-primary);">${currency}${(monthlyRevenue / Math.max(today.getDate(), 1)).toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            showModal('Revenue Dashboard', content, `
                <button onclick="closeAllModals()" class="btn-primary" style="width: 100%;">Close</button>
            `);
        }
    </script>
</body>
</html>
